<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mockomps - Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        body { font-family: 'Inter', sans-serif; overflow-x: hidden; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .h-scroll { overscroll-behavior-x: contain; }
        button:disabled { cursor: not-allowed; }

        /* Custom styles for the pin pad */
        .pin-pad-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.5rem;
            margin-top: 1rem;
        }
        .pin-pad-button {
            background-color: #1f2937; /* gray-800 */
            color: #d1d5db; /* gray-300 */
            padding: 1.5rem;
            border-radius: 0.75rem; /* rounded-xl */
            font-size: 2.25rem; /* text-4xl */
            font-weight: 600; /* font-semibold */
            text-align: center;
            transition: background-color 0.2s ease-in-out;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1), 0 1px 3px rgba(0, 0, 0, 0.08); /* shadow-lg */
        }
        .pin-pad-button:hover { background-color: #374151; }
        .pin-pad-button:active { background-color: #4b5563; box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1); }
        .pin-pad-button .fa-backspace { font-size: 1.5rem; }
        .pin-pad-grid .empty-cell { visibility: hidden; }

        /* Styles for canvas and image tagging */
        .image-tagging-container {
            position: relative;
            width: 100%;
            max-width: 600px;
            margin: 0 auto;
            border: 1px solid #374151; /* gray-700 */
            background-color: #1f2937; /* gray-800 */
            border-radius: 0.5rem;
            overflow: hidden;
        }
        .image-tagging-container img,
        .image-tagging-container canvas {
            display: block;
            width: 100%;
            height: auto;
        }
        .image-tagging-container canvas {
            position: absolute;
            top: 0;
            left: 0;
        }
    </style>
</head>
<body class="bg-gray-950 text-slate-300">

    <div id="app" class="container mx-auto p-4 max-w-7xl">
        <!-- Header is hidden by default, shown after data loads -->
        <div id="sticky-container" class="sticky top-0 z-10 bg-gray-950 pt-4 pb-4 hidden">
             <!-- Header -->
            <header id="header-container" class="bg-gray-900 border border-gray-800 rounded-lg shadow-md p-4">
                <div id="header-content" class="flex items-center justify-between">
                    <!-- Header content will be dynamically generated -->
                </div>
            </header>
        </div>

        <!-- Main Content Area, hidden until data loads -->
        <main id="main-content" class="hidden">
            <!-- Content will be rendered here by JavaScript -->
        </main>

        <!-- Loading / Error Indicator -->
        <div id="indicator" class="flex flex-col items-center justify-center min-h-screen -mt-20">
            <!-- Content will be set by JavaScript -->
        </div>
    </div>

    <!-- Admin PIN Modal -->
    <div id="pin-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 hidden">
        <div class="bg-gray-900 border border-gray-800 rounded-lg p-8 w-full max-w-sm mx-4">
            <h2 class="text-xl font-bold text-center text-white mb-4">Admin Access</h2>
            <p class="text-center text-gray-400 mb-6">Enter PIN to continue</p>
            <input type="password" id="pin-input" inputmode="none" readonly class="w-full bg-gray-800 border border-gray-700 text-gray-200 rounded-lg p-3 text-center text-2xl tracking-widest focus:outline-none focus:border-blue-500">
            <p id="pin-error" class="text-red-400 text-sm text-center mt-2 h-5"></p>
            
            <div id="pin-pad" class="pin-pad-grid">
                <button class="pin-pad-button" data-digit="1">1</button>
                <button class="pin-pad-button" data-digit="2">2</button>
                <button class="pin-pad-button" data-digit="3">3</button>
                <button class="pin-pad-button" data-digit="4">4</button>
                <button class="pin-pad-button" data-digit="5">5</button>
                <button class="pin-pad-button" data-digit="6">6</button>
                <button class="pin-pad-button" data-digit="7">7</button>
                <button class="pin-pad-button" data-digit="8">8</button>
                <button class="pin-pad-button" data-digit="9">9</button>
                <div class="empty-cell"></div>
                <button class="pin-pad-button" data-digit="0">0</button>
                <button class="pin-pad-button" data-action="backspace"><i class="fas fa-backspace"></i></button>
            </div>

            <div class="mt-4 flex space-x-4">
                <button id="pin-cancel" class="w-full bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg transition duration-300">Cancel</button>
                <button id="pin-submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300">Enter</button>
            </div>
        </div>
    </div>

    <!-- Generic Confirmation Modal -->
    <div id="confirmation-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 hidden">
        <div class="bg-gray-900 border border-gray-800 rounded-lg p-8 w-full max-w-sm mx-4">
            <h2 id="confirmation-title" class="text-xl font-bold text-center text-white mb-4">Confirm Action</h2>
            <p id="confirmation-message" class="text-center text-gray-400 mb-6">Are you sure?</p>
            <div class="mt-4 flex space-x-4">
                <button id="confirmation-cancel" class="w-full bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg transition duration-300">Cancel</button>
                <button id="confirmation-confirm" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300">Confirm</button>
            </div>
        </div>
    </div>
    
    <footer class="text-center py-8 text-xs text-gray-600">
        <p>Mockomps Admin</p>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM Elements ---
            const mainContent = document.getElementById('main-content');
            const indicator = document.getElementById('indicator');
            const headerContent = document.getElementById('header-content');
            const headerContainer = document.getElementById('header-container');
            const stickyContainer = document.getElementById('sticky-container');

            // --- App State ---
            let appData = {};
            const ADMIN_PIN = '0306'; 
            
            // Global temporary storage for the new workflow
            let tempQualiBoulderData = null; // Stores boulder definitions from addBoulders form
            let allImagesWithTagsData = [];  // Stores image info + tags for the tagging workflow
            let activeImageIndex = 0;        // Current image being tagged

            // --- Centralized Google Apps Script URL ---
            const GOOGLE_APP_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzZ5SsJuEAbosB2omSgUJP4HVD4UXbuQdidkIx6YqGfx02wDGFC8GbnAfcYtFNOQP7Z/exec';

            // --- Data Sources (Simplified for Admin) ---
            const GOOGLE_SHEET_URLS = {
                climbers: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQ7-85zdma8XbhoanF6eOYTwlcld3Qg7mJ2xmf2YMY8N2u_Pk2G-6fnDBEPPfIWr0QBKl4bpMX0QX9B/pub?gid=937478252&single=true&output=csv',
                comps: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQ7-85zdma8XbhoanF6eOYTwlcld3Qg7mJ2xmf2YMY8N2u_Pk2G-6fnDBEPPfIWr0QBKl4bpMX0QX9B/pub?gid=91525471&single=true&output=csv',
                qualis: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQ7-85zdma8XbhoanF6eOYTwlcld3Qg7mJ2xmf2YMY8N2u_Pk2G-6fnDBEPPfIWr0QBKl4bpMX0QX9B/pub?gid=1964387699&single=true&output=csv',
                finals: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQ7-85zdma8XbhoanF6eOYTwlcld3Qg7mJ2xmf2YMY8N2u_Pk2G-6fnDBEPPfIWr0QBKl4bpMX0QX9B/pub?gid=2138071685&single=true&output=csv',
                qStandings: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQ7-85zdma8XbhoanF6eOYTwlcld3Qg7mJ2xmf2YMY8N2u_Pk2G-6fnDBEPPfIWr0QBKl4bpMX0QX9B/pub?gid=687301211&single=true&output=csv',
                qBoulders: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQ7-85zdma8XbhoanF6eOYTwlcld3Qg7mJ2xmf2YMY8N2u_Pk2G-6fnDBEPPfIWr0QBKl4bpMX0QX9B/pub?gid=1513683934&single=true&output=csv',
                fClimbers: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQ7-85zdma8XbhoanF6eOYTwlcld3Qg7mJ2xmf2YMY8N2u_Pk2G-6fnDBEPPfIWr0QBKl4bpMX0QX9B/pub?gid=704595417&single=true&output=csv'
            };

            // --- Utility Functions ---
            function getLondonTime() { return new Date(new Date().toLocaleString('en-US', { timeZone: 'Europe/London' })); }

            async function fetchAndParseSheet(url) {
                const cacheBustUrl = `${url}&_=${new Date().getTime()}`;
                const response = await fetch(cacheBustUrl);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const text = await response.text();
                if (text.trim().startsWith('<')) throw new Error(`Received an HTML page instead of CSV from ${url}`);
                const lines = text.trim().split(/\r?\n/);
                if (lines.length < 2) return [];
                const header = lines[0].split(',').map(h => h.trim().toLowerCase().replace(/[\s-]+/g, '_').replace(/# /g, 'number_of_'));
                return lines.slice(1).map(line => {
                    if (line.trim() === '') return null;
                    const values = line.split(',');
                    return header.reduce((obj, nextKey, index) => {
                        obj[nextKey] = values[index] ? values[index].trim() : '';
                        return obj;
                    }, {});
                }).filter(Boolean);
            }

            function renderPageContent(page, context = null) {
                window.scrollTo(0, 0);
                mainContent.innerHTML = ''; 
                headerContent.innerHTML = '';
                headerContainer.classList.add('p-4', 'bg-gray-900', 'border-gray-800', 'rounded-lg', 'shadow-md');

                switch (page) {
                    case 'admin':
                        renderAdminPage();
                        break;
                    case 'judgesApp':
                        renderJudgesAppPage();
                        break;
                    case 'judgeBoulderPage':
                        renderJudgeBoulderPage(context);
                        break;
                    case 'manageFinals':
                        renderManageFinalsPage();
                        break;
                    case 'addBoulders':
                        renderAddBouldersPage();
                        break;
                    case 'uploadPhotos':
                        renderUploadPhotosPage();
                        break;
                    case 'tagPhotos':
                        renderTagPhotosPage(context);
                        break;
                    default:
                        renderAdminPage();
                        break;
                }
            }

            function navigate(page, context = null) {
                const currentState = history.state || { page: 'admin', context: null, scrollY: 0 };
                history.replaceState({ ...currentState, scrollY: window.scrollY }, '', window.location.hash);
                const newState = { page: page, context: context, scrollY: 0 };
                history.pushState(newState, '', `#${page}`);
                renderPageContent(page, context);
            }

            window.addEventListener('popstate', (event) => {
                if (event.state) {
                    const { page, context, scrollY } = event.state;
                    renderPageContent(page, context);
                    window.scrollTo(0, scrollY || 0); 
                } else {
                    renderPageContent('admin', null);
                    window.scrollTo(0, 0);
                }
            });

            function renderAdminPage() {
                headerContent.innerHTML = `
                    <div class="flex-1">
                        <a href="index.html" class="flex items-center space-x-2 text-gray-400 hover:text-white font-medium"><i class="fas fa-arrow-left"></i><span class="hidden sm:inline">Main Site</span></a>
                    </div>
                    <h1 class="text-2xl font-bold text-gray-100 flex-1 text-center">Admin Panel</h1>
                    <div class="flex-1 text-right"></div>`;

                mainContent.innerHTML = `
                    <div class="grid grid-cols-1 gap-4 text-center mt-8">
                        <button id="add-quali-boulders-btn" class="bg-gray-900 border border-gray-800 p-8 rounded-lg shadow-md hover:shadow-xl hover:bg-gray-800 transition-all duration-200 text-gray-100 font-bold text-xl">Manage Qualis Boulders</button>
                        <button id="manage-finals-btn" class="bg-gray-900 border border-gray-800 p-8 rounded-lg shadow-md hover:shadow-xl hover:bg-gray-800 transition-all duration-200 text-gray-100 font-bold text-xl">Manage Finals Rosters</button>
                        <button id="judge-finals-btn" class="bg-gray-900 border border-gray-800 p-8 rounded-lg shadow-md hover:shadow-xl hover:bg-gray-800 transition-all duration-200 text-gray-100 font-bold text-xl">Judges App</button>
                    </div>
                `;

                document.getElementById('add-quali-boulders-btn').addEventListener('click', () => navigate('addBoulders'));
                document.getElementById('manage-finals-btn').addEventListener('click', () => navigate('manageFinals'));
                document.getElementById('judge-finals-btn').addEventListener('click', () => navigate('judgesApp'));
            }

            function renderAddBouldersPage() {
                headerContent.innerHTML = `
                    <div class="flex-1">
                        <button id="back-to-admin-btn" class="flex items-center space-x-2 text-gray-400 hover:text-white font-medium"><i class="fas fa-arrow-left"></i><span class="hidden sm:inline">Back</span></button>
                    </div>
                    <h1 class="text-2xl font-bold text-gray-100 flex-1 text-center">Manage Qualis Boulders</h1>
                    <div class="flex-1 text-right">
                        <a href="index.html" class="text-gray-400 hover:text-white"><i class="fas fa-home text-xl"></i></a>
                    </div>`;
                document.getElementById('back-to-admin-btn').addEventListener('click', () => history.back());
                
                const now = getLondonTime();
                const liveAndFutureQualis = appData.qualis
                    .filter(q => new Date(new Date(q.date).getTime() + (7 * 24 * 60 * 60 * 1000) + (12 * 60 * 60 * 1000)) >= now)
                    .sort((a, b) => new Date(b.date) - new Date(a.date));
                const qualiOptions = liveAndFutureQualis.map(q => `<option value="${q.quali}">${q.quali}</option>`).join('');
                const gradeOptions = [1,2,3,4,5,6,7].map(g => `<option value="${g}">${g}</option>`).join('');
                const colorOptions = ["Black", "Blue", "Green", "Mint", "Purple", "Red", "White", "Yellow"].map(c => `<option value="${c}">${c}</option>`).join('');

                mainContent.innerHTML = `
                    <div class="max-w-xl mx-auto">
                        <form id="boulder-form" class="space-y-6">
                            <div>
                                <label for="quali-select" class="block text-sm font-medium text-gray-300 mb-1">Select Quali Round</label>
                                <select id="quali-select" class="w-full bg-gray-800 border border-gray-700 text-gray-200 rounded-lg p-3 focus:outline-none focus:border-blue-500">
                                    <option value="">-- Select a Quali --</option>
                                    ${qualiOptions}
                                </select>
                            </div>
                            <div id="boulder-list" class="space-y-3"></div>
                            <div class="flex justify-between items-center">
                                <button type="button" id="add-boulder-btn" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg transition duration-300">Add Boulder</button>
                                <button type="button" id="next-to-photos-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg transition duration-300">Next (Add Photos)</button>
                            </div>
                        </form>
                        <div id="boulder-form-feedback" class="mt-4 text-center"></div>
                    </div>
                `;

                const boulderList = document.getElementById('boulder-list');
                const qualiSelect = document.getElementById('quali-select');
                const nextToPhotosBtn = document.getElementById('next-to-photos-btn');
                const boulderFormFeedback = document.getElementById('boulder-form-feedback');

                function addBoulderRow(boulder = {}) {
                    const letter = String.fromCharCode(65 + boulderList.children.length);
                    const row = document.createElement('div');
                    row.className = "boulder-row grid grid-cols-12 gap-2 items-center";
                    row.innerHTML = `
                        <div class="col-span-1 text-center font-bold text-xl text-gray-400">${letter}</div>
                        <div class="col-span-3"><select name="grade" class="w-full bg-gray-800 border border-gray-700 p-2 rounded-md">${gradeOptions}</select></div>
                        <div class="col-span-4"><select name="color" class="w-full bg-gray-800 border border-gray-700 p-2 rounded-md">${colorOptions}</select></div>
                        <div class="col-span-3"><select name="room" class="w-full bg-gray-800 border border-gray-700 p-2 rounded-md"><option>A1</option><option>A2</option></select></div>
                        <div class="col-span-1 text-right"><button type="button" class="remove-boulder-btn text-red-500 hover:text-red-400 text-2xl font-bold">&times;</button></div>
                    `;
                    boulderList.appendChild(row);
                    if(boulder.grade) row.querySelector('select[name="grade"]').value = boulder.grade;
                    if(boulder.color) row.querySelector('select[name="color"]').value = boulder.color;
                    if(boulder.a) row.querySelector('select[name="room"]').value = boulder.a;
                    row.querySelector('.remove-boulder-btn').addEventListener('click', () => {
                        row.remove();
                        updateBoulderLetters();
                    });
                }
                
                function updateBoulderLetters() {
                    const rows = boulderList.querySelectorAll('.boulder-row');
                    rows.forEach((row, index) => {
                        row.querySelector('div:first-child').textContent = String.fromCharCode(65 + index);
                    });
                }

                function populateBouldersForQuali(qualiName) {
                    boulderList.innerHTML = '';
                    const existingBoulders = appData.qBoulders.filter(b => b.quali === qualiName);
                    if (existingBoulders.length > 0) {
                        existingBoulders.forEach(boulder => addBoulderRow(boulder));
                    } else {
                        for(let i=0; i<5; i++) addBoulderRow();
                    }
                }
                
                qualiSelect.addEventListener('change', (e) => {
                    const selectedQuali = e.target.value;
                    if(selectedQuali) populateBouldersForQuali(selectedQuali);
                    else boulderList.innerHTML = '';
                });

                document.getElementById('add-boulder-btn').addEventListener('click', () => addBoulderRow());
                
                nextToPhotosBtn.addEventListener('click', () => {
                    boulderFormFeedback.innerHTML = '';
                    const qualiName = qualiSelect.value;
                    if (!qualiName) {
                        boulderFormFeedback.innerHTML = `<p class="text-red-400">Please select a Quali round first.</p>`;
                        return;
                    }

                    const boulders = [];
                    const rows = boulderList.querySelectorAll('.boulder-row');
                    if (rows.length === 0) {
                        boulderFormFeedback.innerHTML = `<p class="text-red-400">Please add at least one boulder.</p>`;
                        return;
                    }
                    
                    let allBouldersValid = true;
                    rows.forEach((row, index) => {
                        const grade = row.querySelector('select[name="grade"]').value;
                        const color = row.querySelector('select[name="color"]').value;
                        const room = row.querySelector('select[name="room"]').value;

                        if (!grade || !color || !room) {
                            allBouldersValid = false;
                            boulderFormFeedback.innerHTML = `<p class="text-red-400">Please fill all fields for Boulder ${String.fromCharCode(65 + index)}.</p>`;
                            return;
                        }
                        boulders.push({ Name: String.fromCharCode(65 + index), Grade: grade, Color: color, A: room });
                    });

                    if (!allBouldersValid) return;

                    tempQualiBoulderData = { quali: qualiName, boulders: boulders };
                    navigate('uploadPhotos');
                });
            }

            function renderUploadPhotosPage() {
                headerContent.innerHTML = `
                    <div class="flex-1">
                        <button id="back-btn" class="flex items-center space-x-2 text-gray-400 hover:text-white font-medium"><i class="fas fa-arrow-left"></i><span class="hidden sm:inline">Back</span></button>
                    </div>
                    <h1 class="text-2xl font-bold text-gray-100 flex-1 text-center">Upload Boulder Photos</h1>
                    <div class="flex-1 text-right">
                        <a href="index.html" class="text-gray-400 hover:text-white"><i class="fas fa-home text-xl"></i></a>
                    </div>`;
                document.getElementById('back-btn').addEventListener('click', () => history.back());

                mainContent.innerHTML = `
                    <div class="max-w-xl mx-auto space-y-6">
                        <p class="text-gray-400">Please upload 1 or 2 photos of the boulders for the selected Quali round. You will tag these photos in the next step.</p>
                        <input type="file" id="image-upload-input" accept="image/jpeg, image/png" multiple class="w-full text-gray-300 bg-gray-800 border border-gray-700 rounded-lg p-3 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-blue-600 file:text-white hover:file:bg-blue-700">
                        <div id="image-previews" class="grid grid-cols-2 gap-4 mt-4"></div>
                        <p id="upload-feedback" class="text-center h-6 text-red-400"></p>
                        <button id="next-to-tagging-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition duration-300" disabled>Next (Tag Photos)</button>
                    </div>
                `;

                const imageUploadInput = document.getElementById('image-upload-input');
                const imagePreviews = document.getElementById('image-previews');
                const uploadFeedback = document.getElementById('upload-feedback');
                const nextToTaggingBtn = document.getElementById('next-to-tagging-btn');
                
                allImagesWithTagsData = []; 
                nextToTaggingBtn.disabled = true;

                imageUploadInput.addEventListener('change', (e) => {
                    imagePreviews.innerHTML = '';
                    uploadFeedback.textContent = '';
                    allImagesWithTagsData = [];

                    const files = Array.from(e.target.files);
                    if (files.length === 0 || files.length > 2) {
                        uploadFeedback.textContent = files.length > 2 ? 'Please select a maximum of 2 photos.' : 'Please select photos.';
                        nextToTaggingBtn.disabled = true;
                        return;
                    }

                    let validFilesCount = 0;
                    files.forEach(file => {
                        if (!file.type.startsWith('image/')) {
                            uploadFeedback.textContent = `File "${file.name}" is not an image.`;
                            nextToTaggingBtn.disabled = true;
                            return;
                        }

                        const reader = new FileReader();
                        reader.onload = (e) => {
                            const imageUrl = e.target.result;
                            const imgDiv = document.createElement('div');
                            imgDiv.className = 'relative group';
                            imgDiv.innerHTML = `<img src="${imageUrl}" alt="Preview" class="w-full h-32 object-cover rounded-lg border border-gray-700"><span class="absolute bottom-1 left-1 bg-black bg-opacity-70 text-white text-xs px-2 py-1 rounded-md">${file.name}</span>`;
                            imagePreviews.appendChild(imgDiv);

                            allImagesWithTagsData.push({ originalFile: file, name: file.name, mimeType: file.type, url: imageUrl, driveLink: '', fileId: '', tags: [] });
                            validFilesCount++;

                            if (validFilesCount === files.length) {
                                nextToTaggingBtn.disabled = false;
                                uploadFeedback.textContent = '';
                            }
                        };
                        reader.readAsDataURL(file);
                    });
                });

                nextToTaggingBtn.addEventListener('click', () => {
                    if (allImagesWithTagsData.length === 0 || !tempQualiBoulderData) {
                        uploadFeedback.textContent = 'Data missing. Please select photos and add boulders first.';
                        return;
                    }
                    activeImageIndex = 0;
                    navigate('tagPhotos', { qualiBoulders: tempQualiBoulderData.boulders, qualiName: tempQualiBoulderData.quali });
                });
            }

            function renderTagPhotosPage(context) {
                const { qualiBoulders, qualiName } = context;

                if (!qualiBoulders || !qualiName || allImagesWithTagsData.length === 0) {
                    mainContent.innerHTML = `<div class="bg-gray-900 border border-gray-800 p-6 rounded-lg shadow-md text-center text-red-400">Error: Missing data. Please restart.</div>`;
                    headerContent.innerHTML = `<div class="flex-1"><button id="back-btn" class="flex items-center space-x-2 text-gray-400 hover:text-white font-medium"><i class="fas fa-arrow-left"></i><span class="hidden sm:inline">Back</span></button></div><h1 class="text-2xl font-bold text-gray-100 flex-1 text-center">Error</h1><div class="flex-1"></div>`;
                    document.getElementById('back-btn').addEventListener('click', () => navigate('admin'));
                    return;
                }

                headerContent.innerHTML = `
                    <div class="flex-1"><button id="back-btn" class="flex items-center space-x-2 text-gray-400 hover:text-white font-medium"><i class="fas fa-arrow-left"></i><span class="hidden sm:inline">Back</span></button></div>
                    <h1 class="text-2xl font-bold text-gray-100 flex-1 text-center">${qualiName} - Tag Photos</h1>
                    <div class="flex-1 text-right"><a href="index.html" class="text-gray-400 hover:text-white"><i class="fas fa-home text-xl"></i></a></div>`;
                document.getElementById('back-btn').addEventListener('click', () => history.back());

                const boulderOptions = qualiBoulders.map(b => `<option value="${b.Name}">${b.Name} (${b.Grade})</option>`).join('');

                mainContent.innerHTML = `
                    <div class="max-w-3xl mx-auto space-y-6">
                        <div class="flex justify-between items-center text-gray-300">
                            <button id="prev-image-btn" class="bg-gray-800 hover:bg-gray-700 px-4 py-2 rounded-lg transition duration-200" disabled><i class="fas fa-chevron-left"></i> Prev</button>
                            <span id="image-counter" class="font-semibold">Image 1 of ${allImagesWithTagsData.length}</span>
                            <button id="next-image-btn" class="bg-gray-800 hover:bg-gray-700 px-4 py-2 rounded-lg transition duration-200" ${allImagesWithTagsData.length <= 1 ? 'disabled' : ''}>Next <i class="fas fa-chevron-right"></i></button>
                        </div>
                        <div class="image-tagging-container">
                            <img id="tagging-image" src="" alt="Boulder to Tag"><canvas id="tagging-canvas"></canvas>
                        </div>
                        <p id="image-name-display" class="text-center text-sm text-gray-400 mt-2"></p>
                        <div class="bg-gray-900 border border-gray-800 p-4 rounded-lg shadow-md space-y-4">
                            <div>
                                <label for="boulder-select" class="block text-sm font-medium text-gray-300 mb-1">Select Boulder to Tag</label>
                                <select id="boulder-select" class="w-full bg-gray-800 border border-gray-700 text-gray-200 rounded-lg p-3"><option value="">-- Choose Boulder --</option>${boulderOptions}</select>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <button id="tag-boulder-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition duration-300" disabled><i class="fas fa-tag mr-2"></i>Tag Boulder</button>
                                <button id="delete-last-tag-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-4 rounded-lg transition duration-300" disabled><i class="fas fa-trash-alt mr-2"></i>Delete Last Tag</button>
                            </div>
                            <div id="current-image-tags" class="mt-4 space-y-2 text-sm text-gray-400"><p class="text-center">No tags yet for this image.</p></div>
                        </div>
                        <button id="submit-all-tagged-photos-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg shadow-lg transition duration-300" disabled><i class="fas fa-cloud-upload-alt mr-2"></i>Submit All Tagged Photos</button>
                        <p id="tagging-feedback" class="text-center h-6"></p>
                    </div>`;

                const taggingImage = document.getElementById('tagging-image');
                const taggingCanvas = document.getElementById('tagging-canvas');
                const ctx = taggingCanvas.getContext('2d');
                const boulderSelect = document.getElementById('boulder-select');
                const tagBoulderBtn = document.getElementById('tag-boulder-btn');
                const deleteLastTagBtn = document.getElementById('delete-last-tag-btn');
                const currentImageTagsDiv = document.getElementById('current-image-tags');
                const submitAllTaggedPhotosBtn = document.getElementById('submit-all-tagged-photos-btn');
                const taggingFeedback = document.getElementById('tagging-feedback');
                const prevImageBtn = document.getElementById('prev-image-btn');
                const nextImageBtn = document.getElementById('next-image-btn');
                const imageCounterSpan = document.getElementById('image-counter');
                const imageNameDisplay = document.getElementById('image-name-display');

                let currentDrawingCircle = null, isDrawing = false, startX, startY;
                const CIRCLE_RADIUS = 20;

                function getCanvasCoordinates(event) {
                    const rect = taggingCanvas.getBoundingClientRect();
                    const scaleX = taggingCanvas.width / rect.width;
                    const scaleY = taggingCanvas.height / rect.height;
                    const clientX = event.touches ? event.touches[0].clientX : event.clientX;
                    const clientY = event.touches ? event.touches[0].clientY : event.clientY;
                    return { x: (clientX - rect.left) * scaleX, y: (clientY - rect.top) * scaleY };
                }

                function drawCircle(x, y, radius, color, fill = false, text = '', textColor = 'white') {
                    ctx.beginPath();
                    ctx.arc(x, y, radius, 0, 2 * Math.PI);
                    if (fill) { ctx.fillStyle = color; ctx.fill(); }
                    ctx.strokeStyle = color; ctx.lineWidth = 2; ctx.stroke();
                    if (text) {
                        ctx.fillStyle = textColor;
                        ctx.font = 'bold 16px Inter';
                        ctx.textAlign = 'center';
                        ctx.textBaseline = 'middle';
                        ctx.fillText(text, x, y);
                    }
                }

                function redrawCanvas() {
                    ctx.clearRect(0, 0, taggingCanvas.width, taggingCanvas.height);
                    allImagesWithTagsData[activeImageIndex].tags.forEach(tag => drawCircle(tag.x, tag.y, tag.radius, 'rgba(60, 179, 113, 0.7)', true, tag.boulder));
                    if (currentDrawingCircle) drawCircle(currentDrawingCircle.x, currentDrawingCircle.y, currentDrawingCircle.radius, 'rgba(255, 255, 0, 0.8)');
                    updateTagListDisplay();
                    checkTaggingControlStates();
                }

                function updateTagListDisplay() {
                    const currentTags = allImagesWithTagsData[activeImageIndex].tags;
                    if (currentTags.length === 0) {
                        currentImageTagsDiv.innerHTML = '<p class="text-center">No tags yet for this image.</p>';
                    } else {
                        currentImageTagsDiv.innerHTML = `<p class="font-semibold text-gray-200 mb-2">Tagged Boulders:</p><ul class="list-disc list-inside space-y-1">${currentTags.map(tag => `<li>Boulder ${tag.boulder}</li>`).join('')}</ul>`;
                    }
                }

                function checkTaggingControlStates() {
                    tagBoulderBtn.disabled = !(currentDrawingCircle && boulderSelect.value);
                    deleteLastTagBtn.disabled = allImagesWithTagsData[activeImageIndex].tags.length === 0;
                    submitAllTaggedPhotosBtn.disabled = !allImagesWithTagsData.every(img => img.tags.length > 0);
                }

                function startDraw(e) {
                    e.preventDefault(); isDrawing = true;
                    const coords = getCanvasCoordinates(e);
                    startX = coords.x; startY = coords.y;
                    currentDrawingCircle = { x: startX, y: startY, radius: CIRCLE_RADIUS }; redrawCanvas();
                }
                function draw(e) {
                    if (!isDrawing) return; e.preventDefault();
                    const coords = getCanvasCoordinates(e);
                    const dx = coords.x - startX; const dy = coords.y - startY;
                    currentDrawingCircle.radius = Math.max(5, Math.sqrt(dx * dx + dy * dy)); redrawCanvas();
                }
                function endDraw() {
                    isDrawing = false;
                    if (currentDrawingCircle && currentDrawingCircle.radius >= 5) checkTaggingControlStates();
                    else { currentDrawingCircle = null; redrawCanvas(); }
                }

                taggingCanvas.addEventListener('mousedown', startDraw);
                taggingCanvas.addEventListener('mousemove', draw);
                taggingCanvas.addEventListener('mouseup', endDraw);
                taggingCanvas.addEventListener('mouseleave', () => { if(isDrawing) { isDrawing = false; currentDrawingCircle = null; redrawCanvas(); } });
                taggingCanvas.addEventListener('touchstart', startDraw);
                taggingCanvas.addEventListener('touchmove', draw);
                taggingCanvas.addEventListener('touchend', endDraw);

                prevImageBtn.addEventListener('click', () => { if (activeImageIndex > 0) loadImageForTagging(--activeImageIndex); });
                nextImageBtn.addEventListener('click', () => { if (activeImageIndex < allImagesWithTagsData.length - 1) loadImageForTagging(++activeImageIndex); });
                boulderSelect.addEventListener('change', checkTaggingControlStates);
                tagBoulderBtn.addEventListener('click', () => {
                    if (currentDrawingCircle && boulderSelect.value) {
                        allImagesWithTagsData[activeImageIndex].tags.push({ boulder: boulderSelect.value, x: currentDrawingCircle.x, y: currentDrawingCircle.y, radius: currentDrawingCircle.radius });
                        currentDrawingCircle = null; boulderSelect.value = ''; redrawCanvas();
                    }
                });
                deleteLastTagBtn.addEventListener('click', () => {
                    if (allImagesWithTagsData[activeImageIndex].tags.length > 0) { allImagesWithTagsData[activeImageIndex].tags.pop(); redrawCanvas(); }
                });

                function loadImageForTagging(index) {
                    activeImageIndex = index;
                    const imageData = allImagesWithTagsData[index];
                    taggingImage.src = imageData.url;
                    imageNameDisplay.textContent = imageData.name;
                    imageCounterSpan.textContent = `Image ${index + 1} of ${allImagesWithTagsData.length}`;
                    prevImageBtn.disabled = (index === 0);
                    nextImageBtn.disabled = (index === allImagesWithTagsData.length - 1);
                    taggingImage.onload = () => {
                        taggingCanvas.width = taggingImage.naturalWidth;
                        taggingCanvas.height = taggingImage.naturalHeight;
                        redrawCanvas();
                    };
                    if (taggingImage.complete) taggingImage.onload();
                }
                loadImageForTagging(activeImageIndex);

                submitAllTaggedPhotosBtn.addEventListener('click', async () => {
                    taggingFeedback.textContent = ''; submitAllTaggedPhotosBtn.disabled = true;
                    submitAllTaggedPhotosBtn.innerHTML = `<i class="fas fa-spinner fa-spin mr-2"></i>Uploading...`;
                    try {
                        for (let i = 0; i < allImagesWithTagsData.length; i++) {
                            const imgData = allImagesWithTagsData[i];
                            taggingFeedback.textContent = `Processing image ${i + 1}...`;
                            // This would be where you upload the original file `imgData.originalFile` to a server/service
                        }
                        taggingFeedback.textContent = 'Saving data...';
                        
                        const payload = {
                            formType: 'saveBoulderData',
                            quali: qualiName,
                            boulders: tempQualiBoulderData.boulders,
                            images: allImagesWithTagsData.map(img => ({ name: img.name, tags: img.tags })) // Simplified for demo
                        };

                        await fetch(GOOGLE_APP_SCRIPT_URL, {
                            method: 'POST',
                            mode: 'no-cors',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });

                        taggingFeedback.innerHTML = `<p class="text-green-400">Successfully saved all data!</p>`;
                        tempQualiBoulderData = null; allImagesWithTagsData = [];
                        setTimeout(() => navigate('admin'), 2000);
                    } catch (error) {
                        console.error("Submission Error:", error);
                        taggingFeedback.innerHTML = `<p class="text-red-400">Error: ${error.message}</p>`;
                    } finally {
                        submitAllTaggedPhotosBtn.disabled = false;
                        submitAllTaggedPhotosBtn.innerHTML = `<i class="fas fa-cloud-upload-alt mr-2"></i>Submit All Tagged Photos`;
                    }
                });
            }


            // --- Other Admin Functions ---

            function showConfirmationModal(title, message, onConfirmCallback) {
                const modal = document.getElementById('confirmation-modal');
                document.getElementById('confirmation-title').textContent = title;
                document.getElementById('confirmation-message').textContent = message;
                const confirmBtn = document.getElementById('confirmation-confirm');
                const cancelBtn = document.getElementById('confirmation-cancel');

                const newConfirmBtn = confirmBtn.cloneNode(true);
                confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
                newConfirmBtn.addEventListener('click', () => { onConfirmCallback(); modal.classList.add('hidden'); });
                
                const newCancelBtn = cancelBtn.cloneNode(true);
                cancelBtn.parentNode.replaceChild(newCancelBtn, cancelBtn);
                newCancelBtn.addEventListener('click', () => modal.classList.add('hidden'));

                modal.classList.remove('hidden');
            }

            function showPinModal() {
                const pinModal = document.getElementById('pin-modal');
                pinModal.classList.remove('hidden');
                document.getElementById('pin-input').value = '';
                document.getElementById('pin-error').textContent = '';
                document.getElementById('pin-input').focus();
            }

            // PIN pad logic
            document.getElementById('pin-pad').addEventListener('click', (e) => {
                if (e.target.closest('.pin-pad-button')) {
                    const button = e.target.closest('.pin-pad-button');
                    const digit = button.dataset.digit;
                    const action = button.dataset.action;
                    const pinInput = document.getElementById('pin-input');
                    document.getElementById('pin-error').textContent = '';
                    if (digit && pinInput.value.length < ADMIN_PIN.length) pinInput.value += digit;
                    else if (action === 'backspace') pinInput.value = pinInput.value.slice(0, -1);
                }
            });

            document.getElementById('pin-submit').addEventListener('click', () => {
                const pinInput = document.getElementById('pin-input');
                if (pinInput.value === ADMIN_PIN) {
                    document.getElementById('pin-modal').classList.add('hidden');
                    indicator.remove();
                    stickyContainer.classList.remove('hidden');
                    mainContent.classList.remove('hidden');
                    renderPageContent('admin');
                } else {
                    document.getElementById('pin-error').textContent = 'Incorrect PIN.';
                    pinInput.value = '';
                }
            });

            document.getElementById('pin-cancel').addEventListener('click', () => {
                window.location.href = 'index.html'; // Go to main site
            });

            // --- Manage Finals Page ---
            function renderManageFinalsPage() {
                headerContent.innerHTML = `
                    <div class="flex-1">
                        <button id="back-btn" class="flex items-center space-x-2 text-gray-400 hover:text-white font-medium"><i class="fas fa-arrow-left"></i><span class="hidden sm:inline">Back</span></button>
                    </div>
                    <h1 class="text-2xl font-bold text-gray-100 flex-1 text-center">Manage Finals Roster</h1>
                    <div class="flex-1 text-right">
                        <a href="index.html" class="text-gray-400 hover:text-white"><i class="fas fa-home text-xl"></i></a>
                    </div>`;
                document.getElementById('back-btn').addEventListener('click', () => history.back());

                const today = getLondonTime();
                today.setHours(0, 0, 0, 0);
                const upcomingFinals = appData.finals.filter(f => new Date(f.date) >= today);
                const finalOptions = upcomingFinals.map(f => `<option value="${f.final}">${f.final}</option>`).join('');

                mainContent.innerHTML = `
                    <div class="max-w-xl mx-auto">
                        <form id="manage-finals-form" class="space-y-6">
                            <div>
                                <label for="final-select" class="block text-sm font-medium text-gray-300 mb-1">Select Upcoming Final</label>
                                <select id="final-select" name="final" required class="w-full bg-gray-800 border border-gray-700 text-gray-200 rounded-lg p-3 focus:outline-none focus:border-blue-500">
                                    <option value="">-- Select a Final --</option>
                                    ${finalOptions}
                                </select>
                            </div>
                            <div id="roster-management-container" class="hidden space-y-4"></div>
                            <div id="form-feedback" class="text-center h-6"></div>
                        </form>
                    </div>
                `;

                const finalSelect = document.getElementById('final-select');
                const rosterContainer = document.getElementById('roster-management-container');
                const feedback = document.getElementById('form-feedback');
                let currentFinalists = [];

                finalSelect.addEventListener('change', () => {
                    const selectedFinal = finalSelect.value;
                    rosterContainer.innerHTML = '';
                    if (!selectedFinal) return;

                    let finalists = appData.fClimbers
                        .filter(fc => fc.final === selectedFinal)
                        .map(fc => fc.climber);
                    
                    if (finalists.length === 0) {
                        const compName = selectedFinal.replace(/F$/, '');
                        const standingsForComp = appData.qStandings.filter(s => s.comp === compName);
                        standingsForComp.sort((a,b) => parseInt(a.place) - parseInt(b.place))
                        finalists = standingsForComp.slice(0, 8).map(s => s.climber);
                    }
                    currentFinalists = finalists;
                    renderRosterUI();
                });

                function renderRosterUI() {
                    let html = `<h3 class="text-lg font-semibold text-gray-200 pt-4 border-t border-gray-800">Current Finalists</h3>`;
                    html += '<div id="finalists-list" class="space-y-2">';
                    currentFinalists.forEach(climber => {
                        html += `
                            <div class="flex justify-between items-center bg-gray-800 p-2 rounded-lg">
                                <span class="text-gray-200">${climber}</span>
                                <button type="button" data-climber="${climber}" class="remove-climber-btn text-red-500 hover:text-red-400 text-2xl font-bold">&times;</button>
                            </div>
                        `;
                    });
                    html += `</div>`;

                    const availableClimbers = appData.climbers.map(c => c.name).filter(name => !currentFinalists.includes(name)).sort();
                    let climberOptions = availableClimbers.map(c => `<option value="${c}">${c}</option>`).join('');

                    html += `
                        <div class="pt-4 border-t border-gray-800">
                             <label for="add-climber-select" class="block text-sm font-medium text-gray-300 mb-1">Add Climber</label>
                             <div class="flex gap-2">
                                 <select id="add-climber-select" class="flex-grow bg-gray-800 border border-gray-700 text-gray-200 rounded-lg p-3">
                                     <option value="">-- Select a climber to add --</option>
                                     ${climberOptions}
                                 </select>
                                 <button type="button" id="add-climber-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold p-3 rounded-lg">Add</button>
                             </div>
                        </div>
                        <div class="pt-4">
                            <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg">Save Changes</button>
                        </div>
                    `;
                    rosterContainer.innerHTML = html;
                    rosterContainer.classList.remove('hidden');

                    document.querySelectorAll('.remove-climber-btn').forEach(btn => {
                        btn.addEventListener('click', e => {
                            const climberToRemove = e.target.dataset.climber;
                            currentFinalists = currentFinalists.filter(c => c !== climberToRemove);
                            renderRosterUI();
                        });
                    });

                    document.getElementById('add-climber-btn').addEventListener('click', () => {
                        const select = document.getElementById('add-climber-select');
                        const climberToAdd = select.value;
                        if (climberToAdd && !currentFinalists.includes(climberToAdd)) {
                            currentFinalists.push(climberToAdd);
                            currentFinalists.sort();
                            renderRosterUI();
                        }
                    });
                }

                document.getElementById('manage-finals-form').addEventListener('submit', e => {
                    e.preventDefault();
                    showConfirmationModal('Confirm Changes', 'Are you sure you want to save this finals roster?', () => {
                        feedback.innerHTML = '';
                        const payload = {
                            formType: 'manageFinalists',
                            final: finalSelect.value,
                            climbers: currentFinalists
                        };
                        const submitButton = e.target.querySelector('button[type="submit"]');
                        submitButton.disabled = true;
                        submitButton.innerHTML = `<i class="fas fa-spinner fa-spin mr-2"></i>Saving...`;

                        fetch(GOOGLE_APP_SCRIPT_URL, {
                            method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        })
                        .then(() => feedback.innerHTML = `<p class="text-green-400">Finalist roster for ${finalSelect.value} has been updated!</p>`)
                        .catch(err => {
                             console.error('Error!', err);
                             feedback.innerHTML = `<p class="text-red-400">Error: Could not save roster. Check connection.</p>`;
                        })
                        .finally(() => {
                            submitButton.disabled = false;
                            submitButton.innerHTML = `Save Changes`;
                        });
                    });
                });
            }

            // --- Judges App Pages ---
            function renderJudgesAppPage() {
                headerContent.innerHTML = `
                    <div class="flex-1">
                        <button id="back-btn" class="flex items-center space-x-2 text-gray-400 hover:text-white font-medium"><i class="fas fa-arrow-left"></i><span class="hidden sm:inline">Back</span></button>
                    </div>
                    <h1 class="text-2xl font-bold text-gray-100 flex-1 text-center">Judges App</h1>
                    <div class="flex-1 text-right">
                        <a href="index.html" class="text-gray-400 hover:text-white"><i class="fas fa-home text-xl"></i></a>
                    </div>`;
                document.getElementById('back-btn').addEventListener('click', () => history.back());

                mainContent.innerHTML = `
                    <div class="max-w-xl mx-auto">
                        <form id="judges-form" class="space-y-6">
                            <div>
                                <label for="final-select" class="block text-sm font-medium text-gray-300 mb-1">Select Final</label>
                                <select id="final-select" name="final" required class="w-full bg-gray-800 border border-gray-700 text-gray-200 rounded-lg p-3"></select>
                            </div>
                            <div id="climber-select-container" class="hidden">
                                <label for="climber-select" class="block text-sm font-medium text-gray-300 mb-1">Select Climber</label>
                                <select id="climber-select" name="climber" required class="w-full bg-gray-800 border border-gray-700 text-gray-200 rounded-lg p-3"></select>
                            </div>
                            <div id="boulder-select-container" class="hidden">
                                <label for="boulder-select" class="block text-sm font-medium text-gray-300 mb-1">Select Boulder</label>
                                <select id="boulder-select" name="boulder" required class="w-full bg-gray-800 border border-gray-700 text-gray-200 rounded-lg p-3"></select>
                            </div>
                            <div id="next-btn-container" class="hidden pt-2">
                                <button type="submit" disabled class="w-full bg-gray-600 text-white font-bold py-3 px-4 rounded-lg transition">Next</button>
                            </div>
                        </form>
                    </div>`;

                const form = document.getElementById('judges-form');
                const finalSelect = document.getElementById('final-select');
                const climberSelectContainer = document.getElementById('climber-select-container');
                const climberSelect = document.getElementById('climber-select');
                const boulderSelectContainer = document.getElementById('boulder-select-container');
                const boulderSelect = document.getElementById('boulder-select');
                const nextBtnContainer = document.getElementById('next-btn-container');

                const now = getLondonTime();
                const liveFinals = appData.finals.filter(final => {
                    const finalDate = new Date(final.date);
                    const endDate = new Date(finalDate.getTime() + (30 * 60 * 60 * 1000));
                    return now >= finalDate && now <= endDate;
                });
                
                let finalsOptionsHTML = '<option value="">-- Select a Final --</option>';
                if (liveFinals.length > 0) liveFinals.forEach(f => finalsOptionsHTML += `<option value="${f.final}">${f.final}</option>`);
                else finalsOptionsHTML = '<option value="">-- No Live Finals --</option>';
                finalSelect.innerHTML = finalsOptionsHTML;

                const checkCompletion = () => {
                    const nextButton = nextBtnContainer.querySelector('button');
                    const isComplete = finalSelect.value && climberSelect.value && boulderSelect.value;
                    nextButton.disabled = !isComplete;
                    nextButton.classList.toggle('bg-gray-600', !isComplete);
                    nextButton.classList.toggle('cursor-not-allowed', !isComplete);
                    nextButton.classList.toggle('bg-blue-600', isComplete);
                    nextButton.classList.toggle('hover:bg-blue-700', isComplete);
                };
                
                finalSelect.addEventListener('change', () => {
                    climberSelectContainer.classList.add('hidden');
                    boulderSelectContainer.classList.add('hidden');
                    nextBtnContainer.classList.add('hidden');
                    climberSelect.value = '';
                    boulderSelect.value = '';

                    if (finalSelect.value) {
                        const climbersInFinal = appData.fClimbers.filter(r => r.final === finalSelect.value).map(r => r.climber).sort();
                        let climberOptionsHTML = '<option value="">-- Select a Climber --</option>';
                        climbersInFinal.forEach(c => climberOptionsHTML += `<option value="${c}">${c}</option>`);
                        climberSelect.innerHTML = climberOptionsHTML;
                        climberSelectContainer.classList.remove('hidden');
                    }
                    checkCompletion();
                });

                climberSelect.addEventListener('change', () => {
                    boulderSelectContainer.classList.add('hidden');
                    nextBtnContainer.classList.add('hidden');
                    boulderSelect.value = '';

                    if (climberSelect.value) {
                        boulderSelect.innerHTML = `<option value="">-- Select a Boulder --</option><option value="A">A</option><option value="B">B</option><option value="C">C</option><option value="D">D</option>`;
                        boulderSelectContainer.classList.remove('hidden');
                    }
                     checkCompletion();
                });
                
                boulderSelect.addEventListener('change', () => {
                    if (boulderSelect.value) nextBtnContainer.classList.remove('hidden');
                    else nextBtnContainer.classList.add('hidden');
                    checkCompletion();
                });

                form.addEventListener('submit', (e) => {
                    e.preventDefault();
                    navigate('judgeBoulderPage', {
                        final: finalSelect.value,
                        climber: climberSelect.value,
                        boulder: boulderSelect.value
                    });
                });
            }

            function renderJudgeBoulderPage(context) {
                const { final, climber, boulder } = context;
                headerContent.innerHTML = `
                    <div class="flex-1">
                        <button id="back-btn" class="flex items-center space-x-2 text-gray-400 hover:text-white font-medium"><i class="fas fa-arrow-left"></i><span class="hidden sm:inline">Back</span></button>
                    </div>
                    <div class="flex-1 text-center">
                        <h1 class="text-2xl font-bold text-gray-100">${climber}</h1>
                        <h2 class="text-sm font-medium text-gray-400 mt-1 whitespace-nowrap">${boulder} &middot; ${final}</h2>
                    </div>
                    <div class="flex-1 text-right">
                        <a href="index.html" class="text-gray-400 hover:text-white"><i class="fas fa-home text-xl"></i></a>
                    </div>`;
                document.getElementById('back-btn').addEventListener('click', () => history.back());

                mainContent.innerHTML = `
                    <div class="max-w-md mx-auto space-y-4">
                        <div class="text-center">
                            <div id="timer-display" class="text-7xl font-mono font-bold text-white">04:00</div>
                            <div class="flex justify-center items-center space-x-4 mt-2">
                                <button id="play-btn" class="text-gray-300 hover:text-white text-3xl p-2"><i class="fas fa-play"></i></button>
                                <button id="pause-btn" class="text-gray-300 hover:text-white text-3xl p-2"><i class="fas fa-pause"></i></button>
                                <button id="reset-clock-btn" class="text-gray-300 hover:text-white text-3xl p-2"><i class="fas fa-undo"></i></button>
                            </div>
                        </div>
                        <div class="grid grid-cols-3 gap-4 text-center items-center py-4">
                            <div>
                                <div class="text-sm text-green-400">TOP</div>
                                <div id="top-score" class="text-4xl font-bold text-green-400">0</div>
                            </div>
                            <div>
                                <div class="text-sm text-blue-400">ZONE</div>
                                <div id="zone-score" class="text-4xl font-bold text-blue-400">0</div>
                            </div>
                            <div>
                                <div class="text-sm text-gray-400">Attempts</div>
                                <div id="attempt-counter" class="text-4xl font-bold text-white">0</div>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-4 pt-4">
                            <button id="top-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold h-24 text-2xl rounded-lg transition flex items-center justify-center">TOP</button>
                            <button id="add-attempt-btn" class="w-full bg-gray-700 hover:bg-gray-600 text-white font-bold h-24 text-4xl rounded-lg transition flex items-center justify-center">+</button>
                            <button id="zone-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold h-24 text-2xl rounded-lg transition flex items-center justify-center">ZONE</button>
                            <button id="subtract-attempt-btn" class="w-full bg-gray-800 hover:bg-gray-700 text-white font-bold h-24 text-4xl rounded-lg transition flex items-center justify-center">-</button>
                            <button id="reset-btn" class="w-full bg-gray-700 hover:bg-gray-600 text-white font-bold py-4 rounded-lg transition">Reset</button>
                            <button id="submit-btn" class="w-full bg-blue-800 hover:bg-blue-700 text-white font-bold py-4 rounded-lg transition">Submit</button>
                        </div>
                        <div id="form-feedback" class="text-center h-6 py-2"></div>
                    </div>`;

                let timeRemaining = 240, timerInterval = null, attemptCount = 0, topAttempt = 0, zoneAttempt = 0;
                const timerDisplay = document.getElementById('timer-display');
                const playBtn = document.getElementById('play-btn');
                const pauseBtn = document.getElementById('pause-btn');
                const resetClockBtn = document.getElementById('reset-clock-btn');
                const attemptCounter = document.getElementById('attempt-counter');
                const topScore = document.getElementById('top-score');
                const zoneScore = document.getElementById('zone-score');
                const topBtn = document.getElementById('top-btn');
                const zoneBtn = document.getElementById('zone-btn');
                const addAttemptBtn = document.getElementById('add-attempt-btn');
                const subtractAttemptBtn = document.getElementById('subtract-attempt-btn');
                const resetBtn = document.getElementById('reset-btn');
                const submitBtn = document.getElementById('submit-btn');
                const feedbackDiv = document.getElementById('form-feedback');

                const formatTime = (s) => `${Math.floor(s/60).toString().padStart(2,'0')}:${(s%60).toString().padStart(2,'0')}`;
                const updateUI = () => {
                    timerDisplay.textContent = formatTime(timeRemaining);
                    attemptCounter.textContent = attemptCount;
                    topScore.textContent = topAttempt;
                    zoneScore.textContent = zoneAttempt;
                    topBtn.classList.toggle('opacity-50', topAttempt > 0);
                    zoneBtn.classList.toggle('opacity-50', zoneAttempt > 0);
                };
                const resetScoresAndAttempts = () => {
                    attemptCount = 0; topAttempt = 0; zoneAttempt = 0;
                    feedbackDiv.innerHTML = ''; updateUI();
                };
                const startTimer = () => {
                    if (timerInterval || timeRemaining <= 0) return;
                    timerInterval = setInterval(() => {
                        timeRemaining--;
                        updateUI();
                        if (timeRemaining <= 0) {
                            clearInterval(timerInterval);
                            timerInterval = null;
                            timerDisplay.classList.add('text-red-500');
                        }
                    }, 1000);
                };
                playBtn.addEventListener('click', startTimer);
                pauseBtn.addEventListener('click', () => { clearInterval(timerInterval); timerInterval = null; });
                resetClockBtn.addEventListener('click', () => {
                    showConfirmationModal('Reset Timer?', 'This will only reset the clock.', () => {
                        clearInterval(timerInterval); timerInterval = null; timeRemaining = 240;
                        timerDisplay.classList.remove('text-red-500'); updateUI();
                    });
                });
                addAttemptBtn.addEventListener('click', () => { attemptCount++; updateUI(); });
                subtractAttemptBtn.addEventListener('click', () => { if (attemptCount > 0) { attemptCount--; updateUI(); } });
                zoneBtn.addEventListener('click', () => {
                    zoneAttempt = zoneAttempt > 0 ? 0 : attemptCount;
                    updateUI();
                });
                topBtn.addEventListener('click', () => {
                    topAttempt = topAttempt > 0 ? 0 : attemptCount;
                    if (topAttempt > 0 && zoneAttempt === 0) zoneAttempt = attemptCount;
                    updateUI();
                });
                resetBtn.addEventListener('click', () => {
                    showConfirmationModal('Reset Scores?', 'This will reset attempts, Top, and Zone scores. The timer will not be affected.', resetScoresAndAttempts);
                });
                submitBtn.addEventListener('click', () => {
                    const resultSummary = `Submit: Top(${topAttempt}), Zone(${zoneAttempt})?`;
                    showConfirmationModal('Confirm Result', resultSummary, () => {
                        submitBtn.disabled = true;
                        submitBtn.innerHTML = `<i class="fas fa-spinner fa-spin mr-2"></i>Submitting...`;
                        const payload = {
                            formType: 'submitFinalsResult', final, climber, boulder,
                            send: topAttempt > 0 ? 'Top' : (zoneAttempt > 0 ? 'Zone' : 'Nothing'),
                            topAttempts: topAttempt, zoneAttempts: zoneAttempt
                        };
                        fetch(GOOGLE_APP_SCRIPT_URL, {
                            method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        })
                        .then(() => {
                            feedbackDiv.innerHTML = `<p class="text-green-400">Result saved!</p>`;
                            setTimeout(() => history.back(), 1500);
                        })
                        .catch(err => {
                            console.error('Error!', err);
                            feedbackDiv.innerHTML = `<p class="text-red-400">Error: Submission failed.</p>`;
                            submitBtn.disabled = false; submitBtn.innerHTML = 'Submit';
                        });
                    });
                });
                updateUI();
            }

            async function init() {
                indicator.innerHTML = `<i class="fas fa-spinner fa-spin text-4xl text-gray-400"></i><p class="mt-4 text-lg font-medium text-gray-300">Loading Admin Data...</p>`;
                try {
                    const dataPromises = Object.entries(GOOGLE_SHEET_URLS).map(([key, url]) => fetchAndParseSheet(url).then(data => [key, data]));
                    const dataEntries = await Promise.all(dataPromises);
                    appData = Object.fromEntries(dataEntries);
                    
                    showPinModal();
                } catch (error) {
                    console.error("Initialization Error:", error);
                    indicator.innerHTML = `<div class="p-10 bg-red-900/50 border border-red-500/30 text-red-300 rounded-lg"><h2 class="font-bold text-xl text-red-200">Error Loading Data</h2><p class="mt-2 text-sm">${error.message}</p></div>`;
                }
            }

            init();
        });
    </script>
</body>
</html>
