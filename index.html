<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mockomps</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- PWA: Web App Manifest -->
    <link rel="manifest" href="/manifest.json">
    <!-- PWA: Apple Specific Meta Tags for iOS Home Screen App -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="/images/icon-192x192.png">
    <!-- Ensure you have a 192x192px icon and a 512x512px icon in an 'images' folder. -->

    <style>
        body { font-family: 'Inter', sans-serif; overflow-x: hidden; }
        /* Custom CSS to hide the scrollbar but keep functionality */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }
        /* Prevents horizontal scroll on a child from affecting the parent page scroll */
        .h-scroll {
            overscroll-behavior-x: contain;
        }
        /* Styles for the new segmented control */
        .segmented-control {
            display: flex;
            width: 100%;
            border-radius: 0.5rem;
            background-color: #374151; /* gray-700 */
            padding: 0.25rem;
        }
        .segmented-control input[type="radio"] {
            display: none; /* Hide the actual radio button */
        }
        .segmented-control label {
            flex: 1;
            padding: 0.5rem 0.25rem;
            text-align: center;
            border-radius: 0.375rem;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out, color 0.2s ease-in-out;
            font-size: 0.875rem; /* text-sm */
            font-weight: 600; /* font-semibold */
        }
        .segmented-control input[type="radio"]:checked + label {
            background-color: #3b82f6; /* blue-600 */
            color: white;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
        }
        .segmented-control label.text-flash { color: #facc15; } /* yellow-400 */
        .segmented-control label.text-top { color: #4ade80; } /* green-400 */
        .segmented-control label.text-zone { color: #60a5fa; } /* blue-400 */
        .segmented-control label.text-nothing { color: #9ca3af; } /* gray-400 */
        .segmented-control input[type="radio"]:checked + label.text-flash,
        .segmented-control input[type="radio"]:checked + label.text-top,
        .segmented-control input[type="radio"]:checked + label.text-zone,
        .segmented-control input[type="radio"]:checked + label.text-nothing {
            color: white;
        }
        /* Ensure disabled buttons have the correct cursor */
        button:disabled {
            cursor: not-allowed;
        }

        /* Custom styles for the pin pad */
        .pin-pad-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.5rem; /* Space between buttons */
            margin-top: 1rem;
        }

        .pin-pad-button {
            background-color: #1f2937; /* gray-800 */
            color: #d1d5db; /* gray-300 */
            padding: 1.5rem;
            border-radius: 0.75rem; /* rounded-xl */
            font-size: 2.25rem; /* text-4xl */
            font-weight: 600; /* font-semibold */
            text-align: center;
            transition: background-color 0.2s ease-in-out;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1), 0 1px 3px rgba(0, 0, 0, 0.08); /* shadow-lg */
        }

        .pin-pad-button:hover {
            background-color: #374151; /* gray-700 */
        }

        .pin-pad-button:active {
            background-color: #4b5563; /* gray-600 */
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        /* Adjust font size for icons like backspace */
        .pin-pad-button .fa-backspace {
            font-size: 1.5rem; /* Adjusted for visual balance */
        }

        /* Specific style for empty cell below 7 */
        .pin-pad-grid .empty-cell {
            visibility: hidden;
        }

        /* Hide dropdown arrow for specific select fields in boulder form */
        .boulder-row select[name="grade"],
        .boulder-row select[name="color"],
        .boulder-row select[name="wall"],
        .boulder-row select[name="style"],
        .boulder-row select[name="room"] {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: none;
        }
    </style>
</head>
<body class="bg-gray-950 text-slate-300">

    <div id="app" class="container mx-auto pt-0 pb-4 pl-4 pr-4 max-w-7xl">
        
        <!-- Header is hidden by default, shown after data loads -->
        <div id="sticky-container" class="sticky top-0 z-10 bg-gray-950 pt-4 pb-4 hidden">
             <!-- Header -->
            <header id="header-container" class="bg-gray-900 border border-gray-800 rounded-lg shadow-md p-4">
                <div id="header-content" class="flex items-center justify-between">
                    <!-- Header content will be dynamically generated -->
                </div>
            </header>
             <!-- Round Selector Container - only shown on results page -->
            <div id="controls-container" class="hidden mt-4">
                <!-- Content will be rendered here for results page -->
            </div>
        </div>


        <!-- Main Content Area, hidden until data loads -->
        <main id="main-content" class="hidden">
            <!-- Content will be rendered here by JavaScript -->
        </main>

        <!-- Loading / Error Indicator - centered on the screen -->
        <div id="indicator" class="flex flex-col items-center justify-center min-h-screen -mt-20">
            <!-- Content will be set by JavaScript -->
        </div>
    </div>

    <!-- Admin PIN Modal -->
    <div id="pin-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 hidden">
        <div class="bg-gray-900 border border-gray-800 rounded-lg p-8 w-full max-w-sm mx-4">
            <h2 class="text-xl font-bold text-center text-white mb-4">Admin Access</h2>
            <p class="text-center text-gray-400 mb-6">Enter PIN to continue</p>
            <!-- Pin input field modified for custom keypad -->
            <input type="password" id="pin-input" inputmode="none" readonly class="w-full bg-gray-800 border border-gray-700 text-gray-200 rounded-lg p-3 text-center text-2xl tracking-widest focus:outline-none focus:border-blue-500">
            <p id="pin-error" class="text-red-400 text-sm text-center mt-2 h-5"></p>
            
            <!-- Custom Pin Pad -->
            <div id="pin-pad" class="pin-pad-grid">
                <button class="pin-pad-button" data-digit="1">1</button>
                <button class="pin-pad-button" data-digit="2">2</button>
                <button class="pin-pad-button" data-digit="3">3</button>
                <button class="pin-pad-button" data-digit="4">4</button>
                <button class="pin-pad-button" data-digit="5">5</button>
                <button class="pin-pad-button" data-digit="6">6</button>
                <button class="pin-pad-button" data-digit="7">7</button>
                <button class="pin-pad-button" data-digit="8">8</button>
                <button class="pin-pad-button" data-digit="9">9</button>
                <div class="empty-cell"></div> <!-- Empty cell for layout alignment -->
                <button class="pin-pad-button" data-digit="0">0</button>
                <button class="pin-pad-button" data-action="backspace"><i class="fas fa-backspace"></i></button>
            </div>

            <div class="mt-4 flex space-x-4">
                <button id="pin-cancel" class="w-full bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg transition duration-300">Cancel</button>
                <button id="pin-submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300">Enter</button>
            </div>
        </div>
    </div>

    <!-- Generic Confirmation Modal -->
    <div id="confirmation-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 hidden">
        <div class="bg-gray-900 border border-gray-800 rounded-lg p-8 w-full max-w-sm mx-4">
            <h2 id="confirmation-title" class="text-xl font-bold text-center text-white mb-4">Confirm Action</h2>
            <p id="confirmation-message" class="text-center text-gray-400 mb-6">Are you sure?</p>
            <div class="mt-4 flex space-x-4">
                <button id="confirmation-cancel" class="w-full bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg transition duration-300">Cancel</button>
                <button id="confirmation-confirm" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300">Confirm</button>
            </div>
        </div>
    </div>

    <!-- Boulder Images Modal -->
    <div id="boulder-images-modal" class="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50 hidden">
        <button id="close-images-modal-btn" class="absolute top-4 right-4 text-white text-4xl font-bold">&times;</button>
        <div id="boulder-images-container" class="w-full max-w-lg h-full overflow-y-auto p-4 space-y-4">
            <!-- Images will be loaded here -->
        </div>
    </div>

    <script type="module">
        import { renderHomePage } from './js/pages/HomePage.js';
        import { renderResultsHomePage } from './js/pages/ResultsHomePage.js';
        import { renderSchedulePage } from './js/pages/SchedulePage.js';
        import { renderClimbersPage } from './js/pages/ClimbersPage.js';
        import { renderClimberProfilePage } from './js/pages/ClimberProfilePage.js';
        import { renderResultsCompPage } from './js/pages/ResultsCompPage.js';
        import { renderAboutPage } from './js/pages/AboutPage.js';
        import { renderLeaderboardsPage } from './js/pages/LeaderboardsPage.js';
        import { renderRulesPage } from './js/pages/RulesPage.js';
        import { renderRegisterPage } from './js/pages/RegisterPage.js';
        import { renderAdminPage } from './js/pages/AdminPage.js';
        import { renderQualiResultDetailPage, renderQualiCompResultDetailPage } from './js/pages/QualiResultDetailPage.js';
        import { renderSubmitResultsPage } from './js/pages/SubmitResultsPage.js';
        import { renderJudgesAppPage, renderJudgeBoulderPage } from './js/pages/JudgesAppPage.js';
        import { renderManageFinalsPage } from './js/pages/ManageFinalsPage.js';
        import { renderAddQualiBouldersPage } from './js/pages/AddQualiBouldersPage.js';
        import { renderRoutesettingPage } from './js/pages/RoutesettingPage.js';
        import { renderQualiBouldersPage } from './js/pages/QualiBouldersPage.js';
        import { renderBoulderPage } from './js/pages/BoulderPage.js';
        
        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM Elements ---
            const mainContent = document.getElementById('main-content');
            const indicator = document.getElementById('indicator');
            const headerContent = document.getElementById('header-content');
            const headerContainer = document.getElementById('header-container');
            const controlsContainer = document.getElementById('controls-container');
            const stickyContainer = document.getElementById('sticky-container');


            // --- App State ---
            let appData = {};
            
            
            let currentClimberTab = 'profile';
            const ADMIN_PIN = '0306'; 
            
            // --- Centralized Google Apps Script URL ---
            const GOOGLE_APP_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzZ5SsJuEAbosB2omSgUJP4HVD4UXbuQdidkIx6YqGfx02wDGFC8GbnAfcYtFNOQP7Z/exec';

            // --- Data Sources (Simplified) ---
            const GOOGLE_SHEET_URLS = {
                climbers: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQ7-85zdma8XbhoanF6eOYTwlcld3Qg7mJ2xmf2YMY8N2u_Pk2G-6fnDBEPPfIWr0QBKl4bpMX0QX9B/pub?gid=937478252&single=true&output=csv',
                climberAttributesRatings: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQ7-85zdma8XbhoanF6eOYTwlcld3Qg7mJ2xmf2YMY8N2u_Pk2G-6fnDBEPPfIWr0QBKl4bpMX0QX9B/pub?gid=148143674&single=true&output=csv',
                fResults: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQ7-85zdma8XbhoanF6eOYTwlcld3Qg7mJ2xmf2YMY8N2u_Pk2G-6fnDBEPPfIWr0QBKl4bpMX0QX9B/pub?gid=129313170&single=true&output=csv',
                climberStats: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQ7-85zdma8XbhoanF6eOYTwlcld3Qg7mJ2xmf2YMY8N2u_Pk2G-6fnDBEPPfIWr0QBKl4bpMX0QX9B/pub?gid=400895305&single=true&output=csv',
                circuits: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQ7-85zdma8XbhoanF6eOYTwlcld3Qg7mJ2xmf2YMY8N2u_Pk2G-6fnDBEPPfIWr0QBKl4bpMX0QX9B/pub?gid=1285584216&single=true&output=csv',
                comps: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQ7-85zdma8XbhoanF6eOYTwlcld3Qg7mJ2xmf2YMY8N2u_Pk2G-6fnDBEPPfIWr0QBKl4bpMX0QX9B/pub?gid=91525471&single=true&output=csv',
                qStandings: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQ7-85zdma8XbhoanF6eOYTwlcld3Qg7mJ2xmf2YMY8N2u_Pk2G-6fnDBEPPfIWr0QBKl4bpMX0QX9B/pub?gid=687301211&single=true&output=csv',
                qRankings: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQ7-85zdma8XbhoanF6eOYTwlcld3Qg7mJ2xmf2YMY8N2u_Pk2G-6fnDBEPPfIWr0QBKl4bpMX0QX9B/pub?gid=1437828732&single=true&output=csv',
                fRankings: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQ7-85zdma8XbhoanF6eOYTwlcld3Qg7mJ2xmf2YMY8N2u_Pk2G-6fnDBEPPfIWr0QBKl4bpMX0QX9B/pub?gid=1749256148&single=true&output=csv',
                qualis: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQ7-85zdma8XbhoanF6eOYTwlcld3Qg7mJ2xmf2YMY8N2u_Pk2G-6fnDBEPPfIWr0QBKl4bpMX0QX9B/pub?gid=1964387699&single=true&output=csv',
                finals: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQ7-85zdma8XbhoanF6eOYTwlcld3Qg7mJ2xmf2YMY8N2u_Pk2G-6fnDBEPPfIWr0QBKl4bpMX0QX9B/pub?gid=2138071685&single=true&output=csv',
                qLeaderboard: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQ7-85zdma8XbhoanF6eOYTwlcld3Qg7mJ2xmf2YMY8N2u_Pk2G-6fnDBEPPfIWr0QBKl4bpMX0QX9B/pub?gid=1921578576&single=true&output=csv',
                cStandings: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQ7-85zdma8XbhoanF6eOYTwlcld3Qg7mJ2xmf2YMY8N2u_Pk2G-6fnDBEPPfIWr0QBKl4bpMX0QX9B/pub?gid=1940156851&single=true&output=csv',
                perCompGradeStats: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQ7-85zdma8XbhoanF6eOYTwlcld3Qg7mJ2xmf2YMY8N2u_Pk2G-6fnDBEPPfIWr0QBKl4bpMX0QX9B/pub?gid=98853432&single=true&output=csv',
                qBoulders: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQ7-85zdma8XbhoanF6eOYTwlcld3Qg7mJ2xmf2YMY8N2u_Pk2G-6fnDBEPPfIWr0QBKl4bpMX0QX9B/pub?gid=1513683934&single=true&output=csv',
                qBoulderImages: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQ7-85zdma8XbhoanF6eOYTwlcld3Qg7mJ2xmf2YMY8N2u_Pk2G-6fnDBEPPfIWr0QBKl4bpMX0QX9B/pub?gid=710619911&single=true&output=csv',
                qResults: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQ7-85zdma8XbhoanF6eOYTwlcld3Qg7mJ2xmf2YMY8N2u_Pk2G-6fnDBEPPfIWr0QBKl4bpMX0QX9B/pub?gid=36605401&single=true&output=csv',
                fClimbers: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQ7-85zdma8XbhoanF6eOYTwlcld3Qg7mJ2xmf2YMY8N2u_Pk2G-6fnDBEPPfIWr0QBKl4bpMX0QX9B/pub?gid=704595417&single=true&output=csv'
            };

            // --- Utility Functions ---
            
            // START Timezone Standardization
            function getLondonTime() {
                // Returns a new Date object representing the current time in the 'Europe/London' timezone.
                return new Date(new Date().toLocaleString('en-US', { timeZone: 'Europe/London' }));
            }
            // END Timezone Standardization

            async function fetchAndParseSheet(url, isChartData = false) {
                const cacheBustUrl = `${url}&_=${new Date().getTime()}`;
                const response = await fetch(cacheBustUrl);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const text = await response.text();
                if (text.trim().startsWith('<')) throw new Error(`Received an HTML page instead of CSV from ${url}`);

                const lines = text.trim().split(/\r?\n/);
                if (lines.length < 2) return [];

                const parseCsvLine = (line) => {
                    const values = [];
                    let current = '';
                    let inQuotes = false;
                    for (let i = 0; i < line.length; i++) {
                        const char = line[i];
                        if (char === '"' && !inQuotes) {
                            inQuotes = true;
                            continue;
                        }
                        if (char === '"' && inQuotes) {
                            inQuotes = false;
                            continue;
                        }
                        if (char === ',' && !inQuotes) {
                            values.push(current);
                            current = '';
                        } else {
                            current += char;
                        }
                    }
                    values.push(current);
                    return values;
                };

                const headerLine = lines[0];
                const header = parseCsvLine(headerLine).map(h =>
                    h.trim().toLowerCase()
                    .replace(/ %/g, '_pct')
                    .replace(/[\s-]+/g, '_')
                    .replace(/# /g, 'number_of_')
                );

                const data = lines.slice(1).map(line => {
                    if (line.trim() === '') return null;
                    const values = parseCsvLine(line);
                    return header.reduce((obj, nextKey, index) => {
                        obj[nextKey] = (values[index] || '').trim().replace(/%/g, '');
                        return obj;
                    }, {});
                }).filter(Boolean);

                return data;
            }

            async function fetchAndParseClimberStats(url) {
                const cacheBustUrl = `${url}&_=${new Date().getTime()}`;
                const response = await fetch(cacheBustUrl);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const text = await response.text();
                if (text.trim().startsWith('<')) throw new Error(`Received an HTML page instead of CSV from ${url}`);

                const lines = text.trim().split(/\r?\n/);
                if (lines.length < 3) return []; 

                const mainHeader = lines[0].split(',');
                const subHeader = lines[1].split(',');
                const combinedHeader = [];
                let currentMainCategory = '';

                for (let i = 0; i < subHeader.length; i++) {
                    const mainCategoryText = mainHeader[i].trim();
                    if (mainCategoryText) {
                        currentMainCategory = mainCategoryText.toLowerCase().replace(/\s+/g, '_');
                    }
                    
                    const subCategoryText = subHeader[i].trim().toLowerCase().replace('%', '_pct');
                    
                    if (i === 0) {
                        combinedHeader.push('climber');
                    } else {
                        combinedHeader.push(`${currentMainCategory}_${subCategoryText}`);
                    }
                }

                const data = lines.slice(2).map(line => {
                    if (line.trim() === '') return null;
                    const values = line.split(',').map(v => v.trim().replace('%',''));
                    return combinedHeader.reduce((obj, nextKey, index) => {
                        obj[nextKey] = values[index] || '';
                        return obj;
                    }, {});
                }).filter(Boolean);

                return data;
            }
            
            // This function now *only* renders the UI based on the given page and context
            function renderPageContent(page, context = null) {
                window.scrollTo(0, 0); // Always scroll to top when content changes
                mainContent.innerHTML = ''; 
                headerContent.innerHTML = '';
                controlsContainer.innerHTML = '';
                
                headerContainer.style.backgroundColor = '';
                headerContainer.style.border = '';
                headerContainer.style.boxShadow = '';
                headerContainer.classList.add('p-4', 'bg-gray-900', 'border-gray-800', 'rounded-lg', 'shadow-md');

                controlsContainer.classList.add('hidden');

                // Call the appropriate render function based on the page
                switch (page) {
                    case 'home':
                        renderHomePage(headerContent, mainContent, appData, getLondonTime, showPinModal, navigate);
                        break;
                    case 'submitResults':
                        renderSubmitResultsPage(headerContent, mainContent, appData, navigate, getLondonTime, GOOGLE_APP_SCRIPT_URL);
                        break;
                    case 'resultsHome':
                        renderResultsHomePage(headerContent, mainContent, appData, navigate);
                        break;
                    case 'schedule':
                        renderSchedulePage(headerContent, mainContent, appData, navigate, getLondonTime);
                        break;
                    case 'climbers':
                        renderClimbersPage(headerContent, mainContent, appData, navigate);
                        break;
                    case 'climberProfile':
                        renderClimberProfilePage(headerContent, mainContent, controlsContainer, appData, navigate, context, GOOGLE_APP_SCRIPT_URL);
                        break;
                    case 'resultsComp':
                        renderResultsCompPage(headerContent, mainContent, controlsContainer, appData, { navigate: navigate }, context);
                        break;
                    case 'about':
                        renderAboutPage(headerContent, mainContent, { navigate: navigate });
                        break;
                    case 'leaderboards':
                        renderLeaderboardsPage(headerContent, mainContent, controlsContainer, appData, navigate);
                        break;
                    case 'rules':
                        renderRulesPage(headerContent, mainContent, navigate);
                        break;
                    case 'register':
                        renderRegisterPage(headerContent, mainContent, navigate, GOOGLE_APP_SCRIPT_URL, appData);
                        break;
                    case 'admin':
                        renderAdminPage(headerContent, mainContent, navigate);
                        break;
                    case 'judgesApp':
                        renderJudgesAppPage(headerContent, mainContent, appData, navigate, getLondonTime);
                        break;
                    case 'judgeBoulderPage':
                        renderJudgeBoulderPage(headerContent, mainContent, navigate, showConfirmationModal, GOOGLE_APP_SCRIPT_URL, context);
                        break;
                    case 'manageFinals':
                        renderManageFinalsPage(headerContent, mainContent, appData, getLondonTime, showConfirmationModal, GOOGLE_APP_SCRIPT_URL, navigate);
                        break;
                    case 'addBoulders':
                        renderAddQualiBouldersPage(headerContent, mainContent, appData, getLondonTime, showConfirmationModal, GOOGLE_APP_SCRIPT_URL, navigate);
                        break;
                    case 'routesetting':
                        renderRoutesettingPage(headerContent, mainContent, appData, navigate);
                        break;
                    case 'qualiBouldersPage':
                        renderQualiBouldersPage(headerContent, mainContent, appData, navigate, context);
                        break;
                    case 'boulderPage':
                        renderBoulderPage(headerContent, mainContent, appData, navigate, context);
                        break;
                    case 'qualiResultDetail':
                        renderQualiResultDetailPage(headerContent, mainContent, appData, navigate, context);
                        break;
                    case 'qualiCompResultDetail':
                        renderQualiCompResultDetailPage(headerContent, mainContent, appData, navigate, context);
                        break;
                    default:
                        // Fallback, maybe render a 404 or home page
                        renderHomePage();
                        break;
                }
            }

            // New function to handle navigation and browser history
            // Use this function for all internal links/buttons that change the "page" view
            function navigate(page, context = null) {
                // Save the current state before pushing a new one, if needed for popstate to restore scroll
                const currentState = history.state || { page: 'home', context: null, scrollY: 0 };
                history.replaceState({ ...currentState, scrollY: window.scrollY }, '', window.location.hash);

                let hash = `#${page}`;
                switch (page) {
                    case 'climberProfile':
                        if (context && context.climberName) {
                            const encodedClimberName = encodeURIComponent(context.climberName.replace(/ /g, '_'));
                            const tab = context.tab || 'profile';
                            hash = `#${page}/${encodedClimberName}/${tab}`;
                        }
                        break;
                    case 'resultsComp':
                        if (context && context.comp) {
                            const encodedComp = encodeURIComponent(context.comp.replace(/ /g, '_'));
                            const round = context.round ? `/${encodeURIComponent(context.round.replace(/ /g, '_'))}` : '';
                            hash = `#${page}/${encodedComp}${round}`;
                        }
                        break;
                    case 'judgeBoulderPage':
                        if (context && context.final && context.climber && context.boulder) {
                            const encodedFinal = encodeURIComponent(context.final);
                            const encodedClimber = encodeURIComponent(context.climber.replace(/ /g, '_'));
                            const encodedBoulder = encodeURIComponent(context.boulder);
                            hash = `#${page}/${encodedFinal}/${encodedClimber}/${encodedBoulder}`;
                        }
                        break;
                    case 'manageFinals':
                        if (context && context.final) {
                            hash = `#${page}/final=${encodeURIComponent(context.final)}`;
                        }
                        break;
                    case 'qualiBouldersPage':
                        if (context && context.qualiName) {
                            hash = `#${page}/${encodeURIComponent(context.qualiName.replace(/ /g, '_'))}`;
                        }
                        break;
                    case 'boulderPage':
                        if (context && context.qualiName && context.boulderName) {
                            const encodedQualiName = encodeURIComponent(context.qualiName.replace(/ /g, '_'));
                            const encodedBoulderName = encodeURIComponent(context.boulderName.replace(/ /g, '_'));
                            hash = `#${page}/${encodedQualiName}/${encodedBoulderName}`;
                        }
                        break;
                }

                // Push the new state to the browser history
                const newState = { page: page, context: context, scrollY: 0 }; // New page starts at scrollY 0
                history.pushState(newState, '', hash);

                // Then render the new content
                renderPageContent(page, context);
            }

            // --- History API Event Listener ---
            window.addEventListener('popstate', (event) => {
                // When popstate fires (e.g., user presses back button/gesture)
                if (event.state) {
                    // If there's a state object, use it to restore the page
                    const { page, context, scrollY } = event.state;
                    renderPageContent(page, context);
                    // Restore scroll position for the popped state
                    window.scrollTo(0, scrollY || 0); 
                } else {
                    // This case might happen if the initial load was a direct URL without a hash,
                    // or if the user navigated back past the initial history entry.
                    // Fallback to home page if no specific state is found.
                    renderPageContent('home', null);
                    window.scrollTo(0, 0);
                }
            });

            

            function showPinModal() {
                const pinModal = document.getElementById('pin-modal');
                const pinInput = document.getElementById('pin-input');
                const pinError = document.getElementById('pin-error');
                pinInput.value = '';
                pinError.textContent = '';
                pinModal.classList.remove('hidden');
                // Set focus to the input, but it's readonly so it won't show the keyboard
                pinInput.focus();
            }

            // Pin Pad Logic
            const pinPad = document.getElementById('pin-pad');
            const pinInput = document.getElementById('pin-input');
            const pinError = document.getElementById('pin-error');

            if (pinPad) { // Ensure pinPad exists before adding listeners
                pinPad.addEventListener('click', (e) => {
                    if (e.target.classList.contains('pin-pad-button') || e.target.closest('.pin-pad-button')) {
                        const button = e.target.closest('.pin-pad-button');
                        const digit = button.dataset.digit;
                        const action = button.dataset.action;

                        pinError.textContent = ''; // Clear previous error

                        if (digit) {
                            if (pinInput.value.length < ADMIN_PIN.length) { // Limit PIN length
                                pinInput.value += digit;
                            }
                        } else if (action === 'backspace') {
                            pinInput.value = pinInput.value.slice(0, -1);
                        }
                    }
                });
            }

            // Remove native keyboard event listener for Enter key from `pin-input`
            // The submit button click is already handled by `pin-submit`
            // document.getElementById('pin-input').removeEventListener('keydown', ...); 
            // The previous code block for keydown on pin-input is removed.

            document.getElementById('pin-submit').addEventListener('click', () => {
                // Pin input is now controlled by custom keypad
                if (pinInput.value === ADMIN_PIN) {
                    document.getElementById('pin-modal').classList.add('hidden');
                    navigate('admin');
                } else {
                    pinError.textContent = 'Incorrect PIN.';
                    pinInput.value = '';
                }
            });

             document.getElementById('pin-cancel').addEventListener('click', () => {
                 document.getElementById('pin-modal').classList.add('hidden');
             });

            function showConfirmationModal(title, message, onConfirmCallback) {
                const modal = document.getElementById('confirmation-modal');
                const modalTitle = document.getElementById('confirmation-title');
                const modalMessage = document.getElementById('confirmation-message');
                const confirmBtn = document.getElementById('confirmation-confirm');
                const cancelBtn = document.getElementById('confirmation-cancel');

                modalTitle.textContent = title;
                modalMessage.textContent = message;

                // Clone and replace the button to remove old event listeners
                const newConfirmBtn = confirmBtn.cloneNode(true);
                confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);

                const newCancelBtn = cancelBtn.cloneNode(true);
                cancelBtn.parentNode.replaceChild(newCancelBtn, cancelBtn);

                newConfirmBtn.addEventListener('click', () => {
                    onConfirmCallback();
                    modal.classList.add('hidden');
                });

                newCancelBtn.addEventListener('click', () => {
                    modal.classList.add('hidden');
                });

                modal.classList.remove('hidden');
            }

            async function init() {
                indicator.innerHTML = `<i class="fas fa-spinner fa-spin text-4xl text-gray-400"></i><p class="mt-4 text-lg font-medium text-gray-300">Loading All Mockomps Data...</p>`;
                
                try {
                    const dataPromises = Object.entries(GOOGLE_SHEET_URLS).map(([key, url]) => {
                        if (key === 'climberStats') {
                            return fetchAndParseClimberStats(url).then(data => [key, data]);
                        }
                        return fetchAndParseSheet(url).then(data => [key, data]);
                    });

                    const dataEntries = await Promise.all(dataPromises);
                    appData = Object.fromEntries(dataEntries);
                    
                    indicator.remove(); 
                    
                    stickyContainer.classList.remove('hidden');
                    mainContent.classList.remove('hidden');

                    // Initial page load: check URL hash for page and context, otherwise default to 'home'
                    const initialHash = window.location.hash.substring(1); // Remove '#'
                    let initialPage = 'home';
                    let initialContext = null;

                    if (initialHash) {
                        const hashParts = initialHash.split('/');
                        initialPage = hashParts[0];

                        // Parse context based on page type
                        switch (initialPage) {
                            case 'climberProfile':
                                if (hashParts[1]) {
                                    initialContext = {
                                        climberName: decodeURIComponent(hashParts[1]).replace(/_/g, ' '),
                                        from: { page: 'home' } // Default 'from' for direct access
                                    };
                                    if (hashParts[2]) {
                                        initialContext.tab = hashParts[2];
                                    }
                                }
                                break;
                            case 'resultsComp':
                                if (hashParts[1]) {
                                    initialContext = {
                                        comp: decodeURIComponent(hashParts[1]).replace(/_/g, ' '),
                                        from: { page: 'home' }
                                    };
                                    if (hashParts[2]) {
                                        initialContext.round = decodeURIComponent(hashParts[2]).replace(/_/g, ' ');
                                    }
                                }
                                break;
                            case 'judgeBoulderPage':
                                if (hashParts[1] && hashParts[2] && hashParts[3]) {
                                    initialContext = {
                                        final: decodeURIComponent(hashParts[1]),
                                        climber: decodeURIComponent(hashParts[2]).replace(/_/g, ' '),
                                        boulder: decodeURIComponent(hashParts[3])
                                    };
                                }
                                break;
                            case 'manageFinals':
                                if (hashParts[1] && hashParts[1].startsWith('final=')) {
                                    initialContext = { final: decodeURIComponent(hashParts[1].substring('final='.length)) };
                                }
                                break;
                            case 'routesetting':
                                // No specific context to parse for routesetting page currently
                                initialContext = null;
                                break;
                            case 'qualiBouldersPage':
                                if (hashParts[1]) {
                                    initialContext = { qualiName: decodeURIComponent(hashParts[1]).replace(/_/g, ' ') };
                                }
                                break;
                            case 'boulderPage':
                                if (hashParts[1] && hashParts[2]) {
                                    initialContext = {
                                        qualiName: decodeURIComponent(hashParts[1]).replace(/_/g, ' '),
                                        boulderName: decodeURIComponent(hashParts[2]).replace(/_/g, ' ')
                                    };
                                }
                                break;
                        }
                    }

                    // Use replaceState for the very first load to avoid an extra history entry
                    history.replaceState({ page: initialPage, context: initialContext, scrollY: 0 }, '', window.location.hash);
                    renderPageContent(initialPage, initialContext); // Render the initial page

                } catch (error) {
                    console.error("Initialization Error:", error);
                    indicator.innerHTML = `<div class="p-10 bg-red-900/50 border border-red-500/30 text-red-300 rounded-lg"><h2 class="font-bold text-xl text-red-200">Error Loading Data</h2><p class="mt-2 text-sm">${error.message}</p><p class="mt-2 text-xs">Please check the browser console for more details, ensure all Google Sheet GIDs are correct, and that sheets are published.</p></div>`;
                }
            }

            init();
        });
    </script>
</body>
</html>