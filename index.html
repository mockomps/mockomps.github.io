<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mockomps</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- PWA: Web App Manifest -->
    <link rel="manifest" href="/manifest.json">
    <!-- PWA: Apple Specific Meta Tags for iOS Home Screen App -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="/images/icon-192x192.png">
    <!-- Ensure you have a 192x192px icon and a 512x512px icon in an 'images' folder. -->

    <style>
        body { font-family: 'Inter', sans-serif; overflow-x: hidden; }
        /* Custom CSS to hide the scrollbar but keep functionality */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }
        /* Prevents horizontal scroll on a child from affecting the parent page scroll */
        .h-scroll {
            overscroll-behavior-x: contain;
        }
        /* Styles for the new segmented control */
        .segmented-control {
            display: flex;
            width: 100%;
            border-radius: 0.5rem;
            background-color: #374151; /* gray-700 */
            padding: 0.25rem;
        }
        .segmented-control input[type="radio"] {
            display: none; /* Hide the actual radio button */
        }
        .segmented-control label {
            flex: 1;
            padding: 0.5rem 0.25rem;
            text-align: center;
            border-radius: 0.375rem;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out, color 0.2s ease-in-out;
            font-size: 0.875rem; /* text-sm */
            font-weight: 600; /* font-semibold */
        }
        .segmented-control input[type="radio"]:checked + label {
            background-color: #3b82f6; /* blue-600 */
            color: white;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
        }
        .segmented-control label.text-flash { color: #facc15; } /* yellow-400 */
        .segmented-control label.text-top { color: #4ade80; } /* green-400 */
        .segmented-control label.text-zone { color: #60a5fa; } /* blue-400 */
        .segmented-control label.text-nothing { color: #9ca3af; } /* gray-400 */
        .segmented-control input[type="radio"]:checked + label.text-flash,
        .segmented-control input[type="radio"]:checked + label.text-top,
        .segmented-control input[type="radio"]:checked + label.text-zone,
        .segmented-control input[type="radio"]:checked + label.text-nothing {
            color: white;
        }
        /* Ensure disabled buttons have the correct cursor */
        button:disabled {
            cursor: not-allowed;
        }

        /* Custom styles for the pin pad */
        .pin-pad-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.5rem; /* Space between buttons */
            margin-top: 1rem;
        }

        .pin-pad-button {
            background-color: #1f2937; /* gray-800 */
            color: #d1d5db; /* gray-300 */
            padding: 1.5rem;
            border-radius: 0.75rem; /* rounded-xl */
            font-size: 2.25rem; /* text-4xl */
            font-weight: 600; /* font-semibold */
            text-align: center;
            transition: background-color 0.2s ease-in-out;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1), 0 1px 3px rgba(0, 0, 0, 0.08); /* shadow-lg */
        }

        .pin-pad-button:hover {
            background-color: #374151; /* gray-700 */
        }

        .pin-pad-button:active {
            background-color: #4b5563; /* gray-600 */
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        /* Adjust font size for icons like backspace */
        .pin-pad-button .fa-backspace {
            font-size: 1.5rem; /* Adjusted for visual balance */
        }

        /* Specific style for empty cell below 7 */
        .pin-pad-grid .empty-cell {
            visibility: hidden;
        }
    </style>
</head>
<body class="bg-gray-950 text-slate-300">

    <div id="app" class="container mx-auto p-4 max-w-7xl">
        
        <!-- Header is hidden by default, shown after data loads -->
        <div id="sticky-container" class="sticky top-0 z-10 bg-gray-950 pt-4 pb-4 hidden">
             <!-- Header -->
            <header id="header-container" class="bg-gray-900 border border-gray-800 rounded-lg shadow-md p-4">
                <div id="header-content" class="flex items-center justify-between">
                    <!-- Header content will be dynamically generated -->
                </div>
            </header>
             <!-- Round Selector Container - only shown on results page -->
            <div id="controls-container" class="hidden mt-4">
                <!-- Content will be rendered here for results page -->
            </div>
        </div>


        <!-- Main Content Area, hidden until data loads -->
        <main id="main-content" class="hidden">
            <!-- Content will be rendered here by JavaScript -->
        </main>

        <!-- Loading / Error Indicator - centered on the screen -->
        <div id="indicator" class="flex flex-col items-center justify-center min-h-screen -mt-20">
            <!-- Content will be set by JavaScript -->
        </div>
    </div>

    <!-- Admin PIN Modal -->
    <div id="pin-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 hidden">
        <div class="bg-gray-900 border border-gray-800 rounded-lg p-8 w-full max-w-sm mx-4">
            <h2 class="text-xl font-bold text-center text-white mb-4">Admin Access</h2>
            <p class="text-center text-gray-400 mb-6">Enter PIN to continue</p>
            <!-- Pin input field modified for custom keypad -->
            <input type="password" id="pin-input" inputmode="none" readonly class="w-full bg-gray-800 border border-gray-700 text-gray-200 rounded-lg p-3 text-center text-2xl tracking-widest focus:outline-none focus:border-blue-500">
            <p id="pin-error" class="text-red-400 text-sm text-center mt-2 h-5"></p>
            
            <!-- Custom Pin Pad -->
            <div id="pin-pad" class="pin-pad-grid">
                <button class="pin-pad-button" data-digit="1">1</button>
                <button class="pin-pad-button" data-digit="2">2</button>
                <button class="pin-pad-button" data-digit="3">3</button>
                <button class="pin-pad-button" data-digit="4">4</button>
                <button class="pin-pad-button" data-digit="5">5</button>
                <button class="pin-pad-button" data-digit="6">6</button>
                <button class="pin-pad-button" data-digit="7">7</button>
                <button class="pin-pad-button" data-digit="8">8</button>
                <button class="pin-pad-button" data-digit="9">9</button>
                <div class="empty-cell"></div> <!-- Empty cell for layout alignment -->
                <button class="pin-pad-button" data-digit="0">0</button>
                <button class="pin-pad-button" data-action="backspace"><i class="fas fa-backspace"></i></button>
            </div>

            <div class="mt-4 flex space-x-4">
                <button id="pin-cancel" class="w-full bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg transition duration-300">Cancel</button>
                <button id="pin-submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300">Enter</button>
            </div>
        </div>
    </div>

    <!-- Generic Confirmation Modal -->
    <div id="confirmation-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 hidden">
        <div class="bg-gray-900 border border-gray-800 rounded-lg p-8 w-full max-w-sm mx-4">
            <h2 id="confirmation-title" class="text-xl font-bold text-center text-white mb-4">Confirm Action</h2>
            <p id="confirmation-message" class="text-center text-gray-400 mb-6">Are you sure?</p>
            <div class="mt-4 flex space-x-4">
                <button id="confirmation-cancel" class="w-full bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg transition duration-300">Cancel</button>
                <button id="confirmation-confirm" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300">Confirm</button>
            </div>
        </div>
    </div>
    
    <footer class="text-center py-8 text-xs text-gray-600">
        <p>
            powered by 
            <a href="https://instagram.com/saorockclimbing" target="_blank" class="hover:text-gray-400 transition-colors">@saorockclimbing</a> 
            and 
            <a href="https://instagram.com/picoclimbing" target="_blank" class="hover:text-gray-400 transition-colors">@picoclimbing</a>
        </p>
    </footer>

    <script type="module">
        import { renderHomePage } from './js/pages/HomePage.js';
        import { renderResultsHomePage } from './js/pages/ResultsHomePage.js';
        import { renderSchedulePage } from './js/pages/SchedulePage.js';
        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM Elements ---
            const mainContent = document.getElementById('main-content');
            const indicator = document.getElementById('indicator');
            const headerContent = document.getElementById('header-content');
            const headerContainer = document.getElementById('header-container');
            const controlsContainer = document.getElementById('controls-container');
            const stickyContainer = document.getElementById('sticky-container');


            // --- App State ---
            let appData = {};
            let currentComp = null;
            let currentRound = 'qualis';
            let currentLeaderboard = 'qualis';
            let currentClimberTab = 'profile';
            const ADMIN_PIN = '0306'; 
            
            // --- Centralized Google Apps Script URL ---
            const GOOGLE_APP_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzZ5SsJuEAbosB2omSgUJP4HVD4UXbuQdidkIx6YqGfx02wDGFC8GbnAfcYtFNOQP7Z/exec';

            // --- Data Sources (Simplified) ---
            const GOOGLE_SHEET_URLS = {
                climbers: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQ7-85zdma8XbhoanF6eOYTwlcld3Qg7mJ2xmf2YMY8N2u_Pk2G-6fnDBEPPfIWr0QBKl4bpMX0QX9B/pub?gid=937478252&single=true&output=csv',
                climberStats: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQ7-85zdma8XbhoanF6eOYTwlcld3Qg7mJ2xmf2YMY8N2u_Pk2G-6fnDBEPPfIWr0QBKl4bpMX0QX9B/pub?gid=400895305&single=true&output=csv',
                comps: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQ7-85zdma8XbhoanF6eOYTwlcld3Qg7mJ2xmf2YMY8N2u_Pk2G-6fnDBEPPfIWr0QBKl4bpMX0QX9B/pub?gid=91525471&single=true&output=csv',
                qStandings: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQ7-85zdma8XbhoanF6eOYTwlcld3Qg7mJ2xmf2YMY8N2u_Pk2G-6fnDBEPPfIWr0QBKl4bpMX0QX9B/pub?gid=687301211&single=true&output=csv',
                qRankings: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQ7-85zdma8XbhoanF6eOYTwlcld3Qg7mJ2xmf2YMY8N2u_Pk2G-6fnDBEPPfIWr0QBKl4bpMX0QX9B/pub?gid=1437828732&single=true&output=csv',
                fRankings: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQ7-85zdma8XbhoanF6eOYTwlcld3Qg7mJ2xmf2YMY8N2u_Pk2G-6fnDBEPPfIWr0QBKl4bpMX0QX9B/pub?gid=1749256148&single=true&output=csv',
                qualis: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQ7-85zdma8XbhoanF6eOYTwlcld3Qg7mJ2xmf2YMY8N2u_Pk2G-6fnDBEPPfIWr0QBKl4bpMX0QX9B/pub?gid=1964387699&single=true&output=csv',
                finals: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQ7-85zdma8XbhoanF6eOYTwlcld3Qg7mJ2xmf2YMY8N2u_Pk2G-6fnDBEPPfIWr0QBKl4bpMX0QX9B/pub?gid=2138071685&single=true&output=csv',
                qLeaderboard: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQ7-85zdma8XbhoanF6eOYTwlcld3Qg7mJ2xmf2YMY8N2u_Pk2G-6fnDBEPPfIWr0QBKl4bpMX0QX9B/pub?gid=1921578576&single=true&output=csv',
                cStandings: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQ7-85zdma8XbhoanF6eOYTwlcld3Qg7mJ2xmf2YMY8N2u_Pk2G-6fnDBEPPfIWr0QBKl4bpMX0QX9B/pub?gid=1940156851&single=true&output=csv',
                perCompGradeStats: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQ7-85zdma8XbhoanF6eOYTwlcld3Qg7mJ2xmf2YMY8N2u_Pk2G-6fnDBEPPfIWr0QBKl4bpMX0QX9B/pub?gid=98853432&single=true&output=csv',
                qBoulders: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQ7-85zdma8XbhoanF6eOYTwlcld3Qg7mJ2xmf2YMY8N2u_Pk2G-6fnDBEPPfIWr0QBKl4bpMX0QX9B/pub?gid=1513683934&single=true&output=csv',
                qResults: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQ7-85zdma8XbhoanF6eOYTwlcld3Qg7mJ2xmf2YMY8N2u_Pk2G-6fnDBEPPfIWr0QBKl4bpMX0QX9B/pub?gid=36605401&single=true&output=csv',
                fClimbers: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQ7-85zdma8XbhoanF6eOYTwlcld3Qg7mJ2xmf2YMY8N2u_Pk2G-6fnDBEPPfIWr0QBKl4bpMX0QX9B/pub?gid=704595417&single=true&output=csv'
            };

            // --- Utility Functions ---
            
            // START Timezone Standardization
            function getLondonTime() {
                // Returns a new Date object representing the current time in the 'Europe/London' timezone.
                return new Date(new Date().toLocaleString('en-US', { timeZone: 'Europe/London' }));
            }
            // END Timezone Standardization

            async function fetchAndParseSheet(url, isChartData = false) {
                const cacheBustUrl = `${url}&_=${new Date().getTime()}`;
                const response = await fetch(cacheBustUrl);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const text = await response.text();
                if (text.trim().startsWith('<')) throw new Error(`Received an HTML page instead of CSV from ${url}`);
                
                const lines = text.trim().split(/\r?\n/);
                if (lines.length < 2) return [];
                
                const header = lines[0].split(',').map(h => 
                    h.trim().toLowerCase()
                    .replace(/ %/g, '_pct')
                    .replace(/[\s-]+/g, '_')
                    .replace(/# /g, 'number_of_')
                );
                
                const data = lines.slice(1).map(line => {
                    if (line.trim() === '') return null;
                    const values = line.split(',').map(v => v.trim().replace('%',''));
                    return header.reduce((obj, nextKey, index) => {
                        obj[nextKey] = values[index];
                        return obj;
                    }, {});
                }).filter(Boolean);
                
                return data;
            }

            async function fetchAndParseClimberStats(url) {
                const cacheBustUrl = `${url}&_=${new Date().getTime()}`;
                const response = await fetch(cacheBustUrl);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const text = await response.text();
                if (text.trim().startsWith('<')) throw new Error(`Received an HTML page instead of CSV from ${url}`);

                const lines = text.trim().split(/\r?\n/);
                if (lines.length < 3) return []; 

                const mainHeader = lines[0].split(',');
                const subHeader = lines[1].split(',');
                const combinedHeader = [];
                let currentMainCategory = '';

                for (let i = 0; i < subHeader.length; i++) {
                    const mainCategoryText = mainHeader[i].trim();
                    if (mainCategoryText) {
                        currentMainCategory = mainCategoryText.toLowerCase().replace(/\s+/g, '_');
                    }
                    
                    const subCategoryText = subHeader[i].trim().toLowerCase().replace('%', '_pct');
                    
                    if (i === 0) {
                        combinedHeader.push('climber');
                    } else {
                        combinedHeader.push(`${currentMainCategory}_${subCategoryText}`);
                    }
                }

                const data = lines.slice(2).map(line => {
                    if (line.trim() === '') return null;
                    const values = line.split(',').map(v => v.trim().replace('%',''));
                    return combinedHeader.reduce((obj, nextKey, index) => {
                        obj[nextKey] = values[index] || '';
                        return obj;
                    }, {});
                }).filter(Boolean);

                return data;
            }
            
            // This function now *only* renders the UI based on the given page and context
            function renderPageContent(page, context = null) {
                window.scrollTo(0, 0); // Always scroll to top when content changes
                mainContent.innerHTML = ''; 
                headerContent.innerHTML = '';
                controlsContainer.innerHTML = '';
                
                headerContainer.style.backgroundColor = '';
                headerContainer.style.border = '';
                headerContainer.style.boxShadow = '';
                headerContainer.classList.add('p-4', 'bg-gray-900', 'border-gray-800', 'rounded-lg', 'shadow-md');

                controlsContainer.classList.add('hidden');

                // Call the appropriate render function based on the page
                switch (page) {
                    case 'home':
                        renderHomePage(headerContent, mainContent, appData, getLondonTime, showPinModal, navigate);
                        break;
                    case 'submitResults':
                        renderSubmitResultsPage();
                        break;
                    case 'resultsHome':
                        renderResultsHomePage(headerContent, mainContent, appData, navigate);
                        break;
                    case 'schedule':
                        renderSchedulePage(headerContent, mainContent, appData, navigate);
                        break;
                    case 'climbers':
                        renderClimbersPage();
                        break;
                    case 'climberProfile':
                        renderClimberProfilePage(context);
                        break;
                    case 'resultsComp':
                        renderResultsCompPage(context);
                        break;
                    case 'about':
                        renderAboutPage();
                        break;
                    case 'leaderboards':
                        renderLeaderboardsPage();
                        break;
                    case 'rules':
                        renderRulesPage();
                        break;
                    case 'register':
                        renderRegisterPage();
                        break;
                    case 'admin':
                        renderAdminPage();
                        break;
                    case 'judgesApp':
                        renderJudgesAppPage();
                        break;
                    case 'judgeBoulderPage':
                        renderJudgeBoulderPage(context);
                        break;
                    case 'manageFinals':
                        renderManageFinalsPage();
                        break;
                    case 'addBoulders':
                        renderAddBouldersPage();
                        break;
                    case 'qualiResultDetail':
                        renderQualiResultDetailPage(context);
                        break;
                    case 'qualiCompResultDetail':
                        renderQualiCompResultDetailPage(context);
                        break;
                    default:
                        // Fallback, maybe render a 404 or home page
                        renderHomePage();
                        break;
                }
            }

            // New function to handle navigation and browser history
            // Use this function for all internal links/buttons that change the "page" view
            function navigate(page, context = null) {
                // Save the current state before pushing a new one, if needed for popstate to restore scroll
                const currentState = history.state || { page: 'home', context: null, scrollY: 0 };
                history.replaceState({ ...currentState, scrollY: window.scrollY }, '', window.location.hash);

                // Push the new state to the browser history
                const newState = { page: page, context: context, scrollY: 0 }; // New page starts at scrollY 0
                history.pushState(newState, '', `#${page}`); // Use # for simple routing

                // Then render the new content
                renderPageContent(page, context);
            }

            // --- History API Event Listener ---
            window.addEventListener('popstate', (event) => {
                // When popstate fires (e.g., user presses back button/gesture)
                if (event.state) {
                    // If there's a state object, use it to restore the page
                    const { page, context, scrollY } = event.state;
                    renderPageContent(page, context);
                    // Restore scroll position for the popped state
                    window.scrollTo(0, scrollY || 0); 
                } else {
                    // This case might happen if the initial load was a direct URL without a hash,
                    // or if the user navigated back past the initial history entry.
                    // Fallback to home page if no specific state is found.
                    renderPageContent('home', null);
                    window.scrollTo(0, 0);
                }
            });


            
            
            function renderAboutPage() {
                headerContent.innerHTML = `
                    <div class="flex-1">
                           <button id="home-btn" class="flex items-center space-x-2 text-gray-400 hover:text-white font-medium"><i class="fas fa-arrow-left"></i><span class="hidden sm:inline">Back</span></button>
                    </div>
                    <h1 class="text-2xl font-bold text-gray-100 flex-1 text-center">About</h1>
                    <div class="flex-1 text-right">
                        <button id="go-home-btn" class="text-gray-400 hover:text-white"><i class="fas fa-home text-xl"></i></button>
                    </div>`;
                document.getElementById('home-btn').addEventListener('click', () => history.back()); // Use history.back()
                document.getElementById('go-home-btn').addEventListener('click', () => navigate('home'));

                mainContent.innerHTML = `
                    <div class="text-center">
                        <a href="https://instagram.com/mockomps" target="_blank" class="block bg-gray-900 border border-gray-800 p-8 rounded-lg shadow-md hover:shadow-xl hover:bg-gray-800 transition-all duration-200 text-gray-100 font-bold text-2xl"><i class="fab fa-instagram mr-2"></i>Follow us on Instagram</a>
                    </div>`;
            }

            function renderRulesPage() {
                headerContent.innerHTML = `
                    <div class="flex-1">
                           <button id="home-btn" class="flex items-center space-x-2 text-gray-400 hover:text-white font-medium"><i class="fas fa-arrow-left"></i><span class="hidden sm:inline">Back</span></button>
                    </div>
                    <h1 class="text-2xl font-bold text-gray-100 flex-1 text-center">Rules & Format</h1>
                    <div class="flex-1 text-right">
                        <button id="go-home-btn" class="text-gray-400 hover:text-white"><i class="fas fa-home text-xl"></i></button>
                    </div>`;
                document.getElementById('home-btn').addEventListener('click', () => history.back()); // Use history.back()
                document.getElementById('go-home-btn').addEventListener('click', () => navigate('home'));

                mainContent.innerHTML = `
                    <div class="space-y-8 text-gray-300 leading-relaxed">
                        <div>
                            <h2 class="text-xl font-bold text-gray-100 border-b border-gray-700 pb-2 mb-3">1. The Circuit</h2>
                            <p>Mockomps is divided into Circuits (e.g., MC01, MC02). Each Circuit consists of 10 individual Mockomps (M01 through M10 for MC01, M11 through M20 for MC02, and so on), culminating in two final events: the <strong class="text-white">Mockomp Challengers</strong> and the <strong class="text-white">Mockomp Champions</strong> to decide the Circuit Champion.</p>
                        </div>
                        <div>
                            <h2 class="text-xl font-bold text-gray-100 border-b border-gray-700 pb-2 mb-3">2. The Mockomp</h2>
                            <p>A Mockomp is a multi-week competition event held every one to two months at São Rock climbing gym. It is composed of a Qualification Phase and a Final.</p>
                            <div class="space-y-4 mt-4">
                                <div>
                                    <h3 class="font-semibold text-lg text-gray-200">Qualification Phase</h3>
                                    <p>The Qualification Phase consists of 3-5 consecutive Quali Rounds (e.g., M01Q1, M01Q2). A new round begins every Monday at São Rock with a fresh set of 10-15 boulders. Climbers have one week (Monday-Sunday) to attempt them and submit scores.</p>
                                </div>
                                <div>
                                    <h3 class="font-semibold text-lg text-gray-200">Final</h3>
                                    <p>The top 8 climbers with the most Quali Points from that Mockomp's qualification phase advance to Final. The format is 4 boulders with a 4+ minute time limit per boulder. Climbers are held in <strong class="text-white">competitor isolation</strong>, meaning they do not see the boulders being climbed before their turn.</p>
                                    <p class="mt-2"><strong class="text-gray-200">Ranking:</strong> Climbers are ranked based on the following criteria, in order: 1. Most Tops, 2. Fewest Attempts to Top, 3. Most Zones, 4. Fewest Attempts to Zone.</p>
                                </div>
                            </div>
                        </div>
                         <div>
                            <h2 class="text-xl font-bold text-gray-100 border-b border-gray-700 pb-2 mb-3">3. The Circuit Finale</h2>
                            <p>At the end of a 10-Mockomp circuit, two special events determine the ultimate champion.</p>
                            <div class="space-y-4 mt-4">
                                <div>
                                    <h3 class="font-semibold text-lg text-gray-200">Mockomp Challengers</h3>
                                    <ul class="list-disc list-inside space-y-2 mt-2 pl-2">
                                        <li><strong class="text-gray-200">Who:</strong> Open to all climbers who participated in the circuit but did not qualify for a Final in any of the 10 Mockomps.</li>
                                        <li><strong class="text-gray-200">Format:</strong> One qualification week, followed by a Final with the top 8 climbers from that quali. The top 3 finishers from the Challengers Final advance to the Mockomp Champions event.</li>
                                    </ul>
                                </div>
                                <div>
                                    <h3 class="font-semibold text-lg text-gray-200">Mockomp Champions</h3>
                                   <ul class="list-disc list-inside space-y-2 mt-2 pl-2">
                                        <li><strong class="text-gray-200">Who:</strong> All climbers who made it to a Final during the circuit, plus the 3 winners from the Challengers event.</li>
                                        <li><strong class="text-gray-200">Format:</strong> Two qualification weeks, followed by a Grand Final. For the 3 advancing Challengers, their score from the Challengers Quali serves as their score for the first Champions Quali week. All other competitors participate in both quali weeks. The top 8 climbers from the two Champions qualis advance to the Grand Final to decide the Circuit Champion.</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        <div>
                            <h2 class="text-xl font-bold text-gray-100 border-b border-gray-700 pb-2 mb-3">4. Scoring Explained</h2>
                            <div class="space-y-4">
                                <div>
                                    <h3 class="font-semibold text-lg text-gray-200">Qualis Leaderboard Scoring</h3>
                                    <p>Climbers are ranked by their total <strong class="text-white">Quali Points</strong>. Points per boulder are awarded as follows:</p>
                                    <ul class="list-disc list-inside space-y-1 mt-2 pl-2">
                                        <li><strong class="text-yellow-400">Flash:</strong> Points equal to the boulder's grade + 1 bonus point.</li>
                                        <li><strong class="text-green-400">Top (after flash):</strong> Points equal to the boulder's grade.</li>
                                        <li><strong class="text-blue-400">Zone only:</strong> Points equal to half of the boulder's grade.</li>
                                    </ul>
                                </div>
                                <div>
                                    <h3 class="font-semibold text-lg text-gray-200">Finals Leaderboard Scoring</h3>
                                    <p>This leaderboard ranks climbers based on <strong class="text-white">Circuit Points</strong>, which are awarded only in the Finals. The winner receives points equal to the number of participants (e.g., if 8 climbers are in the Final, 1st place gets 8 points). Subsequent places receive one less point each.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }

            function renderRegisterPage() {
                 headerContent.innerHTML = `
                    <div class="flex-1">
                           <button id="home-btn" class="flex items-center space-x-2 text-gray-400 hover:text-white font-medium"><i class="fas fa-arrow-left"></i><span class="hidden sm:inline">Back</span></button>
                    </div>
                    <h1 class="text-2xl font-bold text-gray-100 flex-1 text-center">Sign Up</h1>
                    <div class="flex-1 text-right">
                        <button id="go-home-btn" class="text-gray-400 hover:text-white"><i class="fas fa-home text-xl"></i></button>
                    </div>`;
                 document.getElementById('home-btn').addEventListener('click', () => history.back()); // Use history.back()
                 document.getElementById('go-home-btn').addEventListener('click', () => navigate('home'));

                 const countries = ["Portugal", "Afghanistan", "Albania", "Algeria", "Andorra", "Angola", "Antigua and Barbuda", "Argentina", "Armenia", "Australia", "Austria", "Azerbaijan", "Bahamas", "Bahrain", "Bangladesh", "Barbados", "Belarus", "Belgium", "Belize", "Benin", "Bhutan", "Bolivia", "Bosnia and Herzegovina", "Botswana", "Brazil", "Brunei", "Bulgaria", "Burkina Faso", "Burundi", "Cabo Verde", "Cambodia", "Cameroon", "Canada", "Central African Republic", "Chad", "Chile", "China", "Colombia", "Comoros", "Congo, Democratic Republic of the", "Congo, Republic of the", "Costa Rica", "Cote d'Ivoire", "Croatia", "Cuba", "Cyprus", "Czech Republic", "Denmark", "Djibouti", "Dominica", "Dominican Republic", "Ecuador", "Egypt", "El Salvador", "Equatorial Guinea", "Eritrea", "Estonia", "Eswatini", "Ethiopia", "Fiji", "Finland", "France", "Gabon", "Gambia", "Georgia", "Germany", "Ghana", "Greece", "Grenada", "Guatemala", "Guinea", "Guinea-Bissau", "Guyana", "Haiti", "Honduras", "Hungary", "Iceland", "India", "Indonesia", "Iran", "Iraq", "Ireland", "Israel", "Italy", "Jamaica", "Japan", "Jordan", "Kazakhstan", "Kenya", "Kiribati", "Kosovo", "Kuwait", "Kyrgyzstan", "Laos", "Latvia", "Lebanon", "Lesotho", "Liberia", "Libya", "Liechtenstein", "Lithuania", "Luxembourg", "Madagascar", "Malawi", "Malaysia", "Maldives", "Mali", "Malta", "Marshall Islands", "Mauritania", "Mauritius", "Mexico", "Micronesia", "Moldova", "Monaco", "Mongolia", "Montenegro", "Morocco", "Mozambique", "Myanmar", "Namibia", "Nauru", "Nepal", "Netherlands", "New Zealand", "Nicaragua", "Niger", "Nigeria", "North Korea", "North Macedonia", "Norway", "Oman", "Pakistan", "Palau", "Palestine", "Panama", "Papua New Guinea", "Paraguay", "Peru", "Philippines", "Poland", "Qatar", "Romania", "Russia", "Rwanda", "Saint Kitts and Nevis", "Saint Lucia", "Saint Vincent and the Grenadines", "Samoa", "San Marino", "Sao Tome and Principe", "Saudi Arabia", "Senegal", "Serbia", "Seychelles", "Sierra Leone", "Singapore", "Slovakia", "Slovenia", "Solomon Islands", "Somalia", "South Africa", "South Korea", "South Sudan", "Spain", "Sri Lanka", "Sudan", "Suriname", "Sweden", "Switzerland", "Syria", "Taiwan", "Tajikistan", "Tanzania", "Thailand", "Timor-Leste", "Togo", "Tonga", "Trinidad and Tobago", "Tunisia", "Turkey", "Turkmenistan", "Tuvalu", "Uganda", "Ukraine", "United Arab Emirates", "United Kingdom", "United States", "Uruguay", "Uzbekistan", "Vanuatu", "Vatican City", "Venezuela", "Vietnam", "Yemen", "Zambia", "Zimbabwe"];
                 let countryOptions = countries.map(country => `<option value="${country}" ${country === 'Portugal' ? 'selected' : ''}>${country}</option>`).join('');

                 mainContent.innerHTML = `
                        <div class="max-w-md mx-auto">
                            <form id="registration-form" class="space-y-4">
                                <div>
                                    <label for="Name" class="block text-sm font-medium text-gray-300 mb-1">Name</label>
                                    <input type="text" name="Name" id="Name" placeholder="first and last name" required class="w-full bg-gray-800 border border-gray-700 text-gray-200 rounded-lg p-3 focus:outline-none focus:border-blue-500">
                                </div>
                                <div>
                                    <label for="Date of Birth" class="block text-sm font-medium text-gray-300 mb-1">Date of Birth</label>
                                    <input type="text" name="Date of Birth" id="Date of Birth" placeholder="dd/mm/yyyy" required class="w-full bg-gray-800 border border-gray-700 text-gray-200 rounded-lg p-3 focus:outline-none focus:border-blue-500">
                                </div>
                                <div>
                                    <label for="Country" class="block text-sm font-medium text-gray-300 mb-1">Country</label>
                                    <select name="Country" id="Country" required class="w-full bg-gray-800 border border-gray-700 text-gray-200 rounded-lg p-3 focus:outline-none focus:border-blue-500">
                                        ${countryOptions}
                                    </select>
                                </div>
                                <div>
                                    <label for="Instagram" class="block text-sm font-medium text-gray-300 mb-1">Instagram</label>
                                    <input type="text" name="Instagram" id="Instagram" placeholder="without @" class="w-full bg-gray-800 border border-gray-700 text-gray-200 rounded-lg p-3 focus:outline-none focus:border-blue-500">
                                </div>
                                <div class="pt-2">
                                    <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition duration-300">Sign Up</button>
                                </div>
                            </form>
                            <div id="form-feedback" class="mt-4 text-center"></div>
                        </div>
                    `;

                 const form = document.getElementById('registration-form');
                 const feedback = document.getElementById('form-feedback');
                 
                 form.addEventListener('submit', e => {
                     e.preventDefault();
                     feedback.innerHTML = ``;

                     const nameInput = document.getElementById('Name');
                     const dobInput = document.getElementById('Date of Birth');

                     const dobValue = dobInput.value.trim();
                     if(dobValue) {
                         const datePattern = /^(\d{2})\/(\d{2})\/(\d{4})$/;
                         if (!datePattern.test(dobValue)) {
                             feedback.innerHTML = `<p class="text-red-400">Please enter the date of birth in DD/MM/YYYY format.</p>`;
                             return;
                         }
                        const parts = dobValue.split("/");
                        const day = parseInt(parts[0], 10);
                        const month = parseInt(parts[1], 10);
                        const year = parseInt(parts[2], 10);
                        
                        const date = new Date(year, month - 1, day);
                        if (date.getFullYear() !== year || date.getMonth() + 1 !== month || date.getDate() !== day) {
                            feedback.innerHTML = `<p class="text-red-400">Please enter a valid date.</p>`;
                            return;
                        }
                     }

                     const cleanedName = nameInput.value
                         .trim()
                         .replace(/\s+/g, ' ')
                         .split(' ')
                         .map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())
                         .join(' ');
                     
                     const submitButton = form.querySelector('button[type="submit"]');
                     submitButton.disabled = true;
                     submitButton.innerHTML = `<i class="fas fa-spinner fa-spin mr-2"></i>Submitting...`;
                     
                     const plainFormData = Object.fromEntries(new FormData(form).entries());
                     plainFormData.Name = cleanedName;
                     plainFormData.formType = 'climberRegistration';

                     fetch(GOOGLE_APP_SCRIPT_URL, {
                         method: 'POST',
                         mode: 'no-cors',
                         headers: {
                             'Content-Type': 'application/json',
                         },
                         body: JSON.stringify(plainFormData)
                     })
                     .then(() => {
                         feedback.innerHTML = `<p class="text-green-400">Success! You are now registered.</p>`;
                         form.reset();
                     }).catch(error => {
                         console.error('Error!', error);
                         feedback.innerHTML = `<p class="text-red-400">Error: Submission failed. Please check your connection.</p>`;
                     }).finally(() => {
                         submitButton.disabled = false;
                         submitButton.innerHTML = `Sign Up`;
                     });
                 });
            }
            
            function renderAdminPage() {
                headerContent.innerHTML = `
                    <div class="flex-1">
                        <button id="admin-back-btn" class="flex items-center space-x-2 text-gray-400 hover:text-white font-medium"><i class="fas fa-arrow-left"></i><span class="hidden sm:inline">Back</span></button>
                    </div>
                    <h1 class="text-2xl font-bold text-gray-100 flex-1 text-center">Admin Panel</h1>
                    <div class="flex-1 text-right">
                        <button id="go-home-btn" class="text-gray-400 hover:text-white"><i class="fas fa-home text-xl"></i></button>
                    </div>`;
                document.getElementById('admin-back-btn').addEventListener('click', () => history.back()); // Use history.back()
                document.getElementById('go-home-btn').addEventListener('click', () => navigate('home'));

                mainContent.innerHTML = `
                        <div class="grid grid-cols-1 gap-4 text-center mt-8">
                            <button id="add-quali-boulders-btn" class="bg-gray-900 border border-gray-800 p-8 rounded-lg shadow-md hover:shadow-xl hover:bg-gray-800 transition-all duration-200 text-gray-100 font-bold text-xl">Manage Qualis Boulders</button>
                            <button id="manage-finals-btn" class="bg-gray-900 border border-gray-800 p-8 rounded-lg shadow-md hover:shadow-xl hover:bg-gray-800 transition-all duration-200 text-gray-100 font-bold text-xl">Manage Finals Rosters</button>
                            <button id="judge-finals-btn" class="bg-gray-900 border border-gray-800 p-8 rounded-lg shadow-md hover:shadow-xl hover:bg-gray-800 transition-all duration-200 text-gray-100 font-bold text-xl">Judges App</button>
                        </div>
                `;

                document.getElementById('add-quali-boulders-btn').addEventListener('click', () => navigate('addBoulders'));
                document.getElementById('manage-finals-btn').addEventListener('click', () => navigate('manageFinals'));
                document.getElementById('judge-finals-btn').addEventListener('click', () => navigate('judgesApp'));
            }

            function renderAddBouldersPage() {
                headerContent.innerHTML = `
                    <div class="flex-1">
                        <button id="back-to-admin-btn" class="flex items-center space-x-2 text-gray-400 hover:text-white font-medium"><i class="fas fa-arrow-left"></i><span class="hidden sm:inline">Back</span></button>
                    </div>
                    <h1 class="text-2xl font-bold text-gray-100 flex-1 text-center">Manage Qualis Boulders</h1>
                    <div class="flex-1 text-right">
                        <button id="go-home-btn" class="text-gray-400 hover:text-white"><i class="fas fa-home text-xl"></i></button>
                    </div>`;
                document.getElementById('back-to-admin-btn').addEventListener('click', () => history.back()); // Use history.back()
                document.getElementById('go-home-btn').addEventListener('click', () => navigate('home'));
                
                const now = getLondonTime(); // Use London time
                const liveAndFutureQualis = appData.qualis
                    .filter(q => {
                        const endDate = new Date(new Date(q.date).getTime() + (7 * 24 * 60 * 60 * 1000) + (12 * 60 * 60 * 1000));
                        return endDate >= now;
                    })
                    .sort((a, b) => new Date(b.date) - new Date(a.date));

                const qualiOptions = liveAndFutureQualis.map(q => `<option value="${q.quali}">${q.quali}</option>`).join('');

                const gradeOptions = [1,2,3,4,5,6,7].map(g => `<option value="${g}">${g}</option>`).join('');
                const colorOptions = ["Black", "Blue", "Green", "Mint", "Purple", "Red", "White", "Yellow"].map(c => `<option value="${c}">${c}</option>`).join('');


                mainContent.innerHTML = `
                    <div class="max-w-xl mx-auto">
                        <form id="boulder-form" class="space-y-6">
                            <div>
                                <label for="quali-select" class="block text-sm font-medium text-gray-300 mb-1">Select Quali Round</label>
                                <select id="quali-select" class="w-full bg-gray-800 border border-gray-700 text-gray-200 rounded-lg p-3 focus:outline-none focus:border-blue-500">
                                    <option value="">-- Select a Quali --</option>
                                    ${qualiOptions}
                                </select>
                            </div>
                            <div id="boulder-list" class="space-y-3">
                            </div>
                            <div class="flex justify-between items-center">
                                <button type="button" id="add-boulder-btn" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg transition duration-300">Add Boulder</button>
                                <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg transition duration-300">Submit All Boulders</button>
                            </div>
                        </form>
                        <div id="boulder-form-feedback" class="mt-4 text-center"></div>
                    </div>
                `;

                const boulderList = document.getElementById('boulder-list');
                const qualiSelect = document.getElementById('quali-select');
                
                function addBoulderRow(boulder = {}) {
                    const letter = String.fromCharCode(65 + boulderList.children.length);
                    const row = document.createElement('div');
                    row.className = "boulder-row grid grid-cols-12 gap-2 items-center";
                    row.innerHTML = `
                        <div class="col-span-1 text-center font-bold text-xl text-gray-400">${letter}</div>
                        <div class="col-span-3"><select name="grade" class="w-full bg-gray-800 border border-gray-700 p-2 rounded-md">${gradeOptions}</select></div>
                        <div class="col-span-4"><select name="color" class="w-full bg-gray-800 border border-gray-700 p-2 rounded-md">${colorOptions}</select></div>
                        <div class="col-span-3">
                            <select name="room" class="w-full bg-gray-800 border border-gray-700 p-2 rounded-md">
                                <option>A1</option>
                                <option>A2</option>
                            </select>
                        </div>
                        <div class="col-span-1 text-right">
                            <button type="button" class="remove-boulder-btn text-red-500 hover:text-red-400 text-2xl font-bold">&times;</button>
                        </div>
                    `;
                    boulderList.appendChild(row);

                    if(boulder.grade) row.querySelector('select[name="grade"]').value = boulder.grade;
                    if(boulder.color) row.querySelector('select[name="color"]').value = boulder.color;
                    if(boulder.a) row.querySelector('select[name="room"]').value = boulder.a;

                    row.querySelector('.remove-boulder-btn').addEventListener('click', () => {
                         row.remove();
                         updateBoulderLetters();
                    });
                }
                
                function updateBoulderLetters() {
                    const rows = boulderList.querySelectorAll('.boulder-row');
                    rows.forEach((row, index) => {
                        row.querySelector('div:first-child').textContent = String.fromCharCode(65 + index);
                    });
                }

                function populateBouldersForQuali(qualiName) {
                    boulderList.innerHTML = '';
                    const existingBoulders = appData.qBoulders.filter(b => b.quali === qualiName);

                    if (existingBoulders.length > 0) {
                        existingBoulders.forEach(boulder => addBoulderRow(boulder));
                    } else {
                        for(let i=0; i<5; i++) {
                            addBoulderRow();
                        }
                    }
                }
                
                qualiSelect.addEventListener('change', (e) => {
                    const selectedQuali = e.target.value;
                    if(selectedQuali) {
                        populateBouldersForQuali(selectedQuali);
                    } else {
                        boulderList.innerHTML = '';
                    }
                });


                document.getElementById('add-boulder-btn').addEventListener('click', () => {
                    addBoulderRow();
                });
                
                const boulderForm = document.getElementById('boulder-form');
                const boulderFeedback = document.getElementById('boulder-form-feedback');

                boulderForm.addEventListener('submit', e => {
                    e.preventDefault();
                    
                    showConfirmationModal('Confirm Changes', 'Are you sure you want to save these boulders?', () => {
                        boulderFeedback.innerHTML = '';
                        
                        const qualiName = document.getElementById('quali-select').value;
                         if (!qualiName) {
                             boulderFeedback.innerHTML = `<p class="text-red-400">Please select a Quali round first.</p>`;
                             return;
                         }

                        const boulders = [];
                        const rows = boulderList.querySelectorAll('.boulder-row');
                        
                        rows.forEach((row, index) => {
                            const grade = row.querySelector('select[name="grade"]').value;
                            const color = row.querySelector('select[name="color"]').value;
                            const room = row.querySelector('select[name="room"]').value;

                            boulders.push({
                                Name: String.fromCharCode(65 + index),
                                Grade: grade,
                                Color: color,
                                A: room
                            });
                        });
                        
                        const payload = {
                            formType: 'addBoulders',
                            quali: qualiName,
                            boulders: boulders
                        };
                        
                        const submitButton = boulderForm.querySelector('button[type="submit"]');
                        submitButton.disabled = true;
                        submitButton.innerHTML = `<i class="fas fa-spinner fa-spin mr-2"></i>Submitting...`;
                        
                        fetch(GOOGLE_APP_SCRIPT_URL, {
                            method: 'POST',
                            mode: 'no-cors',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify(payload)
                        })
                        .then(() => {
                            boulderFeedback.innerHTML = `<p class="text-green-400">Success! Boulders for ${qualiName} have been updated.</p>`;
                        })
                        .catch(error => {
                            console.error('Error!', error);
                            boulderFeedback.innerHTML = `<p class="text-red-400">Error: Submission failed. Please check your connection.</p>`;
                        })
                         .finally(() => {
                             submitButton.disabled = false;
                             submitButton.innerHTML = `Submit All Boulders`;
                         });
                    });
                });
            }

            function showPinModal() {
                const pinModal = document.getElementById('pin-modal');
                const pinInput = document.getElementById('pin-input');
                const pinError = document.getElementById('pin-error');
                pinInput.value = '';
                pinError.textContent = '';
                pinModal.classList.remove('hidden');
                // Set focus to the input, but it's readonly so it won't show the keyboard
                pinInput.focus();
            }

            // Pin Pad Logic
            const pinPad = document.getElementById('pin-pad');
            const pinInput = document.getElementById('pin-input');
            const pinError = document.getElementById('pin-error');

            if (pinPad) { // Ensure pinPad exists before adding listeners
                pinPad.addEventListener('click', (e) => {
                    if (e.target.classList.contains('pin-pad-button') || e.target.closest('.pin-pad-button')) {
                        const button = e.target.closest('.pin-pad-button');
                        const digit = button.dataset.digit;
                        const action = button.dataset.action;

                        pinError.textContent = ''; // Clear previous error

                        if (digit) {
                            if (pinInput.value.length < ADMIN_PIN.length) { // Limit PIN length
                                pinInput.value += digit;
                            }
                        } else if (action === 'backspace') {
                            pinInput.value = pinInput.value.slice(0, -1);
                        }
                    }
                });
            }

            // Remove native keyboard event listener for Enter key from `pin-input`
            // The submit button click is already handled by `pin-submit`
            // document.getElementById('pin-input').removeEventListener('keydown', ...); 
            // The previous code block for keydown on pin-input is removed.

            document.getElementById('pin-submit').addEventListener('click', () => {
                // Pin input is now controlled by custom keypad
                if (pinInput.value === ADMIN_PIN) {
                    document.getElementById('pin-modal').classList.add('hidden');
                    navigate('admin');
                } else {
                    pinError.textContent = 'Incorrect PIN.';
                    pinInput.value = '';
                }
            });

             document.getElementById('pin-cancel').addEventListener('click', () => {
                 document.getElementById('pin-modal').classList.add('hidden');
             });

            function showConfirmationModal(title, message, onConfirmCallback) {
                const modal = document.getElementById('confirmation-modal');
                const modalTitle = document.getElementById('confirmation-title');
                const modalMessage = document.getElementById('confirmation-message');
                const confirmBtn = document.getElementById('confirmation-confirm');
                const cancelBtn = document.getElementById('confirmation-cancel');

                modalTitle.textContent = title;
                modalMessage.textContent = message;

                // Clone and replace the button to remove old event listeners
                const newConfirmBtn = confirmBtn.cloneNode(true);
                confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);

                const newCancelBtn = cancelBtn.cloneNode(true);
                cancelBtn.parentNode.replaceChild(newCancelBtn, cancelBtn);

                newConfirmBtn.addEventListener('click', () => {
                    onConfirmCallback();
                    modal.classList.add('hidden');
                });

                newCancelBtn.addEventListener('click', () => {
                    modal.classList.add('hidden');
                });

                modal.classList.remove('hidden');
            }


            
            
            
            
            function renderClimbersPage() {
                headerContent.innerHTML = `
                    <div class="flex-1">
                        <button id="home-btn" class="flex items-center space-x-2 text-gray-400 hover:text-white font-medium"><i class="fas fa-arrow-left"></i><span class="hidden sm:inline">Back</span></button>
                    </div>
                    <h1 class="text-2xl font-bold text-gray-100 flex-1 text-center">Climbers</h1>
                    <div class="flex-1 text-right">
                        <button id="go-home-btn" class="text-gray-400 hover:text-white"><i class="fas fa-home text-xl"></i></button>
                    </div>`;
                document.getElementById('home-btn').addEventListener('click', () => history.back()); // Use history.back()
                document.getElementById('go-home-btn').addEventListener('click', () => navigate('home'));

                mainContent.innerHTML = `
                    <div class="mb-4">
                        <input type="text" id="climber-search" placeholder="Search for a climber..." class="w-full bg-gray-800 border border-gray-700 text-gray-200 rounded-lg p-3 focus:outline-none focus:border-gray-700">
                    </div>
                    <div id="climber-list-container" class="space-y-2"></div>
                `;

                const climbers = [...appData.climbers].sort((a, b) => a.name.localeCompare(b.name));
                const listContainer = document.getElementById('climber-list-container');

                function renderClimberList(filteredClimbers) {
                    listContainer.innerHTML = '';
                    if (filteredClimbers.length === 0) {
                        listContainer.innerHTML = `<p class="text-gray-400 text-center">No climbers found.</p>`;
                        return;
                    }

                    let climberListHTML = '';
                    filteredClimbers.forEach(climber => {
                        if (climber.name) {
                            climberListHTML += `<button data-climber-name="${climber.name}" class="climber-btn w-full text-left bg-gray-900 border border-gray-800 p-4 rounded-lg shadow-sm text-gray-100 font-semibold hover:bg-gray-800 flex justify-between items-center">
                                                            <span>${climber.name}</span>
                                                            <i class="fas fa-chevron-right text-gray-500"></i>
                                                        </button>`;
                        }
                    });
                    listContainer.innerHTML = climberListHTML;

                    listContainer.querySelectorAll('.climber-btn').forEach(btn => {
                        btn.addEventListener('click', e => {
                            const climberName = e.currentTarget.dataset.climberName;
                            navigate('climberProfile', {
                                climberName: climberName,
                                from: { page: 'climbers' }
                            });
                        });
                    });
                }

                renderClimberList(climbers);

                document.getElementById('climber-search').addEventListener('input', (e) => {
                    const searchTerm = e.target.value.toLowerCase();
                    const filtered = climbers.filter(climber => climber.name && climber.name.toLowerCase().includes(searchTerm));
                    renderClimberList(filtered);
                });
            }

            // --- New Climber Profile Functions ---

            function renderClimberProfilePage(context) {
                const { climberName, from, tab } = context;
                currentClimberTab = tab || 'profile';

                headerContent.innerHTML = `
                    <div class="flex-1">
                        <button id="back-btn" class="flex items-center space-x-2 text-gray-400 hover:text-white font-medium"><i class="fas fa-arrow-left"></i><span class="hidden sm:inline">Back</span></button>
                    </div>
                    <h1 class="text-2xl font-bold text-gray-100 flex-1 text-center">${climberName}</h1>
                    <div class="flex-1 text-right">
                        <button id="go-home-btn" class="text-gray-400 hover:text-white"><i class="fas fa-home text-xl"></i></button>
                    </div>`;
                
                document.getElementById('back-btn').addEventListener('click', () => {
                    history.back(); // Use history.back() for this back button
                });
                document.getElementById('go-home-btn').addEventListener('click', () => navigate('home'));

                controlsContainer.classList.remove('hidden');
                controlsContainer.innerHTML = `<div class="flex justify-center">
                    <div id="climber-profile-selector" class="inline-flex bg-gray-800 p-1 rounded-md gap-1 overflow-x-auto no-scrollbar h-scroll">
                        <button data-tab="profile" class="climber-tab-btn whitespace-nowrap text-gray-300 font-semibold py-1 px-4 rounded-md">Profile</button>
                        <button data-tab="progress" class="climber-tab-btn whitespace-nowrap text-gray-300 font-semibold py-1 px-4 rounded-md">Progress</button>
                        <button data-tab="history" class="climber-tab-btn whitespace-nowrap text-gray-300 font-semibold py-1 px-4 rounded-md">History</button>
                    </div>
                </div>`;
                
                mainContent.innerHTML = `<div id="climber-tab-content"></div>`;

                function setActiveClimberTab() {
                    document.querySelectorAll('.climber-tab-btn').forEach(btn => {
                        const isSelected = btn.dataset.tab === currentClimberTab;
                        btn.classList.toggle('bg-blue-600', isSelected);
                        btn.classList.toggle('text-white', isSelected);
                        btn.classList.toggle('shadow-md', isSelected);
                        btn.classList.toggle('text-gray-300', !isSelected);
                    });
                }

                setActiveClimberTab();
                renderClimberTabContent(climberName, context);

                document.getElementById('climber-profile-selector').addEventListener('click', e => {
                    if (e.target.tagName === 'BUTTON' && e.target.dataset.tab !== currentClimberTab) {
                        currentClimberTab = e.target.dataset.tab;
                        // For tab changes, we replace state to keep a clean history within profile view
                        history.replaceState({ page: 'climberProfile', context: { ...context, tab: currentClimberTab } }, '', window.location.hash);
                        setActiveClimberTab();
                        renderClimberTabContent(climberName, context);
                    }
                });
            }

            function renderClimberTabContent(climberName, profilePageContext) {
                const container = document.getElementById('climber-tab-content');
                container.innerHTML = '';
                if (currentClimberTab === 'profile') {
                    renderClimberProfile_ProfileTab(container, climberName);
                } else if (currentClimberTab === 'progress') {
                    renderClimberProfile_ProgressTab(container, climberName);
                } else if (currentClimberTab === 'history') {
                    renderClimberProfile_HistoryTab(container, climberName, profilePageContext);
                }
            }

            function renderClimberProfile_ProfileTab(container, climberName) {
                const climberInfo = appData.climbers.find(c => c.name === climberName);
                const climberStats = appData.climberStats.find(s => s.climber === climberName);

                let profileHTML = '<div class="space-y-4">';

                if (climberInfo) {
                    let instaHTML = '';
                    if (climberInfo.instagram && climberInfo.instagram !== 'N/A') {
                        const handle = climberInfo.instagram.replace(/^@/, '');
                        instaHTML = `<a href="https://instagram.com/${handle}" target="_blank" class="text-blue-400 hover:underline">@${handle}</a>`;
                    }
                    profileHTML += `
                        <div class="bg-gray-900 border border-gray-800 rounded-lg shadow-md p-4">
                            <h2 class="text-xl font-bold text-gray-100 mb-2">${climberInfo.name}</h2>
                            <div class="text-sm space-y-1 text-gray-300">
                                <p><span class="font-semibold text-gray-400">Country:</span> ${climberInfo.country || 'N/A'}</p>
                                <p><span class="font-semibold text-gray-400">Born:</span> ${climberInfo.date_of_birth || 'N/A'}</p>
                                <p><span class="font-semibold text-gray-400">Instagram:</span> ${instaHTML || 'N/A'}</p>
                            </div>
                        </div>`;
                }

                if (climberStats) {
                    profileHTML += `
                        <div class="bg-gray-900 border border-gray-800 rounded-lg shadow-md p-4">
                            <h3 class="text-lg font-bold text-gray-200 mb-3">All-Time Stats</h3>
                            <div class="grid grid-cols-2 sm:grid-cols-5 gap-4 text-center">
                                <div class="bg-gray-800/50 p-2 rounded-md"><div class="text-xs text-gray-400">Qualis</div><div class="font-bold text-xl text-gray-100">${climberStats.all_time_q || '0'}</div></div>
                                <div class="bg-gray-800/50 p-2 rounded-md"><div class="text-xs text-gray-400">Boulders</div><div class="font-bold text-xl text-gray-100">${climberStats.all_time_b || '0'}</div></div>
                                <div class="bg-gray-800/50 p-2 rounded-md"><div class="text-xs text-gray-400">Flashes</div><div class="font-bold text-xl text-gray-100">${climberStats.all_time_f || '0'}</div></div>
                                <div class="bg-gray-800/50 p-2 rounded-md"><div class="text-xs text-gray-400">Tops</div><div class="font-bold text-xl text-gray-100">${climberStats.all_time_t || '0'}</div></div>
                                <div class="bg-gray-800/50 p-2 rounded-md"><div class="text-xs text-gray-400">Zones</div><div class="font-bold text-xl text-gray-100">${climberStats.all_time_z || '0'}</div></div>
                            </div>
                        </div>`;

                    const createGradeStatBox = (grade, stats) => {
                        return `
                        <div class="bg-gray-900 border border-gray-800 rounded-lg shadow-md p-4">
                            <h3 class="text-lg font-bold text-gray-200 mb-3">Grade ${grade} Stats</h3>
                            <div class="grid grid-cols-2 sm:grid-cols-4 gap-4 text-center">
                                <div class="bg-gray-800/50 p-2 rounded-md"><div class="text-xs text-gray-400">Boulders</div><div class="font-bold text-xl text-gray-100">${stats[`grade_${grade}_b`] || '0'}</div></div>
                                <div class="bg-gray-800/50 p-2 rounded-md"><div class="text-xs text-gray-400">Flashes</div><div class="font-bold text-xl text-gray-100">${stats[`grade_${grade}_f`] || '0'}</div></div>
                                <div class="bg-gray-800/50 p-2 rounded-md"><div class="text-xs text-gray-400">Tops</div><div class="font-bold text-xl text-gray-100">${stats[`grade_${grade}_t`] || '0'}</div></div>
                                <div class="bg-gray-800/50 p-2 rounded-md"><div class="text-xs text-gray-400">Tops %</div><div class="font-bold text-xl text-gray-100">${stats[`grade_${grade}_t_pct`] || '0%'}</div></div>
                            </div>
                        </div>`;
                    };

                    profileHTML += `<div class="grid grid-cols-1 lg:grid-cols-2 gap-4">`;
                    profileHTML += createGradeStatBox(3, climberStats);
                    profileHTML += createGradeStatBox(4, climberStats);
                    profileHTML += createGradeStatBox(5, climberStats);
                    profileHTML += createGradeStatBox(6, climberStats);
                    profileHTML += `</div>`;
                } else if (!climberInfo) {
                    profileHTML += `<div class="bg-gray-900 border border-gray-800 p-6 rounded-lg shadow-md text-center text-gray-400">No profile information available for this climber.</div>`;
                }
                
                profileHTML += '</div>';
                container.innerHTML = profileHTML;
            }

            function renderClimberProfile_ProgressTab(container, climberName) {
                const climberData = appData.perCompGradeStats.filter(d => d.climber === climberName);
                
                if (climberData.length === 0) {
                    container.innerHTML = `<div class="bg-gray-900 border border-gray-800 p-6 rounded-lg shadow-md text-center text-gray-400">No progress data available for this climber.</div>`;
                    return;
                }
                
                const gradeColors = {
                    '3': '#facc15', // yellow-400
                    '4': '#fb923c', // orange-400
                    '5': '#f87171', // red-400
                    '6': '#c084fc', // purple-400
                };

                let legendHTML = '<div class="flex flex-wrap justify-center gap-x-4 gap-y-2 mb-4">';
                for (const grade in gradeColors) {
                    legendHTML += `<div class="flex items-center space-x-2 text-sm">
                        <div class="w-3 h-3 rounded-full" style="background-color: ${gradeColors[grade]}"></div>
                        <span class="text-gray-400">Grade ${grade}</span>
                    </div>`;
                }
                legendHTML += '</div>';

                container.innerHTML = `<div>
                    ${legendHTML}
                    <div class="space-y-6">
                        <div>
                            <h3 class="text-base font-semibold text-gray-200 text-center mb-2">Top Percentage</h3>
                            <div class="bg-gray-900 border border-gray-800 p-3 rounded-lg shadow-sm"><canvas id="topsChart"></canvas></div>
                        </div>
                        <div>
                            <h3 class="text-base font-semibold text-gray-200 text-center mb-2">Zone Percentage</h3>
                            <div class="bg-gray-900 border border-gray-800 p-3 rounded-lg shadow-sm"><canvas id="zonesChart"></canvas></div>
                        </div>
                        <div>
                            <h3 class="text-base font-semibold text-gray-200 text-center mb-2">Flash Percentage</h3>
                            <div class="bg-gray-900 border border-gray-800 p-3 rounded-lg shadow-sm"><canvas id="flashesChart"></canvas></div>
                        </div>
                        <div>
                            <h3 class="text-base font-semibold text-gray-200 text-center mb-2">Qualis Placement</h3>
                            <div class="bg-gray-900 border border-gray-800 p-3 rounded-lg shadow-sm"><canvas id="qualiPlacementChart"></canvas></div>
                        </div>
                         <div id="final-placement-chart-container"></div>
                    </div>
                </div>`;

                const climberComps = [...new Set(climberData.map(d => d.comp))].sort();

                const createPercentageChart = (canvasId, statKey) => {
                    const isMobile = window.innerWidth <= 768;
                    const datasets = Object.keys(gradeColors).map(grade => {
                        const data = climberComps.map(comp => {
                            const record = climberData.find(d => d.comp === comp && d.grade === grade);
                            return record ? parseFloat(record[statKey]) : null;
                        });
                        return {
                            label: `Grade ${grade}`,
                            data: data,
                            borderColor: gradeColors[grade],
                            backgroundColor: gradeColors[grade],
                            fill: false,
                            tension: 0.1,
                            spanGaps: true,
                            borderWidth: isMobile ? 1.5 : 2.5,
                            pointRadius: isMobile ? 2.5 : 3.5,
                            clip: false
                        };
                    });

                    new Chart(document.getElementById(canvasId), {
                        type: 'line',
                        data: {
                            labels: climberComps,
                            datasets: datasets
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: true,
                            layout: { padding: { top: 10 } },
                            plugins: {
                                title: { display: false },
                                legend: { display: false }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    max: 100,
                                    ticks: { 
                                        color: '#94a3b8', 
                                        stepSize: 20,
                                        callback: value => value + '%' 
                                    },
                                    grid: { color: 'rgba(55, 65, 81, 0.5)', drawBorder: false }
                                },
                                x: {
                                    ticks: { color: '#94a3b8', autoSkip: true, maxRotation: 0, minRotation: 0, font: {size: 10} },
                                    grid: { display: false }
                                }
                            }
                        }
                    });
                };

                const createPlacementChart = (canvasId, data, color) => {
                    const isMobile = window.innerWidth <= 768;
                    
                    const labels = data.map(d => d.comp || (d.final || '').replace(/F$/, ''));
                    const placementData = data.map(d => parseInt(d.place));

                    new Chart(document.getElementById(canvasId), {
                        type: 'line',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: 'Placement',
                                data: placementData,
                                borderColor: color,
                                backgroundColor: color,
                                fill: false,
                                tension: 0.1,
                                spanGaps: true,
                                borderWidth: isMobile ? 1.5 : 2.5,
                                pointRadius: isMobile ? 2.5 : 3.5,
                                clip: false
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: true,
                            layout: { padding: { top: 10 } },
                            plugins: {
                                title: { display: false },
                                legend: { display: false }
                            },
                            scales: {
                                y: {
                                    reverse: true,
                                    beginAtZero: false,
                                    ticks: {
                                        color: '#94a3b8',
                                        stepSize: 1
                                    },
                                    grid: { color: 'rgba(55, 65, 81, 0.5)', drawBorder: false }
                                },
                                x: {
                                    ticks: { color: '#94a3b8', autoSkip: true, maxRotation: 0, minRotation: 0, font: {size: 10} },
                                    grid: { display: false }
                                }
                            }
                        }
                    });
                }

                createPercentageChart('topsChart', 'top_pct');
                createPercentageChart('zonesChart', 'zone_pct');
                createPercentageChart('flashesChart', 'flash_pct');

                const qualiPlacements = appData.qStandings
                    .filter(s => s.climber === climberName)
                    .sort((a,b) => a.comp.localeCompare(b.comp));
                if (qualiPlacements.length > 0) {
                        createPlacementChart('qualiPlacementChart', qualiPlacements, '#38bdf8');
                }

                const finalPlacements = appData.fRankings
                    .filter(s => s.climber === climberName)
                    .sort((a,b) => a.final.localeCompare(b.final));
                if (finalPlacements.length > 0) {
                    document.getElementById('final-placement-chart-container').innerHTML = `
                        <div>
                            <h3 class="text-base font-semibold text-gray-200 text-center mb-2">Final Placement</h3>
                            <div class="bg-gray-900 border border-gray-800 p-3 rounded-lg shadow-sm"><canvas id="finalPlacementChart"></canvas></div>
                        </div>
                    `;
                    createPlacementChart('finalPlacementChart', finalPlacements, '#4ade80');
                }
            }

            function getOrdinal(n) {
                if (isNaN(n) || n === null || n === '') return n;
                const num = parseInt(n, 10);
                if (isNaN(num)) return n;
                const s = ["th", "st", "nd", "rd"];
                const v = num % 100;
                return num + (s[(v - 20) % 10] || s[v] || s[0]);
            }

            function renderClimberProfile_HistoryTab(container, climberName, profilePageContext) {
                const compDateMap = new Map(appData.comps.map(c => [c.comp, new Date(c.start)]));
                const historyByComp = Object.create(null);

                appData.qStandings
                    .filter(s => s.climber === climberName)
                    .forEach(s => {
                        if (s.comp) {
                            if (!historyByComp[s.comp]) {
                                historyByComp[s.comp] = { date: compDateMap.get(s.comp) || new Date(0), results: [] };
                            }
                            historyByComp[s.comp].results.push(`<span class="text-gray-400 font-semibold">Qualis</span> <strong class="text-white">${getOrdinal(s.place)} place</strong>`);
                        }
                    });

                appData.fRankings
                    .filter(s => s.climber === climberName)
                    .forEach(s => {
                        const compName = (s.final || '').replace(/F$/, '');
                         if (compName) {
                            if (!historyByComp[compName]) {
                                historyByComp[compName] = { date: compDateMap.get(compName) || new Date(0), results: [] };
                            }
                            historyByComp[compName].results.push(`<span class="text-cyan-400 font-semibold">Finals</span> <strong class="text-white">${getOrdinal(s.place)} place</strong>`);
                        }
                    });
                
                const sortedHistory = Object.entries(historyByComp).sort(([, a], [, b]) => b.date - a.date);

                if (sortedHistory.length === 0) {
                    container.innerHTML = `<div class="bg-gray-900 border border-gray-800 p-6 rounded-lg shadow-md text-center text-gray-400">No competition history found.</div>`;
                    return;
                }

                let historyHTML = '<div class="space-y-4">';
                sortedHistory.forEach(([compName, data]) => {
                    historyHTML += `<div class="bg-gray-900 border border-gray-800 p-4 rounded-lg shadow-sm">
                        <button data-comp="${compName}" class="history-comp-link font-bold text-lg text-left text-gray-100 mb-2 hover:text-blue-400">${compName}</button>
                        <div class="space-y-1 text-gray-200">`;
                    data.results.forEach(resultText => {
                        historyHTML += `<p>${resultText}</p>`;
                    });
                    historyHTML += `</div></div>`;
                });
                historyHTML += '</div>';
                container.innerHTML = historyHTML;

                container.querySelectorAll('.history-comp-link').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const compName = e.currentTarget.dataset.comp;
                        const newFromContext = {
                            ...profilePageContext,
                            tab: 'history'
                        };
                        navigate('resultsComp', {
                            comp: compName,
                            from: { page: 'climberProfile', context: newFromContext }
                        });
                    });
                });
            }


            // --- Results & Leaderboards ---

            function renderResultsCompPage(context) {
                const pageContext = context;
                currentComp = pageContext.comp;
                currentRound = pageContext.round || 'qualis';
                const from = pageContext.from || { page: 'resultsHome' };

                headerContent.innerHTML = `
                    <div class="flex-1">
                        <button id="back-to-comps-btn" class="flex items-center space-x-2 text-gray-400 hover:text-white font-medium"><i class="fas fa-arrow-left"></i><span class="hidden sm:inline">Back</span></button>
                    </div>
                    <h1 class="text-2xl font-bold text-gray-100 flex-1 text-center">${currentComp}</h1>
                    <div class="flex-1 text-right">
                        <button id="go-home-btn" class="text-gray-400 hover:text-white"><i class="fas fa-home text-xl"></i></button>
                    </div>`;
                document.getElementById('back-to-comps-btn').addEventListener('click', () => history.back()); // Use history.back()
                document.getElementById('go-home-btn').addEventListener('click', () => navigate('home'));
                
                const individualQualiRounds = [...new Set(appData.qRankings
                    .filter(r => r.quali && r.quali.startsWith(currentComp))
                    .map(r => r.quali)
                )].sort();

                let roundButtonsHTML = '';
                individualQualiRounds.forEach(roundName => {
                    const shortName = roundName.replace(currentComp, '');
                    roundButtonsHTML += `<button data-round="${roundName}" class="round-btn whitespace-nowrap text-gray-300 font-semibold py-1 px-4 rounded-md">${shortName}</button>`;
                });
                
                roundButtonsHTML += `<button data-round="qualis" class="round-btn whitespace-nowrap text-gray-300 font-semibold py-1 px-4 rounded-md">Qualis</button>`;
                roundButtonsHTML += `<button data-round="finals" class="round-btn whitespace-nowrap text-gray-300 font-semibold py-1 px-4 rounded-md">Final</button>`;
                
                controlsContainer.classList.remove('hidden');
                 controlsContainer.innerHTML = `<div class="flex justify-center">
                        <div id="round-selector" class="inline-flex bg-gray-800 p-1 rounded-md gap-1 overflow-x-auto no-scrollbar h-scroll">
                                ${roundButtonsHTML}
                        </div>
                   </div>`;

                mainContent.innerHTML = `<div id="results-container" class="w-full"></div>`;
                
                function setActiveRoundButton() {
                    document.querySelectorAll('.round-btn').forEach(btn => {
                        const isSelected = btn.dataset.round === currentRound;
                        btn.classList.toggle('bg-blue-600', isSelected);
                        btn.classList.toggle('text-white', isSelected);
                        btn.classList.toggle('shadow-md', isSelected);
                        btn.classList.toggle('text-gray-300', !isSelected);
                    });
                }
                
                setActiveRoundButton();
                renderResultsTable(pageContext);

                document.getElementById('round-selector').addEventListener('click', (e) => {
                    if (e.target.tagName === 'BUTTON' && e.target.dataset.round !== currentRound) {
                        currentRound = e.target.dataset.round;
                        pageContext.round = currentRound;
                        // Replace state when changing tabs/rounds within the same competition view
                        history.replaceState({ page: 'resultsComp', context: pageContext }, '', window.location.hash);
                        setActiveRoundButton();
                        renderResultsTable(pageContext);
                   }
                });
            }
            
            function renderResultsTable(pageContext) {
                const resultsContainer = document.getElementById('results-container');
                let compStandings = [];
                let isOverallQualis = currentRound === 'qualis';
                let isFinals = currentRound === 'finals';
                let isIndividualQuali = !isOverallQualis && !isFinals;

                if (isFinals) {
                    compStandings = appData.fRankings.filter(s => (s.final || '').replace(/F$/, '') === currentComp);
                } else if (isOverallQualis) {
                    compStandings = appData.qStandings.filter(s => s.comp === currentComp);
                } else {
                    compStandings = appData.qRankings.filter(s => s.quali === currentRound);
                }
                
                if (isFinals) {
                    compStandings.sort((a,b) => parseInt(a.place) - parseInt(b.place));
                } else {
                    compStandings.sort((a, b) => parseFloat(b.quali_points) - parseFloat(a.quali_points));
                    
                    let lastScore = -1;
                    let currentRank = 0;
                    compStandings.forEach((s, i) => {
                        const score = parseFloat(s.quali_points);
                        if(score !== lastScore) {
                            currentRank = i + 1;
                            lastScore = score;
                        }
                        s.place = currentRank;
                    });
                }


                if (compStandings.length === 0) {
                    resultsContainer.innerHTML = `<div class="bg-gray-900 border border-gray-800 p-6 rounded-lg shadow-md text-center text-gray-400">No results available for this round.</div>`;
                    return;
                }
                
                const headers = isFinals
                    ? ['Place', 'Climber', 'Tops', 'Top Attempts', 'Zones', 'Zone Attempts']
                    : ['Place', 'Climber', 'Quali Points', 'Flashes', 'Tops', 'Zones'];

                let mobileHTML = '<div class="md:hidden space-y-2">';
                let desktopHTML = `<div class="hidden md:block bg-gray-900 border border-gray-800 p-4 sm:p-6 rounded-lg shadow-md"><table class="w-full border-collapse"><thead><tr class="border-b border-gray-800">${headers.map(h => `<th class="p-3 font-semibold text-sm text-left text-gray-400">${h}</th>`).join('')}</tr></thead><tbody>`;
                
                for (const standing of compStandings) {
                    const isQualisTop8 = !isFinals && parseInt(standing.place) <= 8;
                    const isFinalsTop3 = isFinals && parseInt(standing.place) <= 3;
                    let highlightClass = isQualisTop8 || isFinalsTop3 ? 'bg-sky-900/40' : '';
                    
                    const climberName = standing.climber || '-';
                    const climberButton = `<button data-climber-name="${climberName}" class="profile-link-btn text-left hover:text-blue-400 transition-colors duration-150">${climberName}</button>`;

                    let qualiPointsHTML;
                    if (isIndividualQuali) {
                        qualiPointsHTML = `<button data-climber-name="${climberName}" data-quali-name="${currentRound}" class="quali-detail-link font-bold text-blue-400 hover:text-blue-300">${standing.quali_points || '-'}</button>`;
                    } else if (isOverallQualis) {
                        qualiPointsHTML = `<button data-climber-name="${climberName}" data-comp-name="${currentComp}" class="quali-comp-detail-link font-bold text-blue-400 hover:text-blue-300">${standing.quali_points || '-'}</button>`;
                    } else {
                        qualiPointsHTML = `<span class="font-bold text-blue-400">${standing.quali_points || '-'}</span>`;
                    }


                    const qualiStatsHTML = `<div class="flex justify-between items-center text-center text-xs text-gray-400 mt-2 pt-2 border-t border-gray-700"><div>Tops <span class="block font-medium text-gray-200 text-sm">${standing.tops || '-'}</span></div><div>Zones <span class="block font-medium text-gray-200 text-sm">${standing.zones || '-'}</span></div><div>Flashes <span class="block font-medium text-gray-200 text-sm">${standing.flashes || '-'}</span></div></div>`;
                    const finalStatsHTML = `<div class="flex justify-around items-center text-center text-xs text-gray-400 mt-2 pt-2 border-t border-gray-700"><div>Tops <span class="block font-medium text-gray-200 text-sm">${standing.tops || '0'}(${standing.top_attempts || '0'})</span></div><div>Zones <span class="block font-medium text-gray-200 text-sm">${standing.zones || '0'}(${standing.zone_attempts || '0'})</span></div></div>`;
                    
                    mobileHTML += `<div class="rounded-lg p-3 shadow-md border border-gray-800 ${highlightClass || 'bg-gray-900'}"><div class="flex justify-between items-center"><div class="flex items-center space-x-3"><span class="font-bold text-base text-gray-200 w-6">${standing.place||'-'}</span><span class="font-medium text-gray-100 text-sm">${climberButton}</span></div>${!isFinals?`<div class="text-base">${qualiPointsHTML}</div>`:''}</div>${isFinals?finalStatsHTML:qualiStatsHTML}</div>`;
                    
                    const desktopRowContent = isFinals
                        ? `<td class="p-3 text-left">${standing.tops||'-'}</td><td class="p-3 text-left">${standing.top_attempts||'-'}</td><td class="p-3 text-left">${standing.zones||'-'}</td><td class="p-3 text-left">${standing.zone_attempts||'-'}</td>`
                        : `<td class="p-3 font-semibold text-blue-400 text-left">${qualiPointsHTML}</td><td class="p-3 text-left">${standing.flashes||'-'}</td><td class="p-3 text-left">${standing.tops||'-'}</td><td class="p-3 text-left">${standing.zones||'-'}</td>`;

                    desktopHTML += `<tr class="border-b border-gray-800 last:border-b-0 hover:bg-gray-800/50 ${highlightClass}"><td class="p-3 font-bold text-gray-100">${standing.place||'-'}</td><td class="p-3 font-medium text-gray-200">${climberButton}</td>${desktopRowContent}</tr>`;
                }

                mobileHTML += '</div>';
                desktopHTML += '</tbody></table></div>';
                resultsContainer.innerHTML = mobileHTML + desktopHTML;
                
                resultsContainer.querySelectorAll('.profile-link-btn').forEach(btn => {
                    btn.addEventListener('click', e => {
                        const climberName = e.currentTarget.dataset.climberName;
                        navigate('climberProfile', {
                            climberName: climberName,
                            from: { page: 'resultsComp', context: pageContext }
                        });
                    });
                });
                
                resultsContainer.querySelectorAll('.quali-detail-link').forEach(btn => {
                    btn.addEventListener('click', e => {
                        const { climberName, qualiName } = e.currentTarget.dataset;
                        navigate('qualiResultDetail', {
                            climberName,
                            qualiName,
                            from: { page: 'resultsComp', context: pageContext }
                        });
                    });
                });

                resultsContainer.querySelectorAll('.quali-comp-detail-link').forEach(btn => {
                    btn.addEventListener('click', e => {
                        const { climberName, compName } = e.currentTarget.dataset;
                        navigate('qualiCompResultDetail', {
                            climberName,
                            compName,
                            from: { page: 'resultsComp', context: pageContext }
                        });
                    });
                });
            }

            function renderQualiResultDetailPage(context) {
                const { climberName, qualiName, from } = context;

                headerContent.innerHTML = `
                    <div class="flex-1">
                        <button id="back-btn" class="flex items-center space-x-2 text-gray-400 hover:text-white font-medium"><i class="fas fa-arrow-left"></i><span class="hidden sm:inline">Back</span></button>
                    </div>
                    <div class="flex-1 text-center">
                        <h1 class="text-2xl font-bold text-gray-100">${climberName}</h1>
                        <h2 class="text-sm font-medium text-gray-400 mt-1 whitespace-nowrap">${qualiName}</h2>
                    </div>
                    <div class="flex-1 text-right">
                        <button id="go-home-btn" class="text-gray-400 hover:text-white"><i class="fas fa-home text-xl"></i></button>
                    </div>`;
                document.getElementById('back-btn').addEventListener('click', () => history.back()); // Use history.back()
                document.getElementById('go-home-btn').addEventListener('click', () => navigate('home'));

                const qualiBoulders = appData.qBoulders.filter(b => b.quali === qualiName);
                const climberResults = appData.qResults.find(r => r.climber === climberName && r.quali === qualiName);

                if (!climberResults || qualiBoulders.length === 0) {
                    mainContent.innerHTML = `<div class="bg-gray-900 border border-gray-800 p-6 rounded-lg shadow-md text-center text-gray-400">No detailed results available for this climber in this round.</div>`;
                    return;
                }

                const getResultStyling = (result) => {
                    switch(result) {
                        case 'Flash': return 'bg-yellow-500/10 border-yellow-500 text-yellow-400';
                        case 'Top': return 'bg-green-500/10 border-green-500 text-green-400';
                        case 'Zone': return 'bg-blue-500/10 border-blue-500 text-blue-400';
                        default: return 'bg-gray-700/20 border-gray-700 text-gray-400';
                    }
                }

                let resultsHTML = '<div class="space-y-3">';
                qualiBoulders.forEach(boulder => {
                    const result = climberResults[boulder.name.toLowerCase()] || 'Nothing';
                    const grade = boulder.grade || '';
                    const room = boulder.a || '';

                    resultsHTML += `
                        <div class="bg-gray-900 border border-gray-800 px-4 py-3 rounded-lg shadow-sm flex items-center justify-between space-x-4">
                            <div class="flex items-center space-x-4">
                                <div class="font-bold text-xl text-gray-200 w-8 text-center">${boulder.name}</div>
                                <div>
                                    <p class="font-semibold text-gray-200">${grade} ${boulder.color}</p>
                                    <p class="text-sm text-gray-400">${room}</p>
                                </div>
                            </div>
                            <div class="text-right">
                                <span class="font-bold text-sm px-3 py-1 rounded-full border ${getResultStyling(result)}">${result}</span>
                            </div>
                        </div>
                    `;
                });
                resultsHTML += '</div>';

                mainContent.innerHTML = resultsHTML;
            }

            function renderQualiCompResultDetailPage(context) {
                const { climberName, compName, from } = context;

                headerContent.innerHTML = `
                    <div class="flex-1">
                        <button id="back-btn" class="flex items-center space-x-2 text-gray-400 hover:text-white font-medium"><i class="fas fa-arrow-left"></i><span class="hidden sm:inline">Back</span></button>
                    </div>
                    <div class="flex-1 text-center">
                        <h1 class="text-2xl font-bold text-gray-100">${climberName}</h1>
                        <h2 class="text-sm font-medium text-gray-400 mt-1 whitespace-nowrap">${compName} Qualis</h2>
                    </div>
                    <div class="flex-1 text-right">
                        <button id="go-home-btn" class="text-gray-400 hover:text-white"><i class="fas fa-home text-xl"></i></button>
                    </div>`;
                document.getElementById('back-btn').addEventListener('click', () => history.back()); // Use history.back()
                document.getElementById('go-home-btn').addEventListener('click', () => navigate('home'));

                const getResultStyling = (result) => {
                    switch(result) {
                        case 'Flash': return 'bg-yellow-500/10 border-yellow-500 text-yellow-400';
                        case 'Top': return 'bg-green-500/10 border-green-500 text-green-400';
                        case 'Zone': return 'bg-blue-500/10 border-blue-500 text-blue-400';
                        default: return 'bg-gray-700/20 border-gray-700 text-gray-400';
                    }
                }

                const individualQualiRounds = [...new Set(appData.qRankings
                    .filter(r => r.quali && r.quali.startsWith(compName))
                    .map(r => r.quali)
                )].sort();

                if (individualQualiRounds.length === 0) {
                     mainContent.innerHTML = `<div class="bg-gray-900 border border-gray-800 p-6 rounded-lg shadow-md text-center text-gray-400">No qualification rounds found for this competition.</div>`;
                    return;
                }

                let finalHTML = '<div class="space-y-8">';

                individualQualiRounds.forEach(qualiName => {
                    const climberRanking = appData.qRankings.find(r => r.climber === climberName && r.quali === qualiName);
                    const qualiPoints = climberRanking ? climberRanking.quali_points : '-';
                    const roundTitle = qualiName.replace(compName, '');

                    finalHTML += `<div><div class="flex justify-between items-center border-b border-gray-700 pb-2 mb-3"><h3 class="text-xl font-bold text-gray-200">${roundTitle}</h3><span class="font-bold text-blue-400">${qualiPoints}</span></div>`;
                    
                    const qualiBoulders = appData.qBoulders.filter(b => b.quali === qualiName);
                    const climberResults = appData.qResults.find(r => r.climber === climberName && r.quali === qualiName);
                    
                    if (climberResults && qualiBoulders.length > 0) {
                        let resultsHTML = '<div class="space-y-3">';
                         qualiBoulders.forEach(boulder => {
                            const result = climberResults[boulder.name.toLowerCase()] || 'Nothing';
                            const grade = boulder.grade || '';
                            const room = boulder.a || '';

                            resultsHTML += `
                                <div class="bg-gray-900 border border-gray-800 px-4 py-3 rounded-lg shadow-sm flex items-center justify-between space-x-4">
                                    <div class="flex items-center space-x-4">
                                        <div class="font-bold text-xl text-gray-200 w-8 text-center">${boulder.name}</div>
                                        <div>
                                            <p class="font-semibold text-gray-200">${grade} ${boulder.color}</p>
                                            <p class="text-sm text-gray-400">${room}</p>
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        <span class="font-bold text-sm px-3 py-1 rounded-full border ${getResultStyling(result)}">${result}</span>
                                    </div>
                                </div>
                            `;
                        });
                        resultsHTML += '</div>';
                        finalHTML += resultsHTML;
                    } else {
                        finalHTML += `<div class="bg-gray-900 border border-gray-800 px-4 py-3 rounded-lg shadow-sm text-center text-gray-400">No results found for this round.</div>`;
                    }
                    finalHTML += `</div>`;
                });

                finalHTML += '</div>';
                mainContent.innerHTML = finalHTML;
            }


            function renderLeaderboardsPage() {
                headerContent.innerHTML = `
                    <div class="flex-1">
                        <button id="home-btn" class="flex items-center space-x-2 text-gray-400 hover:text-white font-medium"><i class="fas fa-arrow-left"></i><span class="hidden sm:inline">Back</span></button>
                    </div>
                    <h1 class="text-2xl font-bold text-gray-100 flex-1 text-center">Leaderboards</h1>
                    <div class="flex-1 text-right">
                        <button id="go-home-btn" class="text-gray-400 hover:text-white"><i class="fas fa-home text-xl"></i></button>
                    </div>`;
                document.getElementById('home-btn').addEventListener('click', () => history.back()); // Use history.back()
                document.getElementById('go-home-btn').addEventListener('click', () => navigate('home'));

                controlsContainer.classList.remove('hidden');
                controlsContainer.innerHTML = `<div class="flex justify-center">
                    <div id="leaderboard-selector" class="inline-flex bg-gray-800 p-1 rounded-md gap-1 overflow-x-auto no-scrollbar h-scroll">
                        <button data-leaderboard="qualis" class="leaderboard-btn whitespace-nowrap text-gray-300 font-semibold py-1 px-4 rounded-md">Qualis</button>
                        <button data-leaderboard="finals" class="leaderboard-btn whitespace-nowrap text-gray-300 font-semibold py-1 px-4 rounded-md">Finals</button>
                    </div>
                </div>`;
                
                mainContent.innerHTML = `<div id="leaderboard-container" class="w-full"></div>`;
                
                function setActiveLeaderboardButton() {
                    document.querySelectorAll('.leaderboard-btn').forEach(btn => {
                        const isSelected = btn.dataset.leaderboard === currentLeaderboard;
                        btn.classList.toggle('bg-blue-600', isSelected);
                        btn.classList.toggle('text-white', isSelected);
                        btn.classList.toggle('shadow-md', isSelected);
                        btn.classList.toggle('text-gray-300', !isSelected);
                    });
                }

                currentLeaderboard = 'qualis';
                setActiveLeaderboardButton();
                renderLeaderboardTable(currentLeaderboard);

                document.getElementById('leaderboard-selector').addEventListener('click', e => {
                    if (e.target.tagName === 'BUTTON' && e.target.dataset.leaderboard !== currentLeaderboard) {
                        currentLeaderboard = e.target.dataset.leaderboard;
                        // Replace state when changing tabs/leaderboards
                        history.replaceState({ page: 'leaderboards', context: { tab: currentLeaderboard } }, '', window.location.hash);
                        setActiveLeaderboardButton();
                        renderLeaderboardTable(currentLeaderboard);
                    }
                });
            }

            function renderLeaderboardTable(leaderboardType) {
                const container = document.getElementById('leaderboard-container');
                let data, headers, scoreKey;

                if (leaderboardType === 'qualis') {
                    data = [...appData.qLeaderboard];
                    headers = ['Circuit', 'Place', 'Climber', 'Quali Points', 'Tops', 'Zones', 'Flashes', 'Qualis'];
                    scoreKey = 'quali_points';
                    data.sort((a, b) => parseFloat(b[scoreKey]) - parseFloat(a[scoreKey]));
                } else {
                    data = [...appData.cStandings];
                    headers = ['Circuit', 'Place', 'Climber', 'Circuit Points', '1st', '2nd', '3rd', 'Finals', 'Flashes'];
                    scoreKey = 'circuit_points';
                    data.sort((a, b) => parseFloat(b[scoreKey]) - parseFloat(a[scoreKey]));
                }
                
                let lastScore = -1;
                let currentRank = 0;
                data.forEach((entry, i) => {
                    const score = parseFloat(entry[scoreKey]);
                    if(score !== lastScore) {
                        currentRank = i + 1;
                        lastScore = score;
                    }
                    entry.place = currentRank;
                });

                if (data.length === 0) {
                    container.innerHTML = `<div class="bg-gray-900 border border-gray-800 p-6 rounded-lg shadow-md text-center text-gray-400">No leaderboard data available.</div>`;
                    return;
                }

                let mobileHTML = '<div class="md:hidden space-y-2">';
                let desktopHTML = `<div class="hidden md:block bg-gray-900 border border-gray-800 p-4 sm:p-6 rounded-lg shadow-md"><table class="w-full border-collapse"><thead><tr class="border-b border-gray-800">${headers.map(h => `<th class="p-3 font-semibold text-sm text-left text-gray-400">${h}</th>`).join('')}</tr></thead><tbody>`;

                for (const entry of data) {
                    const climberName = entry.climber || '-';
                    const climberButton = `<button data-climber-name="${climberName}" class="profile-link-btn text-left hover:text-blue-400 transition-colors duration-150">${climberName}</button>`;

                    if (leaderboardType === 'qualis') {
                        mobileHTML += `<div class="rounded-lg p-3 shadow-md border border-gray-800 bg-gray-900">
                            <div class="flex justify-between items-center">
                                <div class="flex items-center space-x-3">
                                    <span class="font-bold text-base text-gray-200 w-6">${entry.place}</span>
                                    <span class="font-medium text-gray-100 text-sm">${climberButton}</span>
                                </div>
                                <div class="font-bold text-blue-400 text-base">${entry.quali_points}</div>
                            </div>
                            <div class="flex justify-between items-center text-center text-xs text-gray-400 mt-2 pt-2 border-t border-gray-700">
                                <div>Tops <span class="block font-medium text-gray-200 text-sm">${entry.tops}</span></div>
                                <div>Zones <span class="block font-medium text-gray-200 text-sm">${entry.zones}</span></div>
                                <div>Flashes <span class="block font-medium text-gray-200 text-sm">${entry.flashes}</span></div>
                                <div>Qualis <span class="block font-medium text-gray-200 text-sm">${entry.number_of_qualis}</span></div>
                            </div>
                        </div>`;
                        desktopHTML += `<tr class="border-b border-gray-800 last:border-b-0 hover:bg-gray-800/50">
                            <td class="p-3">${entry.circuit}</td>
                            <td class="p-3 font-bold text-gray-100">${entry.place}</td>
                            <td class="p-3 font-medium text-gray-200">${climberButton}</td>
                            <td class="p-3 font-semibold text-blue-400">${entry.quali_points}</td>
                            <td class="p-3">${entry.tops}</td>
                            <td class="p-3">${entry.zones}</td>
                            <td class="p-3">${entry.flashes}</td>
                            <td class="p-3">${entry.number_of_qualis}</td>
                        </tr>`;
                    } else { // Finals
                        mobileHTML += `<div class="rounded-lg p-3 shadow-md border border-gray-800 bg-gray-900">
                            <div class="flex justify-between items-center">
                                <div class="flex items-center space-x-3">
                                    <span class="font-bold text-base text-gray-200 w-6">${entry.place}</span>
                                    <span class="font-medium text-gray-100 text-sm">${climberButton}</span>
                                </div>
                                <div class="font-bold text-blue-400 text-base">${entry.circuit_points}</div>
                            </div>
                           <div class="flex flex-wrap justify-around items-center text-center text-xs text-gray-400 mt-2 pt-2 border-t border-gray-700 gap-x-4 gap-y-2">
                                <div>1st <span class="block font-medium text-gray-200 text-sm">${entry['1st']}</span></div>
                                <div>2nd <span class="block font-medium text-gray-200 text-sm">${entry['2nd']}</span></div>
                                <div>3rd <span class="block font-medium text-gray-200 text-sm">${entry['3rd']}</span></div>
                                <div>Finals <span class="block font-medium text-gray-200 text-sm">${entry.finals}</span></div>
                                <div>Flashes <span class="block font-medium text-gray-200 text-sm">${entry.flashes}</span></div>
                            </div>
                        </div>`;
                        desktopHTML += `<tr class="border-b border-gray-800 last:border-b-0 hover:bg-gray-800/50">
                            <td class="p-3">${entry.circuit}</td>
                            <td class="p-3 font-bold text-gray-100">${entry.place}</td>
                            <td class="p-3 font-medium text-gray-200">${climberButton}</td>
                            <td class="p-3 font-semibold text-blue-400">${entry.circuit_points}</td>
                            <td class="p-3">${entry['1st']}</td>
                            <td class="p-3">${entry['2nd']}</td>
                            <td class="p-3">${entry['3rd']}</td>
                            <td class="p-3">${entry.finals}</td>
                            <td class="p-3">${entry.flashes}</td>
                        </tr>`;
                    }
                }

                mobileHTML += '</div>';
                desktopHTML += '</tbody></table></div>';
                container.innerHTML = mobileHTML + desktopHTML;

                container.querySelectorAll('.profile-link-btn').forEach(btn => {
                    btn.addEventListener('click', e => {
                        const climberName = e.currentTarget.dataset.climberName;
                        navigate('climberProfile', {
                            climberName: climberName,
                            from: { page: 'leaderboards' }
                        });
                    });
                });
            }
            
            // --- NEW: Quali Results Submission Page ---
            function renderSubmitResultsPage() {
                headerContent.innerHTML = `
                    <div class="flex-1">
                        <button id="home-btn" class="flex items-center space-x-2 text-gray-400 hover:text-white font-medium"><i class="fas fa-arrow-left"></i><span class="hidden sm:inline">Back</span></button>
                    </div>
                    <h1 class="text-2xl font-bold text-gray-100 flex-1 text-center">Submit Quali Results</h1>
                    <div class="flex-1 text-right">
                        <button id="go-home-btn" class="text-gray-400 hover:text-white"><i class="fas fa-home text-xl"></i></button>
                    </div>`;
                document.getElementById('home-btn').addEventListener('click', () => history.back()); // Use history.back()
                document.getElementById('go-home-btn').addEventListener('click', () => navigate('home'));

                const climberOptions = [...appData.climbers].sort((a,b) => a.name.localeCompare(b.name)).map(c => `<option value="${c.name}">${c.name}</option>`).join('');

                mainContent.innerHTML = `
                    <div class="max-w-xl mx-auto">
                        <form id="quali-results-form" class="space-y-6">
                            
                            <!-- Step 1: Climber Selection -->
                            <div>
                                <label for="climber-select" class="block text-sm font-medium text-gray-300 mb-1">1. Select Your Name</label>
                                <select id="climber-select" name="climber" required class="w-full bg-gray-800 border border-gray-700 text-gray-200 rounded-lg p-3 focus:outline-none focus:border-blue-500">
                                    <option value="">-- Select Climber --</option>
                                    ${climberOptions}
                                </select>
                            </div>

                            <!-- Step 2: Quali Selection (hidden initially) -->
                            <div id="quali-select-container" class="hidden">
                                <label for="quali-select" class="block text-sm font-medium text-gray-300 mb-1">2. Select Live Quali Round</label>
                                <select id="quali-select" name="quali" required class="w-full bg-gray-800 border border-gray-700 text-gray-200 rounded-lg p-3 focus:outline-none focus:border-blue-500">
                                    <!-- Options will be populated dynamically -->
                                </select>
                            </div>

                            <!-- Step 3: Boulder Questions (hidden initially) -->
                            <div id="boulder-questions-container" class="hidden space-y-4">
                                <!-- Questions will be populated dynamically -->
                            </div>
                            
                            <div id="form-feedback" class="text-center h-6"></div>

                            <!-- Submit Button (hidden initially) -->
                            <div id="submit-btn-container" class="hidden">
                                 <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition duration-300">Submit Scores</button>
                            </div>

                        </form>
                    </div>
                `;

                const climberSelect = document.getElementById('climber-select');
                const qualiSelectContainer = document.getElementById('quali-select-container');
                const qualiSelect = document.getElementById('quali-select');
                const boulderQuestionsContainer = document.getElementById('boulder-questions-container');
                const submitBtnContainer = document.getElementById('submit-btn-container');
                const form = document.getElementById('quali-results-form');
                const feedback = document.getElementById('form-feedback');

                climberSelect.addEventListener('change', () => {
                    boulderQuestionsContainer.innerHTML = '';
                    boulderQuestionsContainer.classList.add('hidden');
                    submitBtnContainer.classList.add('hidden');
                    qualiSelect.value = '';
                    
                    if (climberSelect.value) {
                        const now = getLondonTime(); // Use London time
                        const liveQualis = appData.qualis.filter(quali => {
                            const startDate = new Date(quali.date);
                            const endDate = new Date(startDate.getTime() + (7 * 24 * 60 * 60 * 1000) + (12 * 60 * 60 * 1000));
                            return now >= startDate && now <= endDate;
                        }).sort((a, b) => new Date(b.date) - new Date(a.date));

                        let qualiOptionsHTML = '<option value="">-- Select Quali --</option>';
                        if(liveQualis.length > 0) {
                           liveQualis.forEach(q => {
                                qualiOptionsHTML += `<option value="${q.quali}">${q.quali}</option>`;
                           });
                        } else {
                            qualiOptionsHTML = '<option value="">-- No Live Qualis Available --</option>';
                        }
                        
                        qualiSelect.innerHTML = qualiOptionsHTML;
                        qualiSelectContainer.classList.remove('hidden');
                    } else {
                        qualiSelectContainer.classList.add('hidden');
                    }
                });

                qualiSelect.addEventListener('change', () => {
                    const selectedClimber = climberSelect.value;
                    const selectedQuali = qualiSelect.value;
                    boulderQuestionsContainer.innerHTML = '';
                    boulderQuestionsContainer.classList.add('hidden');
                    submitBtnContainer.classList.add('hidden');
                    
                    if (selectedQuali && selectedClimber) {
                        const boulders = appData.qBoulders.filter(b => b.quali === selectedQuali);
                        
                        const existingResult = appData.qResults.find(r => r.climber === selectedClimber && r.quali === selectedQuali);

                        if(boulders.length > 0) {
                            let questionsHTML = `<h3 class="text-lg font-semibold text-gray-200 pt-4 border-t border-gray-800">3. Log Your Results</h3>`;
                            boulders.forEach(boulder => {
                                const boulderNameLower = boulder.name.toLowerCase();
                                const boulderId = `${selectedQuali}-${boulder.name}`;
                                
                                const previousAnswer = existingResult ? existingResult[boulderNameLower] : null;

                                questionsHTML += `
                                    <div class="bg-gray-900/50 border border-gray-800 p-4 rounded-lg space-y-3">
                                        <div class="flex justify-between items-center">
                                            <p class="font-bold text-xl text-gray-200">${boulder.name}</p>
                                            <p class="font-normal text-gray-300">${boulder.grade} ${boulder.color} ${boulder.a}</p>
                                        </div>
                                        <div class="segmented-control">
                                            <input type="radio" id="${boulderId}-flash" name="results[${boulderNameLower}]" value="Flash" required ${previousAnswer === 'Flash' ? 'checked' : ''}>
                                            <label for="${boulderId}-flash" class="text-flash">Flash</label>
                                            <input type="radio" id="${boulderId}-top" name="results[${boulderNameLower}]" value="Top" required ${previousAnswer === 'Top' ? 'checked' : ''}>
                                            <label for="${boulderId}-top" class="text-top">Top</label>
                                            <input type="radio" id="${boulderId}-zone" name="results[${boulderNameLower}]" value="Zone" required ${previousAnswer === 'Zone' ? 'checked' : ''}>
                                            <label for="${boulderId}-zone" class="text-zone">Zone</label>
                                            <input type="radio" id="${boulderId}-nothing" name="results[${boulderNameLower}]" value="Nothing" required ${previousAnswer === 'Nothing' || !previousAnswer ? 'checked' : ''}>
                                            <label for="${boulderId}-nothing" class="text-nothing">Nothing</label>
                                        </div>
                                    </div>
                                `;
                            });
                            boulderQuestionsContainer.innerHTML = questionsHTML;
                            boulderQuestionsContainer.classList.remove('hidden');
                            submitBtnContainer.classList.remove('hidden');
                        }
                    }
                });

                form.addEventListener('submit', e => {
                    e.preventDefault();
                    feedback.innerHTML = '';
                    
                    const formData = new FormData(form);
                    const climber = formData.get('climber');
                    const quali = formData.get('quali');
                    const results = {};
                    let questionCount = boulderQuestionsContainer.querySelectorAll('.segmented-control').length;
                    let answeredCount = 0;

                    for (let [key, value] of formData.entries()) {
                       if (key.startsWith('results[')) {
                           const boulderName = key.match(/\[(.*?)\]/)[1];
                           results[boulderName] = value;
                           answeredCount++;
                       }
                    }

                    if (answeredCount < questionCount) {
                        feedback.innerHTML = `<p class="text-red-400">Please answer all boulder questions before submitting.</p>`;
                        return;
                    }

                    const payload = {
                        formType: 'submitQualiResults',
                        climber,
                        quali,
                        results
                    };

                    const submitButton = form.querySelector('button[type="submit"]');
                    submitButton.disabled = true;
                    submitButton.innerHTML = `<i class="fas fa-spinner fa-spin mr-2"></i>Submitting...`;

                    fetch(GOOGLE_APP_SCRIPT_URL, {
                        method: 'POST',
                        mode: 'no-cors',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(payload)
                    })
                    .then(() => {
                        feedback.innerHTML = `<p class="text-green-400">Success! Your results have been submitted and are being processed.</p>`;
                        form.reset();
                        qualiSelectContainer.classList.add('hidden');
                        boulderQuestionsContainer.classList.add('hidden');
                        submitBtnContainer.classList.add('hidden');
                    })
                    .catch(error => {
                        console.error('Error!', error);
                        feedback.innerHTML = `<p class="text-red-400">Error: Submission failed. Please check your connection.</p>`;
                    })
                    .finally(() => {
                        submitButton.disabled = false;
                        submitButton.innerHTML = `Submit Scores`;
                    });
                });
            }

            // --- Judges App Page ---
            function renderJudgesAppPage() {
                headerContent.innerHTML = `
                    <div class="flex-1">
                        <button id="back-btn" class="flex items-center space-x-2 text-gray-400 hover:text-white font-medium"><i class="fas fa-arrow-left"></i><span class="hidden sm:inline">Back</span></button>
                    </div>
                    <h1 class="text-2xl font-bold text-gray-100 flex-1 text-center">Judges App</h1>
                    <div class="flex-1 text-right">
                        <button id="go-home-btn" class="text-gray-400 hover:text-white"><i class="fas fa-home text-xl"></i></button>
                    </div>`;
                document.getElementById('back-btn').addEventListener('click', () => history.back()); // Use history.back()
                document.getElementById('go-home-btn').addEventListener('click', () => navigate('home'));

                mainContent.innerHTML = `
                    <div class="max-w-xl mx-auto">
                        <form id="judges-form" class="space-y-6">
                            
                            <!-- Step 1: Final Selection -->
                            <div>
                                <label for="final-select" class="block text-sm font-medium text-gray-300 mb-1">Select Final</label>
                                <select id="final-select" name="final" required class="w-full bg-gray-800 border border-gray-700 text-gray-200 rounded-lg p-3 focus:outline-none focus:border-blue-500">
                                    <!-- Options will be populated dynamically -->
                                </select>
                            </div>

                            <!-- Step 2: Climber Selection (hidden initially) -->
                            <div id="climber-select-container" class="hidden">
                                <label for="climber-select" class="block text-sm font-medium text-gray-300 mb-1">Select Climber</label>
                                <select id="climber-select" name="climber" required class="w-full bg-gray-800 border border-gray-700 text-gray-200 rounded-lg p-3 focus:outline-none focus:border-blue-500">
                                    <!-- Options will be populated dynamically -->
                                </select>
                            </div>

                            <!-- Step 3: Boulder Selection (hidden initially) -->
                            <div id="boulder-select-container" class="hidden">
                                <label for="boulder-select" class="block text-sm font-medium text-gray-300 mb-1">Select Boulder</label>
                                <select id="boulder-select" name="boulder" required class="w-full bg-gray-800 border border-gray-700 text-gray-200 rounded-lg p-3 focus:outline-none focus:border-blue-500">
                                    <!-- Options will be populated dynamically -->
                                </select>
                            </div>
                            
                            <!-- Next Button (hidden initially) -->
                            <div id="next-btn-container" class="hidden pt-2">
                                 <button type="submit" disabled class="w-full bg-gray-600 text-white font-bold py-3 px-4 rounded-lg transition">Next</button>
                            </div>

                        </form>
                    </div>
                `;

                const form = document.getElementById('judges-form');
                const finalSelect = document.getElementById('final-select');
                const climberSelectContainer = document.getElementById('climber-select-container');
                const climberSelect = document.getElementById('climber-select');
                const boulderSelectContainer = document.getElementById('boulder-select-container');
                const boulderSelect = document.getElementById('boulder-select');
                const nextBtnContainer = document.getElementById('next-btn-container');
                
                // Populate Finals
                const now = getLondonTime(); // Use London time
                const liveFinals = appData.finals.filter(final => {
                    const finalDate = new Date(final.date);
                    const endDate = new Date(finalDate.getTime() + (30 * 60 * 60 * 1000)); // End of day + 6 hours -> 30 hours total
                    return now >= finalDate && now <= endDate;
                });
                
                let finalsOptionsHTML = '<option value="">-- Select a Final --</option>';
                if (liveFinals.length > 0) {
                    liveFinals.forEach(f => {
                        finalsOptionsHTML += `<option value="${f.final}">${f.final}</option>`;
                    });
                } else {
                    finalsOptionsHTML = '<option value="">-- No Live Finals --</option>';
                }
                finalSelect.innerHTML = finalsOptionsHTML;

                // Event Listeners to show next step and enable button
                const checkCompletion = () => {
                    const nextButton = nextBtnContainer.querySelector('button');
                    if (finalSelect.value && climberSelect.value && boulderSelect.value) {
                        nextButton.disabled = false;
                        nextButton.classList.remove('bg-gray-600', 'cursor-not-allowed');
                        nextButton.classList.add('bg-blue-600', 'hover:bg-blue-700');
                    } else {
                        nextButton.disabled = true;
                        nextButton.classList.add('bg-gray-600', 'cursor-not-allowed');
                        nextButton.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                    }
                };
                
                finalSelect.addEventListener('change', () => {
                    climberSelectContainer.classList.add('hidden');
                    boulderSelectContainer.classList.add('hidden');
                    nextBtnContainer.classList.add('hidden');
                    climberSelect.value = '';
                    boulderSelect.value = '';


                    if (finalSelect.value) {
                        const climbersInFinal = appData.fClimbers
                            .filter(r => r.final === finalSelect.value)
                            .map(r => r.climber)
                            .sort();
                        let climberOptionsHTML = '<option value="">-- Select a Climber --</option>';
                        climbersInFinal.forEach(c => {
                             climberOptionsHTML += `<option value="${c}">${c}</option>`;
                        });
                        climberSelect.innerHTML = climberOptionsHTML;
                        climberSelectContainer.classList.remove('hidden');
                    }
                    checkCompletion();
                });

                climberSelect.addEventListener('change', () => {
                    boulderSelectContainer.classList.add('hidden');
                    nextBtnContainer.classList.add('hidden');
                    boulderSelect.value = '';


                    if (climberSelect.value) {
                        boulderSelect.innerHTML = `
                            <option value="">-- Select a Boulder --</option>
                            <option value="A">A</option>
                            <option value="B">B</option>
                            <option value="C">C</option>
                            <option value="D">D</option>
                        `;
                        boulderSelectContainer.classList.remove('hidden');
                    }
                     checkCompletion();
                });
                
                boulderSelect.addEventListener('change', () => {
                    if (boulderSelect.value) {
                        nextBtnContainer.classList.remove('hidden');
                    } else {
                        nextBtnContainer.classList.add('hidden');
                    }
                    checkCompletion();
                });

                form.addEventListener('submit', (e) => {
                    e.preventDefault();
                    const context = {
                        final: finalSelect.value,
                        climber: climberSelect.value,
                        boulder: boulderSelect.value
                    };
                    navigate('judgeBoulderPage', context);
                });
            }

            // --- REVISED: Judge Boulder Page ---
            function renderJudgeBoulderPage(context) {
                const { final, climber, boulder } = context;

                headerContent.innerHTML = `
                    <div class="flex-1">
                        <button id="back-btn" class="flex items-center space-x-2 text-gray-400 hover:text-white font-medium"><i class="fas fa-arrow-left"></i><span class="hidden sm:inline">Back</span></button>
                    </div>
                    <div class="flex-1 text-center">
                        <h1 class="text-2xl font-bold text-gray-100">${climber}</h1>
                        <h2 class="text-sm font-medium text-gray-400 mt-1 whitespace-nowrap">${boulder} &middot; ${final}</h2>
                    </div>
                    <div class="flex-1 text-right">
                        <button id="go-home-btn" class="text-gray-400 hover:text-white"><i class="fas fa-home text-xl"></i></button>
                    </div>`;
                document.getElementById('back-btn').addEventListener('click', () => history.back()); // Use history.back()
                document.getElementById('go-home-btn').addEventListener('click', () => navigate('home'));

                mainContent.innerHTML = `
                    <div class="max-w-md mx-auto space-y-4">
                        <!-- Timer Section -->
                        <div class="text-center">
                            <div id="timer-display" class="text-7xl font-mono font-bold text-white">04:00</div>
                            <div class="flex justify-center items-center space-x-4 mt-2">
                                <button id="play-btn" class="text-gray-300 hover:text-white text-3xl p-2"><i class="fas fa-play"></i></button>
                                <button id="pause-btn" class="text-gray-300 hover:text-white text-3xl p-2"><i class="fas fa-pause"></i></button>
                                <button id="reset-clock-btn" class="text-gray-300 hover:text-white text-3xl p-2"><i class="fas fa-undo"></i></button>
                            </div>
                        </div>

                        <!-- Scoreboard -->
                        <div class="grid grid-cols-3 gap-4 text-center items-center py-4">
                            <div>
                                <div class="text-sm text-green-400">TOP</div>
                                <div id="top-score" class="text-4xl font-bold text-green-400">0</div>
                            </div>
                            <div>
                                <div class="text-sm text-blue-400">ZONE</div>
                                <div id="zone-score" class="text-4xl font-bold text-blue-400">0</div>
                            </div>
                            <div>
                                <div class="text-sm text-gray-400">Attempts</div>
                                <div id="attempt-counter" class="text-4xl font-bold text-white">0</div>
                            </div>
                        </div>

                        <!-- Main Action Area & Footer Actions in one grid -->
                        <div class="grid grid-cols-2 gap-4 pt-4">
                            <button id="top-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold h-24 text-2xl rounded-lg transition flex items-center justify-center">TOP</button>
                            <button id="add-attempt-btn" class="w-full bg-gray-700 hover:bg-gray-600 text-white font-bold h-24 text-4xl rounded-lg transition flex items-center justify-center">+</button>
                            <button id="zone-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold h-24 text-2xl rounded-lg transition flex items-center justify-center">ZONE</button>
                            <button id="subtract-attempt-btn" class="w-full bg-gray-800 hover:bg-gray-700 text-white font-bold h-24 text-4xl rounded-lg transition flex items-center justify-center">-</button>
                             <button id="reset-btn" class="w-full bg-gray-700 hover:bg-gray-600 text-white font-bold py-4 rounded-lg transition">Reset</button>
                             <button id="submit-btn" class="w-full bg-blue-800 hover:bg-blue-700 text-white font-bold py-4 rounded-lg transition">Submit</button>
                        </div>
                        <div id="form-feedback" class="text-center h-6 py-2"></div>
                    </div>
                `;

                // --- State Management ---
                let timeRemaining = 240; // 4 minutes in seconds
                let timerInterval = null;
                let attemptCount = 0;
                let topAttempt = 0;
                let zoneAttempt = 0;

                // --- DOM Element References ---
                const timerDisplay = document.getElementById('timer-display');
                const playBtn = document.getElementById('play-btn');
                const pauseBtn = document.getElementById('pause-btn');
                const resetClockBtn = document.getElementById('reset-clock-btn');
                const attemptCounter = document.getElementById('attempt-counter');
                const topScore = document.getElementById('top-score');
                const zoneScore = document.getElementById('zone-score');
                const topBtn = document.getElementById('top-btn');
                const zoneBtn = document.getElementById('zone-btn');
                const addAttemptBtn = document.getElementById('add-attempt-btn');
                const subtractAttemptBtn = document.getElementById('subtract-attempt-btn');
                const resetBtn = document.getElementById('reset-btn'); // Renamed
                const submitBtn = document.getElementById('submit-btn');
                const feedbackDiv = document.getElementById('form-feedback');

                // --- Helper Functions ---
                const formatTime = (seconds) => {
                    const mins = Math.floor(seconds / 60).toString().padStart(2, '0');
                    const secs = (seconds % 60).toString().padStart(2, '0');
                    return `${mins}:${secs}`;
                };

                const updateUI = () => {
                    timerDisplay.textContent = formatTime(timeRemaining);
                    attemptCounter.textContent = attemptCount;
                    topScore.textContent = topAttempt;
                    zoneScore.textContent = zoneAttempt;
                    
                    topBtn.classList.toggle('opacity-50', topAttempt > 0);
                    zoneBtn.classList.toggle('opacity-50', zoneAttempt > 0);
                };
                
                const resetScoresAndAttempts = () => {
                    attemptCount = 0;
                    topAttempt = 0;
                    zoneAttempt = 0;
                    feedbackDiv.innerHTML = '';
                    updateUI();
                };

                // --- Timer Logic ---
                const startTimer = () => {
                    if (timerInterval || timeRemaining <= 0) return;
                    timerInterval = setInterval(() => {
                        timeRemaining--;
                        timerDisplay.textContent = formatTime(timeRemaining);
                        if (timeRemaining <= 0) {
                            clearInterval(timerInterval);
                            timerInterval = null;
                            timerDisplay.classList.add('text-red-500');
                        }
                    }, 1000);
                };

                playBtn.addEventListener('click', startTimer);
                pauseBtn.addEventListener('click', () => {
                    clearInterval(timerInterval);
                    timerInterval = null;
                });
                resetClockBtn.addEventListener('click', () => {
                    showConfirmationModal('Reset Timer?', 'This will only reset the clock.', () => {
                        clearInterval(timerInterval);
                        timerInterval = null;
                        timeRemaining = 240;
                        timerDisplay.classList.remove('text-red-500');
                        updateUI();
                    });
                });

                // --- Attempts Counter Logic ---
                addAttemptBtn.addEventListener('click', () => {
                    attemptCount++;
                    updateUI();
                });

                subtractAttemptBtn.addEventListener('click', () => {
                    if (attemptCount > 0) {
                        attemptCount--;
                        updateUI();
                    }
                });

                // --- Scoring Logic ---
                zoneBtn.addEventListener('click', () => {
                    if (zoneAttempt > 0) {
                        zoneAttempt = 0; 
                    } else {
                        zoneAttempt = attemptCount;
                    }
                    updateUI();
                });

                topBtn.addEventListener('click', () => {
                    if (topAttempt > 0) {
                        topAttempt = 0; 
                    } else {
                        topAttempt = attemptCount;
                        if (zoneAttempt === 0) {
                            zoneAttempt = attemptCount;
                        }
                    }
                    updateUI();
                });
                
                // --- Footer Actions ---
                resetBtn.addEventListener('click', () => {
                    showConfirmationModal('Reset Scores?', 'This will reset attempts, Top, and Zone scores. The timer will not be affected.', resetScoresAndAttempts);
                });

                submitBtn.addEventListener('click', () => {
                    const isTopAwarded = topAttempt > 0;
                    const isZoneAwarded = zoneAttempt > 0;
                    const resultSummary = `Submit: Top(${topAttempt}), Zone(${zoneAttempt})?`;

                    showConfirmationModal('Confirm Result', resultSummary, () => {
                        submitBtn.disabled = true;
                        submitBtn.innerHTML = `<i class="fas fa-spinner fa-spin mr-2"></i>Submitting...`;
                        
                        const payload = {
                            formType: 'submitFinalsResult',
                            final: final,
                            climber: climber,
                            boulder: boulder,
                            send: isTopAwarded ? 'Top' : (isZoneAwarded ? 'Zone' : 'Nothing'),
                            topAttempts: topAttempt,
                            zoneAttempts: zoneAttempt
                        };

                        fetch(GOOGLE_APP_SCRIPT_URL, {
                            method: 'POST',
                            mode: 'no-cors',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        })
                        .then(() => {
                            feedbackDiv.innerHTML = `<p class="text-green-400">Result for ${climber} on Boulder ${boulder} saved!</p>`;
                            setTimeout(() => history.back(), 1500); // Go back after successful submission
                        })
                        .catch(err => {
                            console.error('Error!', err);
                            feedbackDiv.innerHTML = `<p class="text-red-400">Error: Submission failed.</p>`;
                            submitBtn.disabled = false;
                            submitBtn.innerHTML = 'Submit';
                        });
                    });
                });
                
                // Initial UI setup
                updateUI();
            }


            // --- Manage Finals Page ---
            function renderManageFinalsPage() {
                 headerContent.innerHTML = `
                    <div class="flex-1">
                        <button id="back-btn" class="flex items-center space-x-2 text-gray-400 hover:text-white font-medium"><i class="fas fa-arrow-left"></i><span class="hidden sm:inline">Back</span></button>
                    </div>
                    <h1 class="text-2xl font-bold text-gray-100 flex-1 text-center">Manage Finals Roster</h1>
                    <div class="flex-1 text-right">
                        <button id="go-home-btn" class="text-gray-400 hover:text-white"><i class="fas fa-home text-xl"></i></button>
                    </div>`;
                 document.getElementById('back-btn').addEventListener('click', () => history.back()); // Use history.back()
                 document.getElementById('go-home-btn').addEventListener('click', () => navigate('home'));

                const today = getLondonTime(); // Use London time
                today.setHours(0, 0, 0, 0);
                const upcomingFinals = appData.finals.filter(f => new Date(f.date) >= today);
                const finalOptions = upcomingFinals.map(f => `<option value="${f.final}">${f.final}</option>`).join('');

                mainContent.innerHTML = `
                    <div class="max-w-xl mx-auto">
                        <form id="manage-finals-form" class="space-y-6">
                            <div>
                                <label for="final-select" class="block text-sm font-medium text-gray-300 mb-1">Select Upcoming Final</label>
                                <select id="final-select" name="final" required class="w-full bg-gray-800 border border-gray-700 text-gray-200 rounded-lg p-3 focus:outline-none focus:border-blue-500">
                                    <option value="">-- Select a Final --</option>
                                    ${finalOptions}
                                </select>
                            </div>

                            <div id="roster-management-container" class="hidden space-y-4">
                                <!-- Roster will be rendered here -->
                            </div>
                            
                            <div id="form-feedback" class="text-center h-6"></div>
                        </form>
                    </div>
                `;

                const finalSelect = document.getElementById('final-select');
                const rosterContainer = document.getElementById('roster-management-container');
                const feedback = document.getElementById('form-feedback');
                let currentFinalists = [];

                finalSelect.addEventListener('change', () => {
                    const selectedFinal = finalSelect.value;
                    rosterContainer.innerHTML = '';
                    if (!selectedFinal) return;

                    // Update the URL hash to reflect the selected final, allowing direct linking or refresh persistence.
                    // This replaces the current history entry to prevent an unnecessary back button press
                    // just to deselect the final.
                    const currentUrl = new URL(window.location.href);
                    currentUrl.hash = `#manageFinals-final=${selectedFinal}`;
                    history.replaceState({ page: 'manageFinals', context: { final: selectedFinal } }, '', currentUrl.hash);

                    let finalists = appData.fClimbers
                        .filter(fc => fc.final === selectedFinal)
                        .map(fc => fc.climber);
                    
                    if (finalists.length === 0) {
                        const compName = selectedFinal.replace(/F$/, '');
                        finalists = appData.qStandings
                            .filter(s => s.comp === compName)
                            .sort((a,b) => parseInt(a.place) - parseInt(b.place))
                            .slice(0, 8)
                            .map(s => s.climber);
                    }
                    currentFinalists = finalists;
                    renderRosterUI();
                });

                function renderRosterUI() {
                    let html = `<h3 class="text-lg font-semibold text-gray-200 pt-4 border-t border-gray-800">Current Finalists</h3>`;
                    
                    html += '<div id="finalists-list" class="space-y-2">';
                    currentFinalists.forEach(climber => {
                        html += `
                            <div class="flex justify-between items-center bg-gray-800 p-2 rounded-lg">
                                <span class="text-gray-200">${climber}</span>
                                <button type="button" data-climber="${climber}" class="remove-climber-btn text-red-500 hover:text-red-400 text-2xl font-bold">&times;</button>
                            </div>
                        `;
                    });
                    html += `</div>`;

                    const availableClimbers = appData.climbers
                        .map(c => c.name)
                        .filter(name => !currentFinalists.includes(name))
                        .sort();
                    
                    let climberOptions = availableClimbers.map(c => `<option value="${c}">${c}</option>`).join('');

                    html += `
                        <div class="pt-4 border-t border-gray-800">
                             <label for="add-climber-select" class="block text-sm font-medium text-gray-300 mb-1">Add Climber</label>
                             <div class="flex gap-2">
                                 <select id="add-climber-select" class="flex-grow bg-gray-800 border border-gray-700 text-gray-200 rounded-lg p-3">
                                     <option value="">-- Select a climber to add --</option>
                                     ${climberOptions}
                                 </select>
                                 <button type="button" id="add-climber-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold p-3 rounded-lg">Add</button>
                             </div>
                        </div>

                        <div class="pt-4">
                            <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg">Save Changes</button>
                        </div>
                    `;
                    rosterContainer.innerHTML = html;
                    rosterContainer.classList.remove('hidden');

                    document.querySelectorAll('.remove-climber-btn').forEach(btn => {
                        btn.addEventListener('click', e => {
                            const climberToRemove = e.target.dataset.climber;
                            currentFinalists = currentFinalists.filter(c => c !== climberToRemove);
                            renderRosterUI();
                        });
                    });

                    document.getElementById('add-climber-btn').addEventListener('click', () => {
                        const select = document.getElementById('add-climber-select');
                        const climberToAdd = select.value;
                        if (climberToAdd && !currentFinalists.includes(climberToAdd)) {
                            currentFinalists.push(climberToAdd);
                            currentFinalists.sort();
                            renderRosterUI();
                        }
                    });
                }

                document.getElementById('manage-finals-form').addEventListener('submit', e => {
                    e.preventDefault();

                    showConfirmationModal('Confirm Changes', 'Are you sure you want to save this finals roster?', () => {
                        feedback.innerHTML = '';

                        const payload = {
                            formType: 'manageFinalists',
                            final: finalSelect.value,
                            climbers: currentFinalists
                        };

                        const submitButton = e.target.querySelector('button[type="submit"]');
                        submitButton.disabled = true;
                        submitButton.innerHTML = `<i class="fas fa-spinner fa-spin mr-2"></i>Saving...`;

                        fetch(GOOGLE_APP_SCRIPT_URL, {
                            method: 'POST',
                            mode: 'no-cors',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        })
                        .then(() => {
                            feedback.innerHTML = `<p class="text-green-400">Finalist roster for ${finalSelect.value} has been updated!</p>`;
                        })
                        .catch(err => {
                             console.error('Error!', err);
                            feedback.innerHTML = `<p class="text-red-400">Error: Could not save roster. Check connection.</p>`;
                        })
                        .finally(() => {
                            submitButton.disabled = false;
                            submitButton.innerHTML = `Save Changes`;
                        });
                    });
                });
            }


            async function init() {
                indicator.innerHTML = `<i class="fas fa-spinner fa-spin text-4xl text-gray-400"></i><p class="mt-4 text-lg font-medium text-gray-300">Loading All Mockomps Data...</p>`;
                
                try {
                    const dataPromises = Object.entries(GOOGLE_SHEET_URLS).map(([key, url]) => {
                        if (key === 'climberStats') {
                            return fetchAndParseClimberStats(url).then(data => [key, data]);
                        }
                        return fetchAndParseSheet(url).then(data => [key, data]);
                    });

                    const dataEntries = await Promise.all(dataPromises);
                    appData = Object.fromEntries(dataEntries);
                    
                    indicator.remove(); 
                    
                    stickyContainer.classList.remove('hidden');
                    mainContent.classList.remove('hidden');

                    // Initial page load: check URL hash for page and context, otherwise default to 'home'
                    const initialHash = window.location.hash.substring(1); // Remove '#'
                    let initialPage = 'home';
                    let initialContext = null;

                    if (initialHash) {
                        // Very basic hash parsing. Could be more robust for complex contexts.
                        // Example: #page-name or #page-name-param1=value1&param2=value2
                        const parts = initialHash.split('-');
                        initialPage = parts[0];
                        if (parts.length > 1) {
                            // Attempt to reconstruct context for specific pages from hash
                            // This part might need further refinement based on your page logic
                            if (initialPage === 'climberProfile' && parts[1]) {
                                initialContext = { climberName: parts[1].replace(/_/g, ' '), from: { page: 'home' } };
                                if (parts[2] === 'tab' && parts[3]) {
                                    initialContext.tab = parts[3];
                                }
                            } else if (initialPage === 'resultsComp' && parts[1]) {
                                initialContext = { comp: parts[1].replace(/_/g, ' '), from: { page: 'home' } };
                                if (parts[2] === 'round' && parts[3]) {
                                    initialContext.round = parts[3].replace(/_/g, ' ');
                                }
                            } else if (initialPage === 'judgeBoulderPage' && parts[1] && parts[2] && parts[3]) {
                                initialContext = { final: parts[1], climber: parts[2].replace(/_/g, ' '), boulder: parts[3] };
                            } else if (initialPage === 'manageFinals' && parts[1] && parts[1].startsWith('final=')) {
                                initialContext = { final: parts[1].substring('final='.length) };
                                // Automatically select the final if navigated directly via hash
                                // This requires the select element to be present in the DOM immediately.
                                // If the select is dynamically rendered, this might need a slight adjustment
                                // (e.g., call populate options first, then set value).
                                // For now, assuming it's available.
                                const finalSelectElement = document.getElementById('final-select');
                                if (finalSelectElement) {
                                    finalSelectElement.value = initialContext.final;
                                }
                            }
                        }
                    }

                    // Use replaceState for the very first load to avoid an extra history entry
                    history.replaceState({ page: initialPage, context: initialContext, scrollY: 0 }, '', `#${initialPage}`);
                    renderPageContent(initialPage, initialContext); // Render the initial page

                } catch (error) {
                    console.error("Initialization Error:", error);
                    indicator.innerHTML = `<div class="p-10 bg-red-900/50 border border-red-500/30 text-red-300 rounded-lg"><h2 class="font-bold text-xl text-red-200">Error Loading Data</h2><p class="mt-2 text-sm">${error.message}</p><p class="mt-2 text-xs">Please check the browser console for more details, ensure all Google Sheet GIDs are correct, and that sheets are published.</p></div>`;
                }
            }

            init();
        });
    </script>
</body>
</html>